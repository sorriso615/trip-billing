<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripSplit 2026 å°ˆæ¥­äº’å‹•è¨˜å¸³ç³»çµ± (äºæ´²è²¨å¹£å®‰å…¨ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { font-size: 16px; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; color: #334155; }
        input, select, button, p, span, div { font-size: 16px; }
        .amt-text { font-size: 16px !important; }
        
        .currency-active { background-color: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        @media (min-width: 1024px) {
            .app-container { display: grid; grid-template-columns: 450px 1fr; gap: 24px; }
            .sticky-panel { position: sticky; top: 20px; height: fit-content; }
            header.sticky { position: sticky; top: 0; z-index: 50; }
            #main-tabs { flex-direction: row; }
        }

        @media (max-width: 1024px) {
            header.sticky { position: relative !important; top: auto !important; margin-bottom: 10px; padding: 12px !important; }
            #public-stats-zone { 
                display: grid !important; grid-template-columns: repeat(3, 1fr) !important; 
                gap: 5px !important; border-top: 1px solid #e2e8f0; padding-top: 10px !important; margin-top: 10px;
            }
            #public-stats-zone div { border-left: none !important; }
            #public-stats-zone p:first-child { font-size: 12px !important; color: #94a3b8; }
            #public-stats-zone p:last-child { font-size: 16px !important; }
            #main-tabs { flex-direction: column; gap: 8px; }
            #main-tabs button { width: 100%; text-align: center; padding: 12px; }
        }
    </style>
</head>
<body class="p-4 lg:p-8">

    <div id="loading-mask" class="fixed inset-0 bg-white z-[60] flex items-center justify-center hidden">
        <div class="text-slate-500 font-bold text-xl animate-pulse">è³‡æ–™åŒæ­¥ä¸­...</div>
    </div>

    <div id="login-page" class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl mt-10">
        <h1 class="text-3xl font-black text-center text-slate-800 mb-2">TripSplit 2026</h1>
        <p class="text-center text-slate-400 mb-8">å¤šäººæ—…éŠé›²ç«¯è¨˜å¸³</p>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-slate-500 mb-1">ğŸ“˜ å¸³ç°¿ä»£ç¢¼</label>
                <input type="text" id="login-id" placeholder="ä¾‹å¦‚: Tokyo2026" class="w-full p-3 border rounded-xl bg-slate-50 focus:ring-2 ring-blue-400 outline-none transition">
            </div>
            <button onclick="checkBookExist()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-slate-900 transition active:scale-95">é€²å…¥å¸³ç°¿</button>
            
            <div id="identity-zone" class="hidden animate-fade-in mt-6 pt-6 border-t border-dashed border-slate-200">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <label class="block text-sm font-bold text-slate-600 mb-2">ğŸ‘¤ é¸æ“‡èº«åˆ†</label>
                    <select id="user-select" class="w-full p-3 border rounded-xl bg-white mb-3"></select>
                    <input type="password" id="login-pass" placeholder="ğŸ”‘ è¼¸å…¥å¸³ç°¿å¯†ç¢¼" class="w-full p-3 border rounded-xl mb-3">
                    <div id="admin-pass-input-box" class="hidden">
                        <input type="password" id="admin-login-pass" placeholder="ğŸ›¡ï¸ ç®¡ç†å“¡å¯†ç¢¼" class="w-full p-3 border rounded-xl border-orange-200 bg-orange-50 mb-3 text-orange-800">
                    </div>
                    <label class="flex items-center gap-2 mb-3 text-sm text-slate-500"><input type="checkbox" id="auto-login-check" checked> ä¿æŒç™»å…¥</label>
                    <button onclick="lockIdentityAndEnter()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow hover:bg-blue-700 transition">ç¢ºèªç™»å…¥</button>
                </div>
            </div>

            <div id="new-book-zone" class="hidden animate-fade-in mt-6 pt-6 border-t border-dashed border-slate-200">
                <h3 class="font-black text-lg mb-3 text-slate-700">ğŸ†• å»ºç«‹æ–°å¸³ç°¿</h3>
                <div class="space-y-3">
                    <input type="password" id="secure-code" placeholder="è¨­å®šå¸³ç°¿å¯†ç¢¼" class="w-full p-3 border rounded-xl">
                    <div class="flex gap-2">
                        <select id="new-currency-select" onchange="document.getElementById('new-foreign-name').value=this.value" class="w-1/3 p-3 border rounded-xl bg-slate-50 text-sm font-bold text-center"></select>
                        <input type="text" id="new-foreign-name" placeholder="è‡ªè¡Œè¼¸å…¥ (å¦‚: JPY)" class="w-2/3 p-3 border rounded-xl">
                    </div>
                    <textarea id="new-members" placeholder="æˆå“¡åå–® (é€—è™Ÿåˆ†éš”ï¼Œé¦–ä½ç‚ºç®¡ç†å“¡)" class="w-full p-3 border rounded-xl h-24"></textarea>
                    <button onclick="createNewBook()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition">ç«‹å³é–‹æˆ¶</button>
                </div>
            </div>
        </div>
    </div>

    <div id="main-content" class="hidden max-w-6xl mx-auto">
        <header class="bg-white p-4 lg:p-6 rounded-2xl shadow-lg mb-6 sticky top-0 z-50 transition-all duration-300">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h1 class="text-2xl font-black text-slate-800 tracking-tight flex items-center gap-2">
                    <span id="display-user" class="text-base font-normal bg-slate-100 px-2 py-1 rounded-lg"></span>
                    <span id="seal-badge" class="hidden bg-red-100 text-red-600 text-xs px-2 py-1 rounded border border-red-200">ğŸ”’ å·²å°å­˜</span>
                </h1>
                <button onclick="logout()" class="text-sm text-slate-400 hover:text-red-500 font-bold px-3 py-1 border rounded-lg hover:bg-slate-50 transition">ç™»å‡º</button>
            </div>
            <div class="flex flex-col lg:flex-row gap-4 lg:items-center">
                <div class="flex gap-2 w-full lg:w-auto">
                    <button id="btn-twd" onclick="switchCurrency('TWD')" class="flex-1 lg:flex-none px-6 py-3 rounded-xl font-bold border-2 transition-all bg-white text-slate-400 hover:bg-slate-50">ğŸ‡¹ğŸ‡¼ å°å¹£</button>
                    <button id="btn-sub" onclick="switchCurrency('SUB')" class="flex-1 lg:flex-none px-6 py-3 rounded-xl font-bold border-2 transition-all currency-active">å¤–å¹£</button>
                </div>
                <div id="public-stats-zone" class="grid grid-cols-1 lg:grid-cols-3 gap-2 flex-1 text-center bg-slate-50 p-2 rounded-xl border border-slate-100">
                    <div><p class="text-xs text-slate-400">é ç¹³ç¸½é¡</p><p id="sum-income" class="amt-text font-black text-green-600">0</p></div>
                    <div class="border-l border-slate-200 hidden lg:block"></div>
                    <div><p class="text-xs text-slate-400">æ”¯å‡ºç¸½é¡</p><p id="sum-expense" class="amt-text font-black text-red-600">0</p></div>
                    <div class="border-l border-slate-200 hidden lg:block"></div>
                    <div><p class="text-xs text-slate-400">å…¬å¸³é¤˜é¡</p><p id="sum-balance" class="amt-text font-black text-blue-600">0</p></div>
                </div>
            </div>
        </header>

        <div class="app-container">
            <aside class="sticky-panel space-y-4">
                <details id="add-panel" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <summary class="p-4 font-bold text-lg text-slate-700 cursor-pointer flex justify-between items-center bg-slate-50 hover:bg-slate-100 transition">
                        <span id="form-header-text">ğŸ“ æ–°å¢æ”¯å‡º/æ”¶å…¥</span><span class="text-slate-400">â–¼</span>
                    </summary>
                    <div class="p-6 pt-2 space-y-4 border-t border-slate-100">
                        <input type="hidden" id="edit-id" value="">
                        <input type="date" id="exp-date" class="w-full p-3 bg-slate-50 border-0 rounded-xl font-bold text-slate-600">
                        <div class="grid grid-cols-3 gap-2">
                            <select id="exp-cat" class="p-3 bg-slate-50 rounded-xl font-bold text-center">
                                <option value="ğŸ½ï¸ é¤é£²">ğŸ½ï¸ é¤é£²</option><option value="ğŸš— äº¤é€š">ğŸš— äº¤é€š</option><option value="ğŸ  ä½å®¿">ğŸ  ä½å®¿</option>
                                <option value="ğŸ« ç¥¨åˆ¸">ğŸ« ç¥¨åˆ¸</option><option value="ğŸ›ï¸ è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="ğŸ¹ é£²æ–™">ğŸ¹ é£²æ–™</option><option value="â¤ï¸ å…¶ä»–">â¤ï¸ å…¶ä»–</option>
                            </select>
                            <input type="text" id="exp-title" placeholder="é …ç›®åç¨±" class="col-span-2 p-3 bg-slate-50 rounded-xl font-bold border-0 ring-1 ring-slate-200">
                        </div>
                        <input type="number" id="exp-amt" placeholder="é‡‘é¡" class="w-full p-4 bg-slate-50 rounded-xl font-black text-xl text-blue-600 text-center placeholder-slate-300 border-0 ring-1 ring-slate-200">
                        
                        <div class="p-3 bg-slate-50 rounded-xl border border-slate-200">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-slate-500">æ”¯ä»˜æ–¹å¼</label>
                                <select id="exp-path" onchange="togglePayerSelection()" class="text-sm p-1 rounded bg-white border-0 font-bold text-slate-700 ring-1 ring-slate-200">
                                    <option id="opt-public-pay" value="public">å…¬å¸³é¤˜é¡æ”¯ä»˜</option>
                                    <option value="advance">å€‹äººä»£å¢Š (ç§å¸³)</option>
                                    <option value="personal">å€‹äººç¨è³‡ (ä¸è¨˜å…¬å¸³)</option>
                                </select>
                            </div>
                            <div id="payer-select-div" class="hidden mb-3 animate-fade-in">
                                <label class="text-xs font-bold text-slate-500">èª°å…ˆå¢ŠéŒ¢ï¼Ÿ</label>
                                <select id="payer-member" class="w-full p-2 mt-1 rounded border text-sm font-bold bg-white"></select>
                            </div>
                            <div id="splitters-block">
                                <label class="text-xs font-bold text-slate-500 mb-2 block">åˆ†æ”¤æˆå“¡ (é è¨­å…¨å“¡)</label>
                                <div id="splitters-grid" class="grid grid-cols-2 gap-2 text-sm"></div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button id="btn-submit" onclick="handleRecordSubmit()" class="flex-1 bg-slate-800 text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-slate-900 transition active:scale-95">ç¢ºèªè¨˜å¸³</button>
                            <button id="btn-cancel-edit" onclick="resetForm()" class="hidden w-20 bg-gray-200 text-gray-500 rounded-xl font-bold">å–æ¶ˆ</button>
                        </div>
                    </div>
                </details>
            </aside>

            <main>
                <div id="main-tabs" class="flex mb-6 overflow-x-hidden">
                    <button onclick="switchTab('pub', this)" class="px-5 py-2 rounded-xl font-bold bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 transition shadow-sm">ğŸ“Š å…¬å¸³æ˜ç´°</button>
                    <button onclick="switchTab('adv', this)" class="px-5 py-2 rounded-xl font-bold bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 transition shadow-sm">âš¡ å€‹äººä»£å¢Š</button>
                    <button onclick="switchTab('pvt', this)" class="px-5 py-2 rounded-xl font-bold bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 transition shadow-sm">ğŸ‘¤ å€‹äººæ”¯å‡º</button>
                    <button onclick="switchTab('my', this)" class="px-5 py-2 rounded-xl font-bold bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 transition shadow-sm">ğŸ“’ å€‹äººæµæ°´å¸³</button>
                    <button onclick="switchTab('stats', this)" class="px-5 py-2 rounded-xl font-bold bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 transition shadow-sm">ğŸ“Š çµ±è¨ˆåˆ†æ</button>
                    <button onclick="switchTab('final', this)" class="px-5 py-2 rounded-xl font-bold bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 transition shadow-sm">ğŸ æœ€çµ‚çµç®—</button>
                    <button id="tab-admin-btn" onclick="switchTab('admin', this)" class="hidden px-5 py-2 rounded-xl font-bold bg-slate-800 text-white border border-slate-800 shadow-md">ğŸ›¡ï¸ ç®¡ç†å“¡å°ˆå€</button>
                </div>

                <div id="panel-pub" class="hidden space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200">
                        <div class="bg-slate-50 p-3 font-bold text-slate-700 flex justify-between items-center"><span>ğŸ“¥ å…¬å¸³æ”¶å…¥</span><button onclick="toggleSort()" class="text-xs border px-2 py-1 rounded bg-white">ğŸ”ƒ æ’åº</button></div>
                        <div id="income-list"></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200">
                        <div class="bg-slate-50 p-3 font-bold text-slate-700 flex justify-between items-center"><span>ğŸ“¤ å…¬å¸³æ”¯å‡º</span><button onclick="toggleSort()" class="text-xs border px-2 py-1 rounded bg-white">ğŸ”ƒ æ’åº</button></div>
                        <div id="public-exp-list"></div>
                    </div>
                </div>

                <div id="panel-adv" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200">
                    <div class="bg-slate-50 p-3 font-bold text-slate-700 flex justify-between items-center"><span>âš¡ å€‹äººä»£å¢Š</span><button onclick="toggleSort()" class="text-xs border px-2 py-1 rounded bg-white">ğŸ”ƒ æ’åº</button></div>
                    <div id="adv-list"></div>
                </div>

                <div id="panel-pvt" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200">
                    <div class="bg-slate-50 p-3 font-bold text-slate-700 flex justify-between items-center"><span>ğŸ‘¤ å€‹äººç¨è³‡æ”¯å‡º</span><button onclick="toggleSort()" class="text-xs border px-2 py-1 rounded bg-white">ğŸ”ƒ æ’åº</button></div>
                    <div id="pvt-list"></div>
                </div>

                <div id="panel-my" class="hidden bg-white rounded-2xl shadow-sm p-4 border border-slate-200">
                    <div class="flex justify-end mb-2"><button onclick="toggleSort()" class="text-xs border px-2 py-1 rounded bg-slate-50">ğŸ”ƒ æ’åº</button></div>
                    <div id="ledger-content" class="space-y-6"></div>
                </div>

                <div id="panel-stats" class="hidden bg-white rounded-2xl shadow-sm p-6 border border-slate-200">
                    <h3 class="font-black text-xl text-slate-800 mb-4">ğŸ“Š å€‹äººæ”¯å‡ºçµ±è¨ˆ</h3>
                    <div class="mb-6 text-center"><p class="text-slate-500 text-sm">æ‚¨çš„ç¸½æ”¯å‡º (å«åˆ†æ”¤)</p><p id="stats-total" class="text-3xl font-black text-blue-600 mt-1">0</p></div>
                    <div class="relative h-64 w-full"><canvas id="expenseChart"></canvas></div>
                </div>

                <div id="panel-final" class="hidden bg-white rounded-2xl shadow-sm p-6 border border-slate-200">
                    <div class="flex gap-2 mb-4">
                        <button id="btn-settle-twd" onclick="switchSettleMode('TWD')" class="flex-1 py-2 bg-slate-100 rounded text-sm font-bold text-slate-600">å°å¹£</button>
                        <button id="btn-settle-sub" onclick="switchSettleMode('SUB')" class="flex-1 py-2 bg-slate-100 rounded text-sm font-bold text-slate-600">å¤–å¹£</button>
                        <button id="btn-settle-mix" onclick="switchSettleMode('MIX')" class="flex-1 py-2 bg-slate-100 rounded text-sm font-bold text-slate-600">æ··åˆ</button>
                    </div>
                    <div id="settle-content" class="space-y-6"></div>
                </div>

                <div id="panel-admin" class="hidden bg-white rounded-2xl shadow-sm p-6 border border-slate-200 space-y-8">
                    <h3 class="font-black text-xl text-slate-800 border-b pb-2">ğŸ›¡ï¸ ç®¡ç†å“¡å¾Œå°</h3>
                    <div>
                        <h4 class="font-bold text-green-700 mb-3">ğŸ’° å…¬å¸³é ç¹³ (å…¥é‡‘)</h4>
                        <div class="flex gap-2">
                            <input type="date" id="fund-date" class="w-1/3 p-2 rounded border">
                            <input type="number" id="fund-amt" placeholder="é‡‘é¡" class="w-1/3 p-2 rounded border font-bold text-center">
                            <button onclick="addFundRecord()" class="w-1/3 bg-green-600 text-white rounded font-bold shadow">å…¥å¸³</button>
                        </div>
                    </div>
                    <div class="space-y-3 text-sm">
                        <h4 class="font-bold text-slate-700">âš™ï¸ ç³»çµ±è¨­å®š</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label>æˆå“¡åå–® (é€—è™Ÿåˆ†éš”)</label><input type="text" id="set-members" class="w-full p-2 rounded border mt-1"></div>
                            <div>
                                <label>å¤–å¹£è¨­å®š</label>
                                <div class="flex gap-1 mt-1">
                                    <select id="set-currency-select" onchange="document.getElementById('set-sub-name').value=this.value" class="w-1/3 p-2 border rounded bg-slate-50"></select>
                                    <input type="text" id="set-sub-name" class="w-2/3 p-2 rounded border">
                                </div>
                            </div>
                            <div><label>åŒ¯ç‡</label><input type="number" id="set-rate" class="w-full p-2 rounded border mt-1" step="0.001"></div>
                            <div><label>ç®¡ç†å“¡</label><select id="set-manager" class="w-full p-2 rounded border mt-1"></select></div>
                            <div><label>å¸³ç°¿å¯†ç¢¼</label><input type="text" id="set-book-pass" class="w-full p-2 rounded border mt-1"></div>
                            <div><label>ç®¡ç†å“¡å¯†ç¢¼</label><input type="text" id="set-admin-pass" class="w-full p-2 rounded border mt-1"></div>
                        </div>
                        <button onclick="updateSettings()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mt-2">å„²å­˜è¨­å®š</button>
                    </div>
                    <div class="border-t pt-4 space-y-3">
                        <button onclick="downloadData()" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-bold">ğŸ“¥ ä¸‹è¼‰å¸³ç°¿å‚™ä»½ (JSON)</button>
                        <button onclick="toggleSeal()" id="btn-seal" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold">ğŸ”’ å°å­˜å¸³ç°¿ (å”¯è®€)</button>
                        <button onclick="deleteAllData()" class="w-full bg-white text-red-500 border border-red-200 py-2 rounded font-bold hover:bg-red-50">ğŸ§¨ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Firebase Configuration (å®‰å…¨æ€§è­¦å‘Šï¼šè«‹è‡³ Firebase Console è¨­å®šç¶²åŸŸé™åˆ¶)
        const firebaseConfig = {
            apiKey: "AIzaSyCzM7T1UWb1MxsE5O1w_lsoMp4sC-wT-v0",
            authDomain: "project-2641836624074325409.firebaseapp.com",
            databaseURL: "https://project-2641836624074325409-default-rtdb.firebaseio.com",
            projectId: "project-2641836624074325409",
            storageBucket: "project-2641836624074325409.firebasestorage.app",
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();

        let db = { items: [], members: [] };
        let currentUser = "";
        let currentCur = "SUB";
        let sortDesc = true;
        let SMode = 'MIX';
        let chartInstance = null;

        // è²¨å¹£å®šç¾©
        const currencies = [
            {code:"JPY", name:"ğŸ‡¯ğŸ‡µ æ—¥åœ“"}, {code:"USD", name:"ğŸ‡ºğŸ‡¸ ç¾é‡‘"}, {code:"EUR", name:"ğŸ‡ªğŸ‡º æ­å…ƒ"},
            {code:"KRW", name:"ğŸ‡°ğŸ‡· éŸ“å…ƒ"}, {code:"CNY", name:"ğŸ‡¨ğŸ‡³ äººæ°‘å¹£"}, {code:"THB", name:"ğŸ‡¹ğŸ‡­ æ³°éŠ–"},
            {code:"MYR", name:"ğŸ‡²ğŸ‡¾ é¦¬å¹£"}, {code:"SGD", name:"ğŸ‡¸ğŸ‡¬ æ–°å¹£"}, {code:"PHP", name:"ğŸ‡µğŸ‡­ æŠ«ç´¢"},
            {code:"IDR", name:"ğŸ‡®ğŸ‡© å°å°¼ç›¾"}, {code:"VND", name:"ğŸ‡»ğŸ‡³ è¶Šå—ç›¾"}, {code:"GBP", name:"ğŸ‡¬ğŸ‡§ è‹±éŠ"},
            {code:"AUD", name:"ğŸ‡¦ğŸ‡º æ¾³å¹£"}
        ];

        window.onload = function() {
            populateCurrencySelects();
            const savedBookId = localStorage.getItem('trip_book_id_memory');
            if(savedBookId) document.getElementById('login-id').value = savedBookId;
            const savedId = localStorage.getItem('trip_auto_id');
            const savedUser = localStorage.getItem('trip_auto_user');
            const savedPass = localStorage.getItem('trip_auto_pass');
            if (savedId && savedUser && savedPass) {
                document.getElementById('loading-mask').classList.remove('hidden');
                rdb.ref('books/' + savedId).once('value', (s) => {
                    const data = s.val();
                    if (data && data.pass === savedPass) { db = data; if(!db.items)db.items=[]; currentUser = savedUser; initApp(); }
                    document.getElementById('loading-mask').classList.add('hidden');
                });
            }
        };

        function populateCurrencySelects() {
            const opts = `<option value="">é¸</option>` + currencies.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
            document.getElementById('new-currency-select').innerHTML = opts;
            document.getElementById('set-currency-select').innerHTML = opts;
        }

        function checkBookExist() {
            const id = document.getElementById('login-id').value.trim();
            if (!id) return alert("è«‹è¼¸å…¥ID");
            localStorage.setItem('trip_book_id_memory', id);
            rdb.ref('books/' + id).once('value', (s) => {
                const data = s.val();
                if (data) {
                    db = data; if(!db.items)db.items=[];
                    renderUserSelect();
                    document.getElementById('new-book-zone').classList.add('hidden');
                    document.getElementById('identity-zone').classList.remove('hidden');
                } else {
                    document.getElementById('new-book-zone').classList.remove('hidden');
                    document.getElementById('identity-zone').classList.add('hidden');
                    alert("å¸³ç°¿ä¸å­˜åœ¨ï¼Œè«‹å»ºç«‹");
                }
            });
        }

        function createNewBook() {
            const id = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('secure-code').value.trim();
            const members = document.getElementById('new-members').value.split(/[,ï¼Œ]/).map(m=>m.trim()).filter(m=>m);
            const subName = document.getElementById('new-foreign-name').value.trim() || "å¤–å¹£";
            if (!id || !pass || members.length < 1) return alert("è³‡æ–™ä¸å…¨");
            db = { id, pass, members, subName, manager: members[0], adminPass: "1234", rate: 0.22, items: [], isSealed: false };
            save(); alert("å»ºç«‹æˆåŠŸ"); checkBookExist();
        }

        function lockIdentityAndEnter() {
            const selected = document.getElementById('user-select').value;
            const passInput = document.getElementById('login-pass').value.trim();
            if (passInput !== db.pass) return alert("å¯†ç¢¼éŒ¯èª¤");
            if (selected === db.manager) {
                if(document.getElementById('admin-login-pass').value.trim() !== db.adminPass) return alert("ç®¡ç†å“¡å¯†ç¢¼éŒ¯èª¤");
            }
            currentUser = selected;
            if(document.getElementById('auto-login-check').checked) {
                localStorage.setItem('trip_auto_id', db.id); localStorage.setItem('trip_auto_user', currentUser); localStorage.setItem('trip_auto_pass', db.pass);
            }
            initApp();
        }

        function getFlag(n) { 
            const f = currencies.find(c => c.code === n.toUpperCase());
            return f ? f.name.split(' ')[0] : "ğŸŒ"; 
        }

        function initApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('loading-mask').classList.add('hidden');
            
            if(currentUser === db.manager) {
                document.getElementById('tab-admin-btn').classList.remove('hidden');
                document.getElementById('set-members').value = db.members.join(',');
                document.getElementById('set-sub-name').value = db.subName;
                document.getElementById('set-rate').value = db.rate;
                document.getElementById('set-book-pass').value = db.pass;
                document.getElementById('set-admin-pass').value = db.adminPass;
                const mgrSel = document.getElementById('set-manager');
                mgrSel.innerHTML = db.members.map(m=>`<option value="${m}">${m}</option>`).join('');
                mgrSel.value = db.manager;
            }

            document.getElementById('display-user').innerText = `ğŸ‘¤ ${currentUser} ${currentUser === db.manager ? '(ç®¡ç†)' : ''}`;
            document.getElementById('btn-sub').innerText = `${getFlag(db.subName)} ${db.subName}`;
            document.getElementById('tab-add-title').innerText = `ğŸ“ æ–°å¢æ”¯å‡º (${currentCur==='TWD'?'å°å¹£':db.subName})`;
            document.getElementById('exp-date').valueAsDate = new Date();
            document.getElementById('fund-date').valueAsDate = new Date();

            const payerSelect = document.getElementById('payer-member');
            payerSelect.innerHTML = db.members.map(m=>`<option value="${m}">${m}</option>`).join('');
            const splittersGrid = document.getElementById('splitters-grid');
            splittersGrid.innerHTML = db.members.map(m=>`<label class="flex items-center gap-1 p-2 bg-slate-50 rounded border cursor-pointer"><input type="checkbox" value="${m}" checked> ${m}</label>`).join('');

            updateSealUI();
            
            if (currentUser !== db.manager) {
                const pubOpt = document.getElementById('opt-public-pay');
                pubOpt.disabled = true; pubOpt.innerText += " (é™ç®¡ç†)";
                document.getElementById('exp-path').value = 'advance';
                togglePayerSelection();
            }

            startSync(); refreshUI();
        }

        function save() { if (db.id) rdb.ref('books/' + db.id).set(db); }
        function startSync() {
            if (!db.id) return;
            rdb.ref('books/' + db.id).on('value', (s) => {
                const data = s.val(); if (data && JSON.stringify(data) !== JSON.stringify(db)) { db = data; if(!db.items)db.items=[]; refreshUI(false); }
            });
        }

        function updateSealUI() {
            const badge = document.getElementById('seal-badge');
            const btnSeal = document.getElementById('btn-seal');
            const addPanel = document.getElementById('add-panel');
            
            if(db.isSealed) {
                badge.classList.remove('hidden');
                if(btnSeal) { btnSeal.innerText = "ğŸ”“ è§£é™¤å°å­˜"; btnSeal.className = "w-full bg-gray-500 text-white py-3 rounded-xl font-bold"; }
                addPanel.classList.add('opacity-50', 'pointer-events-none');
            } else {
                badge.classList.add('hidden');
                if(btnSeal) { btnSeal.innerText = "ğŸ”’ å°å­˜å¸³ç°¿ (å”¯è®€)"; btnSeal.className = "w-full bg-orange-500 text-white py-3 rounded-xl font-bold"; }
                addPanel.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        function refreshUI(shouldSave = true) {
            if (shouldSave) save();
            updateSealUI();
            const curItems = db.items.filter(i => i.cur === currentCur);
            const totalFund = curItems.filter(i => i.type === 'fund').reduce((s, i) => s + (i.amt || 0), 0);
            const totalSpend = curItems.filter(i => i.type === 'public').reduce((s, i) => s + (i.amt || 0), 0);
            document.getElementById('sum-income').innerText = `${Math.round(totalFund)}`;
            document.getElementById('sum-expense').innerText = `${Math.round(totalSpend)}`;
            document.getElementById('sum-balance').innerText = `${Math.round(totalFund - totalSpend)}`;
            
            renderLists();
            renderLedger();
            renderStats();
            renderSettleReport();
        }

        function renderLists() {
            const sortFn = (a, b) => sortDesc ? b.date.localeCompare(a.date) : a.date.localeCompare(b.date);
            const list = db.items.filter(i => i.cur === currentCur).sort(sortFn);

            const inc = list.filter(i => i.type === 'fund');
            document.getElementById('income-list').innerHTML = inc.map(i => {
                const per = Math.round(i.amt / (i.splitters?.length || db.members.length));
                return listRow(i, `æ¯äºº${per}`, 'text-green-600', `+${Math.round(i.amt)}`, currentUser === db.manager);
            }).join('') || noData();

            const pub = list.filter(i => i.type === 'public');
            document.getElementById('public-exp-list').innerHTML = pub.map(i => {
                const per = Math.round(i.amt / (i.splitters?.length || 1));
                const canEdit = currentUser === db.manager || i.payer === currentUser;
                return listRow(i, `æ¯äººåˆ†æ”¤${per}`, 'text-red-600', `-${Math.round(i.amt)}`, canEdit);
            }).join('') || noData();

            const adv = list.filter(i => i.type === 'advance');
            document.getElementById('adv-list').innerHTML = adv.map(i => {
                const per = Math.round(i.amt / (i.splitters?.length || 1));
                const canEdit = currentUser === db.manager || i.payer === currentUser || i.splitters.includes(currentUser);
                return listRow(i, `æ¯äººåˆ†æ”¤${per} | åˆ†æ”¤:${i.splitters.join(',')}`, 'text-green-600', `${Math.round(i.amt)}`, canEdit, `${i.payer}å…ˆå¢Š`);
            }).join('') || noData();

            const pvt = list.filter(i => i.type === 'personal' && i.payer === currentUser);
            document.getElementById('pvt-list').innerHTML = pvt.map(i => {
                return listRow(i, `å€‹äººç¨è³‡`, 'text-red-600', `-${Math.round(i.amt)}`, true);
            }).join('') || noData();
        }

        function listRow(i, sub, color, amt, canEdit, badge='') {
            const editBtn = (!db.isSealed && canEdit) ? `<button onclick="loadItemForEdit(${i.id})" class="text-xs text-blue-400 underline mr-2">ä¿®æ”¹</button><button onclick="deleteItem(${i.id})" class="text-xs text-red-400 underline">åˆªé™¤</button>` : '';
            const badgeHtml = badge ? `<span class="text-slate-500 font-bold px-1 text-xs bg-slate-100 rounded ml-1">${badge}</span>` : '';
            return `<div class="flex justify-between p-3 border-b border-slate-100 bg-white items-center">
                <div><div class="text-xs text-slate-400">${i.date} ${badgeHtml}</div><div class="font-bold text-lg text-slate-700">${i.title} <span class="text-xs text-slate-400 font-normal ml-1">(${sub})</span></div></div>
                <div class="text-right"><div class="${color} font-bold text-lg amt-text">${amt}</div>${editBtn}</div>
            </div>`;
        }
        function noData() { return '<p class="p-4 text-slate-400 text-center text-sm">ç„¡è³‡æ–™</p>'; }

        function loadItemForEdit(id) {
            if(db.isSealed) return alert("å¸³ç°¿å·²å°å­˜");
            const item = db.items.find(i => i.id == id);
            if(!item) return;
            document.getElementById('edit-id').value = item.id;
            document.getElementById('exp-date').value = item.date;
            document.getElementById('exp-cat').value = item.cat || 'â¤ï¸ å…¶ä»–';
            document.getElementById('exp-title').value = item.title;
            document.getElementById('exp-amt').value = item.amt;
            document.getElementById('exp-path').value = item.type;
            
            document.getElementById('form-header-text').innerText = "âœï¸ ç·¨è¼¯é …ç›®";
            document.getElementById('btn-submit').innerText = "ç¢ºèªä¿®æ”¹";
            document.getElementById('btn-submit').className = "flex-1 bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-lg";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            
            togglePayerSelection();
            if(item.type === 'advance') document.getElementById('payer-member').value = item.payer;
            const boxes = document.querySelectorAll('#splitters-grid input');
            boxes.forEach(b => b.checked = item.splitters ? item.splitters.includes(b.value) : false);

            document.getElementById('add-panel').open = true;
            document.querySelector('.app-container').scrollIntoView({ behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('edit-id').value = "";
            document.getElementById('exp-title').value = "";
            document.getElementById('exp-amt').value = "";
            document.getElementById('form-header-text').innerText = "ğŸ“ æ–°å¢æ”¯å‡º/æ”¶å…¥";
            document.getElementById('btn-submit').innerText = "ç¢ºèªè¨˜å¸³";
            document.getElementById('btn-submit').className = "flex-1 bg-slate-800 text-white py-4 rounded-xl font-black text-lg shadow-lg";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.querySelectorAll('#splitters-grid input').forEach(b => b.checked = true);
            document.getElementById('add-panel').open = false;
        }

        function handleRecordSubmit() {
            if(db.isSealed) return alert("å¸³ç°¿å·²å°å­˜");
            const editId = document.getElementById('edit-id').value;
            if(editId) updateRecord(editId); else addRecord();
        }

        function addRecord() {
            const date = document.getElementById('exp-date').value;
            const title = document.getElementById('exp-title').value.trim();
            const amt = parseFloat(document.getElementById('exp-amt').value);
            const cat = document.getElementById('exp-cat').value;
            const type = document.getElementById('exp-path').value;
            if (!date || !title || !amt) return alert("è³‡æ–™ä¸å®Œæ•´");

            let payer = "å…¬å¸³";
            let splitters = [];
            if (type === 'personal') { payer = currentUser; splitters = [currentUser]; } 
            else {
                if (type === 'advance') payer = document.getElementById('payer-member').value;
                const checkboxes = document.querySelectorAll('#splitters-grid input:checked');
                splitters = Array.from(checkboxes).map(c => c.value);
                if (splitters.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†å¸³æˆå“¡");
            }
            db.items.push({ id: Date.now(), date, cat, title, amt, cur: currentCur, type, payer, splitters });
            refreshUI(); alert("âœ… è¨˜å¸³æˆåŠŸ"); resetForm();
        }

        function updateRecord(id) {
            const idx = db.items.findIndex(i => i.id == id);
            const date = document.getElementById('exp-date').value;
            const title = document.getElementById('exp-title').value.trim();
            const amt = parseFloat(document.getElementById('exp-amt').value);
            const cat = document.getElementById('exp-cat').value;
            const type = document.getElementById('exp-path').value;
            let payer = "å…¬å¸³";
            let splitters = [];
            if (type === 'personal') { payer = currentUser; splitters = [currentUser]; } 
            else {
                if (type === 'advance') payer = document.getElementById('payer-member').value;
                const checkboxes = document.querySelectorAll('#splitters-grid input:checked');
                splitters = Array.from(checkboxes).map(c => c.value);
            }
            db.items[idx] = { ...db.items[idx], date, cat, title, amt, type, payer, splitters };
            refreshUI(); alert("âœ… ä¿®æ”¹å®Œæˆ"); resetForm();
        }

        function deleteItem(id) {
            if (db.isSealed) return alert("å¸³ç°¿å·²å°å­˜");
            if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { db.items = db.items.filter(i => i.id != id); refreshUI(); }
        }

        function renderLedger() {
            const list = db.items.filter(i => i.cur === currentCur).sort((a,b) => sortDesc ? b.date.localeCompare(a.date) : a.date.localeCompare(b.date));
            let htmls = { pf: "", pc: "", ap: "", ac: "", pp: "" };
            let sums = { pf: 0, pc: 0, ap: 0, ac: 0, pp: 0 };
            let nets = { pub: 0, adv: 0 };

            list.forEach(i => {
                const share = Math.round(i.amt / (i.splitters?.length || 1));
                if (i.type === 'fund' && i.splitters.includes(currentUser)) {
                    sums.pf += share; nets.pub += share;
                    htmls.pf += lRow(i.date, "é ç¹³å…¬å¸³", "text-green-600", `+${share}`);
                }
                if (i.type === 'public' && i.splitters.includes(currentUser)) {
                    sums.pc += share; nets.pub -= share;
                    htmls.pc += lRow(i.date, i.title, "text-red-600", `-${share}`);
                }
                if (i.type === 'advance' && i.payer === currentUser) {
                    sums.ap += i.amt; nets.adv += i.amt;
                    htmls.ap += lRow(i.date, `(æˆ‘) â¡ (${i.splitters.join(',')})`, "text-green-600", `+${Math.round(i.amt)}`, `ä»£å¢Š ${i.title}`);
                }
                if (i.type === 'advance' && i.splitters.includes(currentUser)) {
                    sums.ac += share; nets.adv -= share;
                    htmls.ac += lRow(i.date, `(${i.payer}) â¡ (${i.splitters.join(',')})`, "text-red-600", `-${share}`, i.title);
                }
                if (i.type === 'personal' && i.payer === currentUser) {
                    sums.pp += i.amt;
                    htmls.pp += lRow(i.date, i.title, "text-red-600", `-${Math.round(i.amt)}`);
                }
            });

            const html = `
                <div class="mb-8">
                    <h4 class="font-black text-lg text-slate-800 mb-3 pl-2 border-l-4 border-slate-800">ğŸ”µ å…¬å¸³åˆ†æ”¤</h4>
                    ${lBlock("é ç¹³å­˜å…¥", htmls.pf, sums.pf)}
                    ${lBlock("æ¶ˆè²»æ‰£æŠµ", htmls.pc, sums.pc)}
                    <div class="text-right font-black p-3 mt-2 border-t text-slate-700">å…¬å¸³æ¬Šç›Š: <span class="text-blue-600">${nets.pub}</span></div>
                </div>
                <div class="mb-8">
                    <h4 class="font-black text-lg text-slate-800 mb-3 pl-2 border-l-4 border-purple-500">ğŸŸ£ å€‹äººç¨è³‡</h4>
                    ${lBlock("å€‹äººæ”¯å‡º", htmls.pp, sums.pp)}
                </div>
                <div>
                    <h4 class="font-black text-lg text-slate-800 mb-3 pl-2 border-l-4 border-orange-500">ğŸŸ  ä»£å¢Šå¾€ä¾†</h4>
                    ${lBlock("æˆ‘å¹«äººå¢Š (æ‡‰æ”¶)", htmls.ap, sums.ap)}
                    ${lBlock("äººå¹«æˆ‘å¢Š (æ‡‰ä»˜)", htmls.ac, sums.ac)}
                    <div class="text-right font-black p-3 mt-2 border-t text-slate-700">ä»£å¢Šæ·¨é¡: <span class="text-blue-600">${nets.adv}</span></div>
                </div>`;
            document.getElementById('ledger-content').innerHTML = html;
        }
        function lRow(d, t, c, a, sub='') {
            return `<div class="flex justify-between p-3 border-b border-slate-100 items-center">
                <div><div class="text-xs text-slate-400">${d} ${sub}</div><div class="font-bold text-slate-700">${t}</div></div>
                <div class="${c} font-bold amt-text">${a}</div>
            </div>`;
        }
        function lBlock(title, rows, sum) {
            return `<div class="text-sm font-bold text-slate-500 mb-1 pl-2">${title}</div>
            <div class="bg-white border-y border-slate-200 mb-2">${rows || '<p class="p-3 text-sm text-slate-300">ç„¡ç´€éŒ„</p>'}</div>
            <div class="text-right text-xs text-slate-900 font-bold pr-3 mb-4">å°è¨ˆ: ${sum}</div>`;
        }

        function renderStats() {
            if(chartInstance) chartInstance.destroy();
            const list = db.items.filter(i => i.cur === currentCur);
            const cats = {}; let total = 0;
            list.forEach(i => {
                let cost = 0;
                if (i.type === 'personal' && i.payer === currentUser) cost = i.amt;
                else if ((i.type === 'public' || i.type === 'advance') && i.splitters.includes(currentUser)) {
                    cost = i.amt / i.splitters.length;
                }
                if (cost > 0) { cats[i.cat] = (cats[i.cat] || 0) + cost; total += cost; }
            });
            document.getElementById('stats-total').innerText = `${Math.round(total)}`;
            const ctx = document.getElementById('expenseChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{ data: Object.values(cats).map(v => Math.round(v)), backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7', '#ec4899'] }]
                }, options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderSettleReport() {
            const btnClass = "flex-1 py-2 rounded text-sm font-bold transition ";
            const active = "bg-blue-600 text-white shadow";
            const inactive = "bg-slate-100 text-slate-600 hover:bg-slate-200";
            document.getElementById('btn-settle-twd').className = btnClass + (SMode==='TWD' ? active : inactive);
            document.getElementById('btn-settle-sub').className = btnClass + (SMode==='SUB' ? active : inactive);
            document.getElementById('btn-settle-mix').className = btnClass + (SMode==='MIX' ? active : inactive);

            const results = {};
            db.members.forEach(m => results[m] = { income: 0, expense: 0 });

            db.items.forEach(i => {
                let val = i.amt;
                if (SMode === 'MIX' && i.cur === 'SUB') val = i.amt * db.rate;
                if (SMode === 'TWD' && i.cur !== 'TWD') return;
                if (SMode === 'SUB' && i.cur !== 'SUB') return;

                const share = val / i.splitters.length;
                if (i.type === 'fund') i.splitters.forEach(m => results[m].income += share);
                else if (i.type === 'public') i.splitters.forEach(m => results[m].expense += share);
                else if (i.type === 'advance') {
                    if(results[i.payer]) results[i.payer].income += val;
                    i.splitters.forEach(m => results[m].expense += share);
                }
            });

            let html = `<table class="w-full text-sm text-center">
                <thead class="bg-slate-800 text-white"><tr><th class="p-2">æˆå“¡</th><th class="p-2">æ”¶å…¥(é /å¢Š)</th><th class="p-2">æ”¯å‡º(æ‡‰ä»˜)</th><th class="p-2">çµé¤˜</th></tr></thead>
                <tbody>`;
            const netArr = [];
            db.members.forEach(m => {
                const bal = results[m].income - results[m].expense;
                netArr.push({ name: m, bal });
                html += `<tr class="border-b bg-white">
                    <td class="p-2 font-bold">${m}</td>
                    <td class="p-2 text-green-600">${Math.round(results[m].income)}</td>
                    <td class="p-2 text-red-600">${Math.round(results[m].expense)}</td>
                    <td class="p-2 font-black ${bal>=0?'text-blue-600':'text-red-600'}">${bal>=0?'+':''}${Math.round(bal)}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            
            let receivers = netArr.filter(n => n.bal > 0.5).sort((a,b) => b.bal - a.bal);
            let payers = netArr.filter(n => n.bal < -0.5).map(n => ({...n, bal: Math.abs(n.bal)})).sort((a,b) => b.bal - a.bal);
            let logs = [];
            payers.forEach(p => { receivers.forEach(r => {
                if (p.bal <= 0 || r.bal <= 0) return;
                let amt = Math.min(p.bal, r.bal);
                logs.push(`<b>${p.name}</b> â¡ï¸ <b>${r.name}</b>ï¼š${Math.round(amt)}`);
                p.bal -= amt; r.bal -= amt;
            });});
            receivers.forEach(r => { if(r.bal > 0.5 && r.name !== db.manager) logs.push(`<b>${db.manager}(é€€å…¬å¸³)</b> â¡ï¸ <b>${r.name}</b>ï¼š${Math.round(r.bal)}`); });
            html += `<div class="mt-4 space-y-2 text-sm">${logs.map(l=>`<div class="bg-white p-2 border rounded shadow-sm border-l-4 border-blue-500">${l}</div>`).join('')}</div>`;
            document.getElementById('settle-content').innerHTML = html;
        }

        function switchTab(tab, btn) {
            ['pub','adv','pvt','my','stats','final','admin'].forEach(t => document.getElementById('panel-'+t).classList.add('hidden'));
            document.querySelectorAll('#main-tabs button').forEach(b => {
                if(b.id !== 'tab-admin-btn') b.className = "px-5 py-2 rounded-xl font-bold bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 transition shadow-sm w-full lg:w-auto";
            });
            if(btn.id !== 'tab-admin-btn') btn.className = "px-5 py-2 rounded-xl font-bold bg-slate-800 text-white shadow-md w-full lg:w-auto";
            document.getElementById('panel-'+tab).classList.remove('hidden');
            if(tab === 'stats') renderStats();
        }
        
        function toggleSort() { sortDesc = !sortDesc; refreshUI(false); }
        function switchSettleMode(m) { SMode = m; refreshUI(false); }
        function switchCurrency(c) { currentCur = c; refreshUI(false); 
            document.getElementById('btn-twd').className = `flex-1 lg:flex-none px-6 py-3 rounded-xl font-bold border-2 transition-all ${c==='TWD'?'currency-active':'bg-white text-slate-400'}`;
            document.getElementById('btn-sub').className = `flex-1 lg:flex-none px-6 py-3 rounded-xl font-bold border-2 transition-all ${c==='SUB'?'currency-active':'bg-white text-slate-400'}`;
        }
        function togglePayerSelection() {
            const p = document.getElementById('exp-path').value;
            document.getElementById('payer-select-div').classList.toggle('hidden', p !== 'advance');
            document.getElementById('splitters-block').classList.toggle('hidden', p === 'personal');
        }
        function downloadData() {
            const blob = new Blob([JSON.stringify(db, null, 2)], {type : 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `TripSplit_${db.id}.json`; a.click();
        }
        function renderUserSelect() {
            const s = document.getElementById('user-select'); s.innerHTML = db.members.map(m=>`<option value="${m}">${m}</option>`).join('');
            s.onchange = () => document.getElementById('admin-pass-input-box').classList.toggle('hidden', s.value !== db.manager);
            s.onchange();
        }
        function addFundRecord() {
            if(db.isSealed) return alert("å¸³ç°¿å·²å°å­˜");
            const p = parseFloat(document.getElementById('fund-amt').value); if(!p)return; 
            db.items.push({id:Date.now(), date:document.getElementById('fund-date').value, cat:"ğŸ’°", title:"å…¨å“¡å…¬å¸³é ç¹³", amt:p*db.members.length, cur:currentCur, type:'fund', payer:"å…¨å“¡", splitters:[...db.members]}); refreshUI(); alert("å…¥å¸³æˆåŠŸ");
        }
        function updateSettings() {
            if(db.isSealed) return alert("å¸³ç°¿å·²å°å­˜");
            db.members = document.getElementById('set-members').value.split(/[,ï¼Œ]/).map(m=>m.trim()).filter(m=>m);
            db.subName = document.getElementById('set-sub-name').value;
            db.rate = parseFloat(document.getElementById('set-rate').value);
            db.manager = document.getElementById('set-manager').value;
            db.pass = document.getElementById('set-book-pass').value;
            db.adminPass = document.getElementById('set-admin-pass').value;
            save(); alert("è¨­å®šå·²æ›´æ–°"); location.reload();
        }
        function toggleSeal() {
            if(confirm(`ç¢ºå®šè¦${db.isSealed?'è§£é™¤å°å­˜':'å°å­˜å¸³ç°¿'}å—ï¼Ÿ`)) { db.isSealed = !db.isSealed; save(); refreshUI(); alert(db.isSealed?"å¸³ç°¿å·²å°å­˜":"å¸³ç°¿å·²è§£å°"); }
        }
        function deleteAllData() { if(db.isSealed)return alert("å°å­˜ä¸­"); if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { db.items = []; save(); refreshUI(); } }
        function logout() { localStorage.removeItem('trip_auto_pass'); location.reload(); }
    </script>
</body>
</html>
