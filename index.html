<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠåˆ†å¸³åŠ©æ‰‹ v48.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto+Sans+TC', sans-serif; background-color: #f8fafc; }
        .is-locked { background-color: #f1f5f9 !important; cursor: not-allowed; color: #94a3b8 !important; }
        .admin-hidden { display: none !important; }
        .settled-lock { pointer-events: none; opacity: 0.5; position: relative; }
        .settled-lock::after { content: 'ğŸ”’ å¸³ç›®å·²å°å­˜'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 99px; font-weight: 900; z-index: 50; }
        
        details { transition: all 0.3s ease; }
        summary { list-style: none; cursor: pointer; outline: none; }
        summary::-webkit-details-marker { display: none; }
        .dropdown-card { background: white; border-radius: 1.25rem; overflow: hidden; border: 1px solid #e2e8f0; margin-bottom: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .dropdown-summary { padding: 1rem; font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
        .dropdown-content { padding: 0 1rem 1rem 1rem; }
        .compact-input { padding: 0.75rem !important; font-size: 0.875rem !important; border-radius: 1rem !important; }
        
        .date-divider { position: relative; text-align: center; margin: 15px 0 10px 0; }
        .date-divider::before { content: ""; position: absolute; left: 0; top: 50%; width: 100%; border-bottom: 1px solid #e2e8f0; }
        .date-label { position: relative; background: #f8fafc; padding: 0 10px; font-size: 10px; font-weight: 900; color: #94a3b8; letter-spacing: 1px; }
        
        .guide-step { background: #f0f4ff; border-radius: 12px; padding: 10px; margin-top: 8px; border-left: 4px solid #6366f1; }
        .btn-action { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 8px; margin-left: 4px; }
    </style>
</head>
<body class="p-3 pb-24">

    <div class="max-w-xl mx-auto">
        <div id="status" class="text-[10px] text-center font-bold text-slate-400 mb-2 tracking-widest italic uppercase">SYSTEM READY</div>
        <div id="settledBanner" class="hidden bg-rose-600 text-white text-center py-2 rounded-xl mb-4 font-black text-sm animate-pulse shadow-lg">ğŸ ç¸½çµç®—å·²å•Ÿå‹• Â· å¸³ç›®å°å­˜ä¸­</div>

        <div id="loginSection" class="space-y-4">
            <div class="bg-indigo-700 p-8 rounded-[1.5rem] shadow-2xl text-white">
                <h1 class="text-3xl font-black text-center mb-6 italic tracking-tight text-yellow-400">TripSplit</h1>
                <div class="space-y-3">
                    <input type="text" id="roomId" class="w-full p-4 rounded-2xl text-black font-bold text-center outline-none" placeholder="æˆ¿é–“ ID (å¦‚: Tokyo2025)">
                    <input type="password" id="roomPass" class="w-full p-4 rounded-2xl text-black font-bold text-center outline-none" placeholder="é€²å…¥æš—è™Ÿ">
                    <div class="flex items-center justify-center gap-2 py-2 text-indigo-100">
                        <input type="checkbox" id="rememberId" class="w-5 h-5 accent-yellow-400">
                        <label for="rememberId" class="font-bold text-sm">è¨˜ä½æˆ¿é–“ ID</label>
                    </div>
                    <button onclick="handleAuth('login')" class="w-full bg-yellow-400 text-indigo-900 p-4 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-transform">é€²å…¥å¸³ç°¿</button>
                    <button onclick="handleAuth('create')" class="w-full bg-indigo-800 text-indigo-100 p-3 rounded-2xl font-bold text-xs opacity-70">å»ºç«‹å…¨æ–°æˆ¿é–“</button>
                </div>
            </div>

            <details class="dropdown-card border-l-8 border-sky-400">
                <summary class="dropdown-summary text-sky-800 text-sm bg-sky-50"><span>ğŸš€ å®Œæ•´æ“ä½œæŒ‡å— (æ–°é–‹å¸³ç°¿å¿…çœ‹)</span><span>âŠ•</span></summary>
                <div class="dropdown-content text-[11px] text-slate-600 space-y-4 pt-4 leading-relaxed">
                    <div class="guide-step">
                        <b class="text-indigo-700 block mb-1">ğŸ†• å¦‚ä½•å»ºç«‹æ–°å¸³ç°¿ï¼Ÿ</b>
                        1. åœ¨ä¸Šæ–¹è¼¸å…¥è‡ªè¨‚çš„ <b>æˆ¿é–“ ID</b> èˆ‡ <b>æš—è™Ÿ</b>ã€‚<br>
                        2. é»æ“Šã€Œå»ºç«‹å…¨æ–°æˆ¿é–“ã€æŒ‰éˆ•ã€‚<br>
                        3. é€²å…¥å¾Œï¼Œåœ¨æœ€ä¸‹æ–¹<b>ã€Œç®¡ç†å“¡è¨­å®šå°ˆå€ã€</b>è¨­å®šæˆå“¡åå­—ã€‚<br>
                        4. é»æ“Šä¸Šæ–¹<b>ã€Œé–å®šèº«ä»½ã€</b>é¸æ“‡è‡ªå·±ï¼Œå³æˆç‚ºç®¡ç†å“¡ã€‚
                    </div>
                    <div class="guide-step">
                        <b class="text-indigo-700 block mb-1">ğŸ‘¥ åœ˜å“¡å¦‚ä½•åŠ å…¥ï¼Ÿ</b>
                        1. è¼¸å…¥ç®¡ç†å“¡å»ºç«‹çš„ <b>æˆ¿é–“ ID</b> èˆ‡ <b>æš—è™Ÿ</b>ï¼Œé»æ“Šã€Œé€²å…¥å¸³ç°¿ã€ã€‚<br>
                        2. æ‰¾åˆ°è‡ªå·±çš„åå­—ä¸¦é»æ“Š<b>ã€Œé–å®šèº«ä»½ã€</b>ï¼Œå³å¯é–‹å§‹è¨˜å¸³ã€‚
                    </div>
                    <div class="guide-step">
                        <b class="text-amber-700 block mb-1">ğŸ’° æ¬Šé™èªªæ˜</b>
                        â€¢ <b>ç®¡ç†å“¡</b>ï¼šç®¡ç†å…¬å¸³æ”¶å…¥/æ”¯å‡ºã€è¨­å®šåå–®ã€å•Ÿå‹•æœ€çµ‚çµç®—ã€‚<br>
                        â€¢ <b>ä¸€èˆ¬åœ˜å“¡</b>ï¼šç™»è¨˜å€‹äººä»£å¢Šé …ç›®ï¼Œå¯ä¿®æ”¹è‡ªå·±æœ‰é—œçš„å¸³ç›®ã€‚
                    </div>
                </div>
            </details>
        </div>

        <div id="mainUI" class="hidden space-y-3">
            <div class="bg-slate-900 text-white p-4 rounded-[1.5rem] flex justify-between items-center shadow-xl border-b-4 border-emerald-500 mb-2">
                <div>
                    <p class="text-[9px] opacity-60 font-black uppercase italic">Public Fund Balance</p>
                    <p id="fundBalance" class="text-2xl font-mono font-black text-yellow-400">$0</p>
                </div>
                <div class="text-right flex items-center gap-3">
                    <div class="text-right">
                        <select id="currentUser" class="bg-indigo-800 text-white font-bold text-xs rounded-lg p-1 outline-none" onchange="updateUI()"></select>
                        <div id="lockBadge" class="hidden text-emerald-400 font-black text-[9px]">âœ“ å·²é–å®š</div>
                    </div>
                    <button id="btnLockUser" onclick="lockMyIdentity()" class="bg-indigo-600 text-white px-3 py-2 rounded-xl font-bold text-[10px]">é–å®šèº«ä»½</button>
                    <button onclick="logout()" class="text-slate-400 font-bold text-[10px] ml-1">ç™»å‡º</button>
                </div>
            </div>

            <details id="depositBox" class="admin-hidden dropdown-card border-l-8 border-amber-400">
                <summary class="dropdown-summary text-amber-800 text-sm">
                    <span>ğŸ“¥ ç™»è¨˜å…¬å¸³æ”¶å…¥ (ç®¡ç†å“¡)</span>
                    <span id="depEditTag" class="hidden text-[10px] bg-rose-500 text-white px-2 rounded-full">ç·¨è¼¯ä¸­</span>
                    <span>âŠ•</span>
                </summary>
                <div class="dropdown-content space-y-2">
                    <div class="flex gap-2">
                        <input type="date" id="depDate" class="w-1/2 compact-input bg-slate-50 border">
                        <input type="number" id="depAmount" class="w-1/2 compact-input text-center font-black bg-slate-50 border" placeholder="é‡‘é¡">
                    </div>
                    <div id="depNormalBtns" class="flex flex-col gap-2">
                        <button onclick="addBulkDep()" class="w-full bg-amber-500 text-white p-2 rounded-xl font-black text-xs">å…¨å“¡å„ç¹³ä¸€ä»½</button>
                        <div class="flex gap-2">
                            <select id="depMember" class="flex-1 p-2 border rounded-xl text-[10px]"></select>
                            <button onclick="addSingleDep()" class="bg-slate-800 text-white px-4 rounded-xl font-bold text-[10px]">å–®äººè£œç¹³</button>
                        </div>
                    </div>
                    <div id="depEditBtns" class="hidden flex gap-2">
                        <button onclick="saveDepEdit()" class="flex-1 bg-indigo-600 text-white p-2 rounded-xl font-black text-xs">å„²å­˜ä¿®æ”¹</button>
                        <button onclick="resetDepForm()" class="flex-1 bg-slate-200 text-slate-600 p-2 rounded-xl font-black text-xs">å–æ¶ˆ</button>
                    </div>
                </div>
            </details>

            <div id="expenseFormBox" class="bg-white p-4 rounded-[1.5rem] shadow-sm border border-slate-200">
                <h2 id="formTitle" class="font-black text-base text-slate-800 mb-3 flex justify-between items-center border-l-4 border-indigo-500 pl-2">
                    <span>æ–°å¢æ”¯å‡ºé …ç›®</span>
                    <button id="cancelEdit" onclick="resetForm()" class="hidden text-[10px] bg-rose-100 text-rose-500 px-2 py-0.5 rounded-full font-bold">å–æ¶ˆç·¨è¼¯</button>
                </h2>
                <div class="space-y-2">
                    <div class="flex gap-2">
                        <input type="date" id="expDate" class="w-1/2 compact-input bg-slate-50 border-none font-bold">
                        <select id="expCategory" class="w-1/2 compact-input bg-slate-50 border-none font-bold"></select>
                    </div>
                    <input type="text" id="expDesc" placeholder="æ¶ˆè²»å…§å®¹" class="w-full compact-input bg-slate-50 border-none font-bold">
                    <div class="flex gap-2">
                        <input type="number" id="expAmount" placeholder="é‡‘é¡" class="w-1/2 compact-input bg-indigo-50 border-none font-black text-indigo-700">
                        <select id="expPayer" class="w-1/2 compact-input bg-indigo-50 border-none font-bold text-indigo-700"></select>
                    </div>
                    <div id="involvedGrid" class="grid grid-cols-3 gap-1"></div>
                    <button id="submitBtn" onclick="saveExpense()" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-black text-base shadow-lg mt-1 opacity-50 pointer-events-none">è«‹é–å®šèº«ä»½</button>
                    <p id="lockReminder" class="text-center text-[9px] text-rose-500 font-bold hidden">âš ï¸ è«‹å…ˆé¸æ“‡è‡ªå·±ä¸¦é–å®šèº«ä»½æ‰èƒ½è¨˜å¸³</p>
                </div>
            </div>

            <details class="dropdown-card border-l-8 border-amber-200">
                <summary class="dropdown-summary text-slate-600 text-xs"><span>ğŸ“’ å…¬å¸³æ”¶å…¥æ˜ç´°</span><span>â–¼</span></summary>
                <div id="incomeTimeline" class="dropdown-content space-y-2"></div>
            </details>
            <details class="dropdown-card border-l-8 border-emerald-400">
                <summary class="dropdown-summary text-slate-600 text-xs"><span>ğŸ’° å…¬å¸³æ”¯ä»˜æ˜ç´°è¡¨</span><span>â–¼</span></summary>
                <div id="publicTimeline" class="dropdown-content space-y-2"></div>
            </details>
            <details class="dropdown-card border-l-8 border-indigo-400">
                <summary class="dropdown-summary text-slate-600 text-xs"><span>ğŸ‘¤ å€‹äººä»£å¢Šæ˜ç´°è¡¨</span><span>â–¼</span></summary>
                <div id="personalTimeline" class="dropdown-content space-y-2"></div>
            </details>

            <details id="settleAreaDetails" class="dropdown-card border-l-8 border-slate-900 bg-slate-900 shadow-xl">
                <summary class="dropdown-summary text-yellow-400 text-base"><span class="font-black italic">ğŸ æœ€çµ‚çµç®—æ¸…å–®</span><span>â–¼</span></summary>
                <div class="dropdown-content bg-slate-900 text-white pt-2">
                    <div id="balanceAudit" class="bg-white/10 rounded-xl p-3 mb-4 space-y-1"></div>
                    <div id="splitResult" class="space-y-2 mb-6"></div>
                    <div class="flex gap-2">
                        <button onclick="exportCSV()" class="flex-1 bg-white/10 p-3 rounded-xl font-bold text-[10px] border border-white/10">ğŸ“¥ ä¸‹è¼‰ CSV</button>
                        <div id="adminSettleZone" class="admin-hidden flex-1">
                            <button onclick="toggleSettlement()" class="w-full bg-rose-500/20 text-rose-300 p-3 rounded-xl font-black text-[10px] border border-rose-500/30">å•Ÿå‹•/è§£å‡çµç®—</button>
                        </div>
                    </div>
                </div>
            </details>

            <details id="adminMemberSettings" class="admin-hidden dropdown-card border-l-8 border-slate-300">
                <summary class="dropdown-summary text-slate-500 text-xs"><span>âš™ï¸ ç®¡ç†å“¡è¨­å®šå°ˆå€</span><span>â–¼</span></summary>
                <div class="dropdown-content space-y-4 pt-2">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 block mb-1">æˆå“¡æ¸…å–® (é€—è™Ÿéš”é–‹)</label>
                        <input type="text" id="memberInput" class="w-full p-3 bg-slate-50 border rounded-xl text-xs font-bold" onchange="pushData()" placeholder="å°æ˜,å°ç¾">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 block mb-1">ç®¡ç†æš—è™Ÿ</label>
                        <input type="text" id="adminPassInput" class="w-full p-3 bg-slate-50 border rounded-xl text-xs font-bold" onchange="pushData()" placeholder="é è¨­ 1234">
                    </div>
                    <button onclick="clearAll()" class="w-full py-3 rounded-xl border-2 border-rose-100 text-rose-500 font-black text-xs">ğŸ’£ åˆªé™¤æˆ¿é–“æ‰€æœ‰è³‡æ–™</button>
                </div>
            </details>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        const firebaseConfig = { databaseURL: "https://project-2641836624074325409-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let members = [], expenses = [], deposits = [], manager = "", managerPass = "1234", roomId = "", roomPass = "", editingId = null, editingDepId = null, isSettled = false;
        const emojis = { "æ—©é¤":"ğŸ³", "åˆé¤":"ğŸ±", "æ™šé¤":"ğŸ½ï¸", "é»å¿ƒ":"ğŸ°", "å®µå¤œ":"ğŸœ", "é£²æ–™":"ğŸ¥¤", "äº¤é€š":"ğŸš—", "ä½å®¿":"ğŸ¨", "é–€ç¥¨":"ğŸ«", "è³¼ç‰©":"ğŸ›ï¸", "å¨›æ¨‚":"ğŸ¡", "å…¶ä»–":"ğŸ·ï¸" };

        // --- ç™»å…¥é‚è¼¯ ---
        async function handleAuth(mode) {
            roomId = document.getElementById('roomId').value.trim();
            roomPass = document.getElementById('roomPass').value.trim();
            if (!roomId || !roomPass) return alert("è«‹å¡«å¯« ID èˆ‡æš—è™Ÿ");
            const snap = await db.ref('rooms/' + roomId).once('value');
            const data = snap.val();
            if (mode === 'login') {
                if (!data) return alert("æ‰¾ä¸åˆ°æˆ¿é–“");
                if (data.password !== roomPass) return alert("æš—è™ŸéŒ¯èª¤");
                startSync();
            } else {
                if (data) return alert("ID å·²å­˜åœ¨");
                await db.ref('rooms/' + roomId).set({ password: roomPass, manager: "", managerPass: "1234", isSettled: false, members: ["æˆå“¡A", "æˆå“¡B"] });
                startSync();
            }
        }

        function startSync() {
            if (document.getElementById('rememberId').checked) localStorage.setItem('saved_room_id', roomId);
            db.ref('rooms/' + roomId).on('value', (snap) => {
                const data = snap.val(); if (!data) return;
                members = data.members || []; expenses = data.expenses || []; deposits = data.deposits || [];
                manager = data.manager || ""; managerPass = data.managerPass || "1234"; isSettled = data.isSettled || false;
                document.getElementById('memberInput').value = members.join(', ');
                document.getElementById('adminPassInput').value = managerPass;
                document.getElementById('mainUI').classList.remove('hidden');
                document.getElementById('loginSection').classList.add('hidden');
                updateUI();
            });
        }

        function updateUI() {
            const uSel = document.getElementById('currentUser'), curU = uSel.value;
            uSel.innerHTML = `<option value="">-- æˆ‘æ˜¯ --</option>` + members.map(m => `<option value="${m}" ${m===curU?'selected':''}>${m}</option>`).join('');
            const savedLockedUser = localStorage.getItem(`locked_user_${roomId}`);
            const isLocked = !!savedLockedUser;
            const currentUser = isLocked ? savedLockedUser : curU;
            const isAdminLocked = (isLocked && currentUser === manager);
            
            if (isLocked) {
                uSel.value = savedLockedUser; uSel.disabled = true; uSel.classList.add('is-locked');
                document.getElementById('btnLockUser').classList.add('hidden');
                document.getElementById('lockBadge').classList.remove('hidden');
                document.getElementById('submitBtn').classList.remove('opacity-50', 'pointer-events-none');
                document.getElementById('submitBtn').innerText = "ç¢ºèªå„²å­˜æ”¯å‡º";
                document.getElementById('lockReminder').classList.add('hidden');
            }
            
            document.getElementById('settledBanner').classList.toggle('hidden', !isSettled);
            document.getElementById('expenseFormBox').classList.toggle('settled-lock', isSettled);
            
            document.querySelectorAll('.admin-hidden').forEach(el => {
                if (isAdminLocked || (!manager && el.id === 'adminMemberSettings')) el.classList.remove('admin-hidden');
                else el.classList.add('admin-hidden');
            });
            
            updateForm(); 
            renderIncomeTimeline();
            renderTimeline('publicTimeline', e => e.paid_by === "å…¬å¸³");
            renderTimeline('personalTimeline', e => e.paid_by !== "å…¬å¸³");
            calculate();
        }

        // --- æ¸²æŸ“é‚è¼¯ (æŒ‰æ—¥æœŸç¾¤çµ„) ---
        function renderTimeline(id, filter) {
            const container = document.getElementById(id), user = localStorage.getItem(`locked_user_${roomId}`);
            container.innerHTML = "";
            const filtered = expenses.filter(filter).sort((a,b) => new Date(b.date) - new Date(a.date));
            if (!filtered.length) { container.innerHTML = "<div class='text-center py-4 text-[10px] text-slate-300 italic'>å°šç„¡è³‡æ–™</div>"; return; }
            
            const grouped = filtered.reduce((acc, obj) => { (acc[obj.date] = acc[obj.date] || []).push(obj); return acc; }, {});
            
            Object.keys(grouped).forEach(date => {
                container.innerHTML += `<div class="date-divider"><span class="date-label">${date}</span></div>`;
                grouped[date].forEach(e => {
                    const isF = e.paid_by === "å…¬å¸³";
                    const canEdit = !isSettled && (isF ? (user === manager) : (user === manager || user === e.paid_by || e.inv.includes(user)));
                    container.innerHTML += `
                    <div class="bg-slate-50 p-2.5 rounded-xl flex items-center gap-3 border border-slate-100 mb-2">
                        <div class="text-2xl">${emojis[e.category] || 'ğŸ·ï¸'}</div>
                        <div class="flex-1 min-w-0">
                            <div class="font-black text-slate-800 text-[11px] truncate">${e.desc}</div>
                            <div class="text-[8px] font-bold text-slate-400 mt-0.5">${isF ? 'âœ¨ å…¬å¸³' : 'ğŸ‘¤ ä»£å¢Š:' + e.paid_by} Â· åˆ†æ”¤: ${e.inv.length === members.length ? "å…¨å“¡" : e.inv.join(', ')}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-black text-sm text-slate-900">$${Math.round(e.amount)}</div>
                            ${canEdit ? `<div class="mt-1 flex gap-1 justify-end"><button onclick="editExp(${e.id})" class="btn-action bg-indigo-100 text-indigo-600">ç·¨ä¿®</button><button onclick="delExp(${e.id})" class="btn-action bg-rose-100 text-rose-500">åˆªé™¤</button></div>` : ''}
                        </div>
                    </div>`;
                });
            });
        }

        function renderIncomeTimeline() {
            const container = document.getElementById('incomeTimeline'), user = localStorage.getItem(`locked_user_${roomId}`);
            container.innerHTML = "";
            if (!deposits.length) { container.innerHTML = "<div class='text-center py-4 text-[10px] text-slate-300 italic'>å°šç„¡è³‡æ–™</div>"; return; }
            
            const grouped = deposits.sort((a,b) => new Date(b.date) - new Date(a.date)).reduce((acc, obj) => { (acc[obj.date] = acc[obj.date] || []).push(obj); return acc; }, {});
            
            Object.keys(grouped).forEach(date => {
                container.innerHTML += `<div class="date-divider"><span class="date-label">${date}</span></div>`;
                grouped[date].forEach(d => {
                    const canEdit = !isSettled && (user === manager);
                    container.innerHTML += `
                    <div class="bg-slate-50 p-2 rounded-xl flex justify-between items-center text-[10px] mb-1 border border-amber-50">
                        <div class="font-black text-slate-700">${d.from === "å…¨å“¡" ? 'âœ¨ å…¨å“¡é ç¹³' : 'ğŸ‘¤ ' + d.from + ' è£œç¹³'}</div>
                        <div class="text-right">
                            <div class="font-mono font-black text-amber-600">$${Math.round(d.amount)}</div>
                            ${canEdit ? `<div class="mt-1 flex gap-1 justify-end"><button onclick="editDep(${d.id})" class="btn-action bg-amber-100 text-amber-700">ç·¨ä¿®</button><button onclick="delDep('${d.id}')" class="btn-action bg-rose-100 text-rose-500">åˆªé™¤</button></div>` : ''}
                        </div>
                    </div>`;
                });
            });
        }

        // --- å…¶é¤˜æ ¸å¿ƒåŠŸèƒ½ (åŒå‰ç‰ˆæœ¬) ---
        function updateForm() {
            const user = localStorage.getItem(`locked_user_${roomId}`), pSel = document.getElementById('expPayer');
            pSel.innerHTML = (user === manager ? `<option value="å…¬å¸³">âœ¨ å…¬å¸³æ”¯ä»˜</option>` : `<option value="" disabled>ğŸš« å…¬å¸³ (é™ç®¡ç†å“¡)</option>`) + members.map(m => `<option value="${m}">${m} ä»£å¢Š</option>`).join('');
            const grid = document.getElementById('involvedGrid');
            if (grid.innerHTML === "") grid.innerHTML = members.map(m => `<label class="flex items-center gap-1 p-2 bg-slate-50 rounded-xl border border-transparent has-[:checked]:border-indigo-600 has-[:checked]:bg-indigo-50"><input type="checkbox" checked value="${m}" class="m-check w-3 h-3 accent-indigo-600"><span class="font-bold text-slate-700 text-[10px] truncate">${m}</span></label>`).join('');
            const catSel = document.getElementById('expCategory'); if (catSel.innerHTML === "") catSel.innerHTML = Object.keys(emojis).map(k => `<option value="${k}">${emojis[k]} ${k}</option>`).join('');
            const depM = document.getElementById('depMember'); depM.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function saveExpense() {
            if (isSettled) return;
            const data = { id: editingId || Date.now(), date: document.getElementById('expDate').value, category: document.getElementById('expCategory').value, desc: document.getElementById('expDesc').value, amount: parseFloat(document.getElementById('expAmount').value), paid_by: document.getElementById('expPayer').value, inv: Array.from(document.querySelectorAll('.m-check:checked')).map(el => el.value) };
            if (!data.date || !data.desc || isNaN(data.amount) || data.inv.length === 0) return alert("è³‡æ–™ä¸å…¨");
            if (editingId) { const idx = expenses.findIndex(e => e.id === editingId); expenses[idx] = data; } else { expenses.push(data); }
            resetForm(); pushData();
        }

        function editExp(id) { const e = expenses.find(x => x.id === id); editingId = id; document.getElementById('formTitle').querySelector('span').innerText = "ğŸ“ ç·¨è¼¯ä¸­..."; document.getElementById('cancelEdit').classList.remove('hidden'); document.getElementById('expDate').value = e.date; document.getElementById('expDesc').value = e.desc; document.getElementById('expAmount').value = e.amount; document.getElementById('expCategory').value = e.category; document.getElementById('expPayer').value = e.paid_by; document.querySelectorAll('.m-check').forEach(ck => ck.checked = e.inv.includes(ck.value)); window.scrollTo({ top: 100, behavior: 'smooth' }); }
        function editDep(id) { const d = deposits.find(x => x.id === id); editingDepId = id; document.getElementById('depDate').value = d.date; document.getElementById('depAmount').value = d.amount; document.getElementById('depEditTag').classList.remove('hidden'); document.getElementById('depNormalBtns').classList.add('hidden'); document.getElementById('depEditBtns').classList.remove('hidden'); document.getElementById('depositBox').open = true; }
        function saveDepEdit() { const idx = deposits.findIndex(x => x.id === editingDepId); deposits[idx].date = document.getElementById('depDate').value; deposits[idx].amount = parseFloat(document.getElementById('depAmount').value); pushData(); resetDepForm(); }
        function resetDepForm() { editingDepId = null; document.getElementById('depEditTag').classList.add('hidden'); document.getElementById('depNormalBtns').classList.remove('hidden'); document.getElementById('depEditBtns').classList.add('hidden'); }
        function delExp(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { expenses = expenses.filter(x => x.id !== id); pushData(); } }
        function delDep(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { deposits = deposits.filter(x => x.id.toString() !== id.toString()); pushData(); } }
        function resetForm() { editingId = null; document.getElementById('formTitle').querySelector('span').innerText = "æ–°å¢æ”¯å‡ºé …ç›®"; document.getElementById('expDesc').value = ""; document.getElementById('expAmount').value = ""; document.getElementById('cancelEdit').classList.add('hidden'); }
        function pushData() { const input = document.getElementById('memberInput').value; members = input.split(',').map(s => s.trim()).filter(s => s !== ""); managerPass = document.getElementById('adminPassInput').value || "1234"; db.ref('rooms/' + roomId).update({ members, expenses, deposits, manager, managerPass, isSettled }); }
        
        function calculate() {
            if (!members.length) return;
            const paid = {}, consumed = {}, bal = {};
            members.forEach(m => { paid[m] = 0; consumed[m] = 0; bal[m] = 0; });
            let totalFSpent = 0, totalDep = 0;
            deposits.forEach(d => { if (d.from === "å…¨å“¡") { members.forEach(m => paid[m] += d.amount); totalDep += d.amount * members.length; } else if(paid[d.from]!==undefined) { paid[d.from] += d.amount; totalDep += d.amount; } });
            expenses.forEach(e => { const per = e.amount / e.inv.length; if (e.paid_by === "å…¬å¸³") totalFSpent += e.amount; else if(paid[e.paid_by]!==undefined) paid[e.paid_by] += e.amount; e.inv.forEach(m => { if(consumed[m]!==undefined) consumed[m] += per; }); });
            document.getElementById('fundBalance').innerText = `$${Math.round(totalDep - totalFSpent)}`;
            members.forEach(m => bal[m] = paid[m] - consumed[m]);
            if (manager && bal[manager] !== undefined) bal[manager] -= (totalDep - totalFSpent);
            document.getElementById('balanceAudit').innerHTML = members.map(m => { const diff = paid[m] - consumed[m]; return `<div class="grid grid-cols-4 text-center text-[10px] font-bold py-1 border-b border-white/5"><span class="text-left truncate">${m}</span><span>${Math.round(paid[m])}</span><span>${Math.round(consumed[m])}</span><span class="${diff > 0.5 ? 'text-emerald-400' : (diff < -0.5 ? 'text-rose-400' : 'opacity-20')}">${Math.round(diff)}</span></div>`; }).join('');
            let cr = [], dbts = [], splits = [];
            Object.keys(bal).forEach(m => { if (bal[m] > 0.5) cr.push({ n: m, v: bal[m] }); else if (bal[m] < -0.5) dbts.push({ n: m, v: Math.abs(bal[m]) }); });
            let i = 0, j = 0;
            while (i < dbts.length && j < cr.length) { let a = Math.min(dbts[i].v, cr[j].v); if (a > 0.5) splits.push(`<div class="flex justify-between items-center bg-white/5 p-2.5 rounded-xl border border-white/10"><div class="text-[11px] font-bold text-white">${dbts[i].n} â†’ ${cr[j].n}</div><span class="text-yellow-400 font-mono font-black text-base">$${Math.round(a)}</span></div>`); dbts[i].v -= a; cr[j].v -= a; if (dbts[i].v <= 0.5) i++; if (cr[j].v <= 0.5) j++; }
            document.getElementById('splitResult').innerHTML = splits.join('') || "<div class='text-center py-6 text-[10px] opacity-30 italic'>âœ¨ å¸³ç›®å¹³è¡¡</div>";
        }

        function lockMyIdentity() {
            const user = document.getElementById('currentUser').value; if (!user) return alert("è«‹å…ˆé¸æ“‡å§“å");
            if (!manager) { if (confirm(`æˆç‚ºç®¡ç†å“¡ï¼Ÿ`)) { manager = user; completeLock(user); } }
            else if (user === manager) { const inputPass = prompt(`ç®¡ç†æš—è™Ÿï¼š`); if (inputPass === managerPass) completeLock(user); else alert("ç®¡ç†å¯†ç¢¼éŒ¯èª¤"); }
            else { if (confirm(`é–å®šç‚ºã€Œ${user}ã€ï¼Ÿ`)) completeLock(user); }
        }
        function completeLock(user) { localStorage.setItem(`locked_user_${roomId}`, user); pushData(); updateUI(); }
        function logout() { localStorage.removeItem(`locked_user_${roomId}`); location.reload(); }
        function toggleSettlement() { isSettled = !isSettled; pushData(); }
        function exportCSV() { let csv = "\ufeffæ—¥æœŸ,é …ç›®,é‡‘é¡,æ”¯ä»˜è€…,åˆ†æ”¤è€…\n"; expenses.forEach(e => csv += `${e.date},${e.desc},${e.amount},${e.paid_by},"${e.inv.join('/')}"\n`); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `çµç®—_${roomId}.csv`; a.click(); }
        function clearAll() { if (confirm("ç¢ºå®šåˆªé™¤æ‰€æœ‰å¸³ç›®ï¼Ÿ")) { db.ref('rooms/' + roomId).remove().then(() => { localStorage.removeItem(`locked_user_${roomId}`); location.reload(); }); } }
        window.onload = () => { const now = new Date().toISOString().split('T')[0]; document.getElementById('expDate').value = now; document.getElementById('depDate').value = now; const savedId = localStorage.getItem('saved_room_id'); if (savedId) { document.getElementById('roomId').value = savedId; document.getElementById('rememberId').checked = true; } };
    </script>
</body>
</html>
