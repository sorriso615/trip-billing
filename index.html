<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripSplit 2026 å°ˆæ¥­äº’å‹•è¨˜å¸³ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 14. å­—é«”è¦ç¯„ */
        :root { font-size: 16px; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; font-size: 16px; }
        input, select, button, p, span, div { font-size: 16px; }
        
        /* 14. æ—¥æœŸåŠ å¤§å½©è‰²æ¨™ç¤º */
        .date-header { font-size: 1.4rem !important; font-weight: 900; color: #1e40af; background: #dbeafe; padding: 4px 12px; border-radius: 8px; margin-top: 15px; display: inline-block; }

        /* 3. éŸ¿æ‡‰å¼ä½ˆå±€ 450px:1fr */
        @media (min-width: 1024px) {
            .app-container { display: grid; grid-template-columns: 450px 1fr; gap: 24px; }
            .sticky-panel { position: sticky; top: 20px; height: calc(100vh - 40px); overflow-y: auto; }
        }

        /* é ç±¤é¡è‰²èˆ‡æ¨£å¼ (4, 5, 6, 7, 8, 9, 10, 11) */
        .tab-purple { border: 2px solid #a855f7 !important; border-left: 8px solid #a855f7 !important; }
        .tab-darkgrey { border: 2px solid #4b5563 !important; border-left: 8px solid #4b5563 !important; }
        .tab-red { border: 2px solid #ef4444 !important; border-left: 8px solid #ef4444 !important; }
        .tab-orange { border: 2px solid #f97316 !important; border-left: 8px solid #f97316 !important; }
        .tab-yellow { border: 2px solid #eab308 !important; border-left: 8px solid #eab308 !important; }
        .tab-green { border: 2px solid #22c55e !important; border-left: 8px solid #22c55e !important; }
        .tab-blue { border: 2px solid #3b82f6 !important; border-left: 8px solid #3b82f6 !important; }

        details > summary { list-style: none; cursor: pointer; padding: 15px; font-weight: bold; background: white; border-radius: 8px; transition: 0.3s; }
        details[open] > summary { border-bottom: 1px solid #eee; border-radius: 8px 8px 0 0; }
        
        .currency-active { background-color: #3b82f6 !important; color: white !important; transform: scale(1.05); }
        .sealed-mode .btn-edit, .sealed-mode .btn-delete, .sealed-mode .btn-submit { display: none !important; }
        
        /* 2. é¤˜é¡å­—é«”é¡¯ç¤º */
        .balance-text { font-size: 2.2rem; font-weight: 900; color: #f59e0b; }
        .income-text { color: #10b981; }
        .expense-text { color: #ef4444; }

        /* åˆ—è¡¨æ˜ç´°å­—é«” (14) */
        .detail-item { font-size: 1.15rem; }
        .sub-detail { font-size: 0.95rem; color: #64748b; }
/* ä¿®æ­£æ‰‹æ©Ÿç‰ˆé ç±¤æ“ åœ¨ä¸€èµ·çš„å•é¡Œ */
@media (max-width: 1024px) {
    .flex.gap-2.mb-6.overflow-x-auto {
        gap: 12px !important; /* å¼·åˆ¶å¢åŠ æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
        padding-bottom: 8px;  /* å¢åŠ åº•éƒ¨ç©ºé–“é˜²æ­¢è²¼é½Šå…§å®¹ */
    }

    /* å¦‚æœæ‚¨çš„æŒ‰éˆ•æ˜¯ç”¨ flex ä½ˆå±€ï¼Œé€™æ¨£å¯ä»¥ç¢ºä¿å®ƒå€‘å‡åˆ†æˆ–ç•™æœ‰å‘¼å¸ç©ºé–“ */
    .flex.gap-2.mb-6 button {
        white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ›è¡Œ */
        margin-right: 4px;   /* é¡å¤–çš„å³å´é–“è· */
    }
}

    </style>
</head>
<body class="p-4 lg:p-6" lang="zh-TW">

<div id="app">
    <section id="login-page" class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-2xl mt-10">
        <h1 class="text-3xl font-black text-center mb-8 text-indigo-700">TripSplit 2026 æ—…éŠè¨˜å¸³</h1>
        
        <div class="space-y-4">
            <input type="text" id="login-id" class="w-full p-4 border-2 rounded-xl focus:border-indigo-500 outline-none" placeholder="å¸³ç°¿ ID (LocalStorage è¨˜æ†¶)">
            <input type="password" id="login-pass" class="w-full p-4 border-2 rounded-xl" placeholder="å¸³ç°¿å¯†ç¢¼">
            
            <div id="new-book-zone" class="hidden p-6 bg-slate-50 border-2 border-dashed rounded-2xl space-y-4">
                <p class="text-indigo-600 font-bold">âœ¨ å»ºç«‹æ–°å¸³ç°¿ï¼š</p>
                <input type="text" id="new-members" class="w-full p-3 border rounded-lg" placeholder="æˆå“¡åå–® (ä¾‹å¦‚: é˜¿å¼·,å°æ˜,ç¾ç¾ï¼Œé¦–ä½ç‚ºç®¡ç†å“¡)">
                <input type="text" id="new-foreign-name" class="w-full p-3 border rounded-lg" placeholder="è¨­ç½®å¤–å¹£åç¨± (ä¾‹å¦‚: æ—¥å¹£, USD)">
                <input type="password" id="secure-code" class="w-full p-3 border-2 border-red-300 rounded-lg" placeholder="å®‰å…¨å¯†ç¢¼ (å»ºç«‹æ–°å¸³ç°¿æ™‚ï¼Œè«‹è¼¸å…¥å®‰å…¨é©—è­‰ç¢¼å³å¯é–‹å§‹ä½¿ç”¨)">
                <button onclick="createNewBook()" class="w-full bg-indigo-600 text-white p-4 rounded-xl font-bold hover:bg-indigo-700">ç¢ºèªé–‹æ–°å¸³ç°¿</button>
            </div>

            <div id="identity-zone" class="hidden space-y-4 border-t pt-6">
                <p class="text-sm font-bold text-slate-500">é¸æ“‡æ‚¨çš„èº«åˆ†ï¼š</p>
                <select id="user-select" class="w-full p-4 border-2 rounded-xl font-bold bg-yellow-50"></select>
                <div id="admin-pass-input-box" class="hidden">
                    <input type="password" id="admin-login-pass" class="w-full p-4 border-2 border-purple-400 rounded-xl" placeholder="ç®¡ç†å“¡å°ˆå±¬å¯†ç¢¼">
                </div>
                <button onclick="lockIdentityAndEnter()" class="w-full bg-indigo-600 text-white p-5 rounded-xl font-black text-xl shadow-lg">é–å®šèº«åˆ†ä¸¦é€²å…¥å¸³ç°¿</button>
            </div>

            <button id="check-id-btn" onclick="checkBookExist()" class="w-full bg-slate-800 text-white p-4 rounded-xl font-bold">é€²å…¥å¸³ç°¿</button>
        </div>

        <details class="mt-12 border-t pt-6">
            <summary class="text-center text-slate-400">ğŸ“– é»æ“Šå±•é–‹åŠŸèƒ½èˆ‡ä½¿ç”¨èªªæ˜</summary>
            <div class="p-4 text-slate-600 leading-relaxed space-y-3">
                <p>â— <span class="text-indigo-600 font-bold">ã€å®‰å…¨æ€§ã€‘</span> å»ºç«‹æ–°å¸³ç°¿éœ€è¼¸å…¥é©—è­‰ç¢¼ <code class="bg-red-100 px-1">ã€‚åå–®ç¬¬ä¸€ä½è‡ªå‹•è¨­ç‚º<span class="text-purple-600 font-bold">ç®¡ç†å“¡</span>ã€‚</p>
                <p>â— <span class="text-orange-600 font-bold">ã€æ”¯ä»˜æ¨¡å¼ã€‘</span> åˆ†ç‚ºã€Œå…¬å¸³ã€èˆ‡ã€Œå€‹äººä»£å¢Šã€ã€‚<span class="text-red-600 font-bold">å…¬å¸³</span>åƒ…é™ç®¡ç†å“¡æ”¯ç”¨ï¼›<span class="text-green-600 font-bold">å€‹äººä»£å¢Š</span>ç”±æˆå“¡å¢Šä»˜å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•è¨ˆç®—åˆ†å¸³å‚µå‹™ã€‚</p>
                <p>â— <span class="text-blue-600 font-bold">ã€çµç®—å°å­˜ã€‘</span> ç®¡ç†å“¡åŸ·è¡Œå°å­˜å¾Œï¼Œæ‰€æœ‰å¸³ç›®æŒ‰éˆ•å°‡æ¶ˆå¤±ï¼Œé˜²æ­¢çµç®—å¾Œå†æ¬¡è®Šå‹•æ•¸æ“šã€‚</p>
            </div>
        </details>
    </section>

    <main id="main-content" class="hidden">
        <header class="bg-white p-6 rounded-2xl shadow-lg mb-6 sticky top-0 z-50">
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                <div class="flex gap-2 w-full lg:w-auto">
                    <button id="btn-twd" onclick="switchCurrency('TWD')" class="flex-1 lg:flex-none px-10 py-4 rounded-xl font-bold border-2 currency-active">å°å¹£ TWD</button>
                    <button id="btn-sub" onclick="switchCurrency('SUB')" class="flex-1 lg:flex-none px-10 py-4 rounded-xl font-bold border-2 bg-white text-slate-400">å¤–å¹£ <span id="display-sub-name"></span></button>
                </div>
                <div class="flex items-center gap-4">
                    <span id="display-user" class="font-black text-lg text-slate-700"></span>
                    <button onclick="logout()" class="text-sm text-red-500 underline">ç™»å‡ºæ›´æ›èº«åˆ†</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6 border-t pt-6 text-center">
                <div><p class="font-bold text-slate-500">å…¬å¸³æ”¶å…¥ (+)</p><p id="sum-income" class="income-text font-black text-2xl">0</p></div>
                <div><p class="font-bold text-slate-500">å…¬å¸³æ”¯å‡º (-)</p><p id="sum-expense" class="expense-text font-black text-2xl">0</p></div>
                <div><p class="font-bold text-slate-500">å‰©é¤˜å…¬å¸³é¤˜é¡</p><p id="sum-balance" class="balance-text">0</p></div>
            </div>
        </header>

        <div class="app-container">
            <aside class="sticky-panel space-y-4">
                <details open class="tab-purple bg-white rounded-xl shadow-md overflow-hidden">
                    <summary id="tab-add-title">æ–°å¢æ”¯å‡º(å°å¹£)</summary>
                    <div class="p-4 space-y-4">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="date" id="exp-date" class="p-3 border rounded-lg w-full">
                            <select id="exp-cat" class="p-3 border rounded-lg">
                                <option>ğŸ³ æ—©é¤</option><option>ğŸ± åˆé¤</option><option>ğŸ² æ™šé¤</option>
                                <option>ğŸª é»å¿ƒ</option><option>ğŸ¥¤ é£²æ–™</option><option>ğŸš— äº¤é€š</option>
                                <option>ğŸ¨ ä½å®¿</option><option>ğŸ›ï¸ è³¼ç‰©</option><option>ğŸ·ï¸ å…¶ä»–</option>
                            </select>
                        </div>
                        <input type="text" id="exp-title" class="w-full p-4 border rounded-xl" placeholder="æ¶ˆè²»å…§å®¹ (ä¾‹å¦‚: æ‹‰éºµ)" lang="zh-TW">
                        <input type="number" id="exp-amt" class="w-full p-4 border rounded-xl text-2xl font-black text-indigo-600" placeholder="é‡‘é¡">
                        
                        <div class="bg-slate-50 p-4 rounded-xl border">
                            <label class="text-xs font-bold text-slate-400">æ”¯ä»˜è·¯å¾‘ï¼š</label>
                            <select id="exp-path" class="w-full p-3 border rounded-lg mt-2" onchange="togglePayerSelection()">
                                <option value="public" id="opt-public-pay">ğŸ’° å…¬å¸³æ”¯ä»˜ (é™ç®¡ç†å“¡)</option>
                                <option value="advance">ğŸ‘¤ å€‹äººä»£å¢Š</option>
                            </select>
                            <div id="payer-select-div" class="hidden mt-3">
                                <label class="text-xs font-bold">ä»£å¢Šæˆå“¡ï¼š</label>
                                <select id="payer-member" class="w-full p-3 border rounded-lg"></select>
                            </div>
                        </div>

                        <div class="border-t pt-3">
                            <p class="text-xs font-bold text-slate-400 mb-3">åˆ†å¸³æˆå“¡ (å¯å‹¾é¸)ï¼š</p>
                            <div id="splitters-grid" class="grid grid-cols-3 gap-2"></div>
                        </div>

                        <button onclick="addRecord()" class="btn-submit w-full bg-purple-600 text-white py-4 rounded-xl font-black text-xl shadow-lg">ç¢ºèªé€å‡ºå¸³ç›®</button>
                    </div>
                </details>

                <details id="admin-fund-tab" class="tab-darkgrey bg-white rounded-xl shadow-md overflow-hidden hidden">
                    <summary>ğŸ’° å…¬å¸³é ç¹³ (ç®¡ç†å“¡å°ˆå€)</summary>
                    <div class="p-4 space-y-4">
                        <input type="date" id="fund-date" class="w-full p-3 border rounded-lg">
                        <input type="number" id="fund-amt" class="w-full p-4 border rounded-xl font-black" placeholder="å…¨å“¡æ¯äººé ç¹³é‡‘é¡">
                        <button onclick="addFundRecord()" class="btn-submit w-full bg-slate-800 text-white py-4 rounded-xl font-bold">å…¨å“¡é ç¹³å…¥å¸³</button>
                    </div>
                </details>

                <details id="admin-setting-tab" class="tab-darkgrey bg-white rounded-xl shadow-md overflow-hidden hidden">
                    <summary>âš™ï¸ è³‡æ–™è¨­å®š (ç®¡ç†å“¡å°ˆå€)</summary>
                    <div class="p-4 space-y-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold">ç·¨ä¿®æˆå“¡åå–® (é€—è™Ÿéš”é–‹)ï¼š</label>
                            <input type="text" id="set-members" class="w-full p-2 border rounded">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="space-y-2">
                                <label class="text-xs font-bold">å¤–å¹£åç¨±ï¼š</label>
                                <input type="text" id="set-sub-name" class="w-full p-2 border rounded">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold">åŒ¯ç‡ (1å¤–å¹£=?å°å¹£)ï¼š</label>
                                <input type="number" id="set-rate" class="w-full p-2 border rounded" step="0.001">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="space-y-2">
                                <label class="text-xs font-bold">å¸³ç°¿å¯†ç¢¼ï¼š</label>
                                <input type="password" id="set-book-pass" class="w-full p-2 border rounded">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold">ç®¡ç†å“¡å¯†ç¢¼ï¼š</label>
                                <input type="password" id="set-admin-pass" class="w-full p-2 border rounded">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold">ç®¡ç†æ¬Šè½‰ç§»ï¼š</label>
                            <select id="set-manager" class="w-full p-2 border rounded"></select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="updateSettings()" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-bold">ç¢ºèªä¿®æ”¹è¨­å®š</button>
                            <button onclick="deleteAllData()" class="bg-red-100 text-red-600 px-4 rounded-lg font-bold">å…¨æ¸…</button>
                        </div>
                    </div>
                </details>
            </aside>

            <section class="space-y-6">
                <details class="tab-red bg-white rounded-xl shadow-md overflow-hidden">
                    <summary>ğŸ“Š å€‹äººçµç®—æµæ°´å¸³</summary>
                    <div class="p-4">
                        <div class="flex gap-1 mb-4 bg-slate-100 p-1 rounded-lg">
                            <button onclick="switchLedgerTab('pub')" id="lt-pub" class="flex-1 py-2 rounded-md font-bold bg-white shadow-sm">å…¬å¸³å¾€ä¾†</button>
                            <button onclick="switchLedgerTab('adv')" id="lt-adv" class="flex-1 py-2 rounded-md font-bold text-slate-500">å€‹äººä»£å¢Š</button>
                        </div>
                        <div class="flex justify-end mb-2">
                            <button onclick="toggleSort()" class="text-xs bg-slate-200 px-3 py-1 rounded-full">åˆ‡æ›æ—¥æœŸæ’åº</button>
                        </div>
                        <div id="ledger-content" class="space-y-2"></div>
                    </div>
                </details>

                <details class="tab-orange bg-white rounded-xl shadow-md overflow-hidden">
                    <summary>ğŸ’° å…¬å¸³æ”¶å…¥æ˜ç´°</summary>
<div class="p-2 border-b text-right"><button onclick="toggleSort()" class="text-xs bg-slate-200 px-3 py-1 rounded-full">åˆ‡æ›æ—¥æœŸæ’åº</button></div>
                    <div id="income-list" class="p-4"></div>
                </details>

                <details class="tab-yellow bg-white rounded-xl shadow-md overflow-hidden">
                    <summary>ğŸ’¸ å…¬å¸³æ”¯ä»˜æ˜ç´°</summary>
<div class="p-2 border-b text-right"><button onclick="toggleSort()" class="text-xs bg-slate-200 px-3 py-1 rounded-full">åˆ‡æ›æ—¥æœŸæ’åº</button></div>
                    <div id="public-exp-list" class="p-4"></div>
                </details>

                <details class="tab-green bg-white rounded-xl shadow-md overflow-hidden">
                    <summary>ğŸ¤ å€‹äººä»£å¢Šæ˜ç´°</summary>
                    <div class="p-4">
                        <div class="flex gap-1 mb-4 bg-slate-100 p-1 rounded-lg">
                            <button onclick="switchAdvSubTab('all')" id="at-all" class="px-6 py-2 rounded-md font-bold bg-white shadow-sm">å…¨éƒ¨æ˜ç´°</button>
                            <button onclick="switchAdvSubTab('me')" id="at-me" class="...">èˆ‡æˆ‘ç›¸é—œ</button>
<button onclick="toggleSort()" class="ml-auto text-xs bg-white px-3 py-1 rounded shadow-sm">åˆ‡æ›æ—¥æœŸæ’åº</button>
                        </div>
                        <div id="adv-list" class="p-4"></div>
                    </div>
                </details>

                <details class="tab-blue bg-white rounded-xl shadow-md overflow-hidden">
                    <summary>ğŸ æœ€çµ‚çµç®—å ±å‘Š</summary>
                    <div class="p-4 space-y-6">
                        <div class="flex gap-1 bg-slate-100 p-1 rounded-lg">
                            <button onclick="switchSettleMode('TWD')" id="sm-twd" class="flex-1 py-2 rounded-md font-bold bg-white">å°å¹£</button>
                            <button onclick="switchSettleMode('SUB')" id="sm-sub" class="flex-1 py-2 rounded-md font-bold">å¤–å¹£</button>
                            <button onclick="switchSettleMode('MIX')" id="sm-mix" class="flex-1 py-2 rounded-md font-bold">åŒ¯ç‡åˆä½µ (MIX)</button>
                        </div>
                        <div id="settle-content" class="bg-blue-50 p-6 rounded-2xl border-2 border-blue-100 min-h-[200px]"></div>
                        <div id="seal-admin-zone" class="hidden text-center border-t pt-6">
                            <button id="btn-seal" onclick="toggleSeal()" class="bg-red-600 text-white px-10 py-4 rounded-full font-black shadow-xl">å•Ÿå‹•çµç®—å°å­˜</button>
                        </div>
                    </div>
                </details>
            </section>
        </div>
    </main>
</div>

<script>
/** 12. è³‡å®‰é˜²è­· **/
const safe = (str) => String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

/** æ ¸å¿ƒè³‡æ–™åº«çµæ§‹ **/
let db = {
    id: "", pass: "", members: [], manager: "", adminPass: "",
    subName: "å¤–å¹£", rate: 1.0, isSealed: false,
    items: [] // {id, date, cat, title, amt, cur, type(public/advance/fund), payer, splitters[]}
};

let currentUser = "";
let currentCur = "TWD";
let LMode = "pub"; // æµæ°´å¸³åˆ†é 
let ASubMode = "all"; // ä»£å¢Šæ˜ç´°åˆ†é 
let SMode = "TWD"; // çµç®—åˆ†é 
let sortDesc = true;

window.onload = () => {
    const lastId = localStorage.getItem('ts_last_id');
    if (lastId) document.getElementById('login-id').value = lastId;
    document.getElementById('exp-date').valueAsDate = new Date();
    document.getElementById('fund-date').valueAsDate = new Date();
};

/** 1. ç™»å…¥é‚è¼¯ **/
function checkBookExist() {
    const id = document.getElementById('login-id').value;
    if (!id) return alert("è«‹è¼¸å…¥å¸³ç°¿ ID");
    const saved = localStorage.getItem(`ts_book_${id}`);
    
    if (saved) {
        db = JSON.parse(saved);
        document.getElementById('new-book-zone').classList.add('hidden');
        document.getElementById('identity-zone').classList.remove('hidden');
        document.getElementById('check-id-btn').classList.add('hidden');
        renderUserSelect();
    } else {
        document.getElementById('new-book-zone').classList.remove('hidden');
        document.getElementById('identity-zone').classList.add('hidden');
        document.getElementById('check-id-btn').classList.add('hidden');
    }
}

function createNewBook() {
    const id = document.getElementById('login-id').value;
    const pass = document.getElementById('login-pass').value;
    const membersRaw = document.getElementById('new-members').value;
    const sc = document.getElementById('secure-code').value;

    if (!id || !pass || !membersRaw) return alert("æˆå“¡åå–®èˆ‡å¸³ç°¿è³‡è¨Šç‚ºå¿…å¡«ï¼");
    if (sc !== 'djes.tyc-2026') return alert("å®‰å…¨é©—è­‰ç¢¼éŒ¯èª¤ï¼");

    db.id = id;
    db.pass = pass;
    db.members = membersRaw.split(/[,ï¼Œ]/).map(m => m.trim()).filter(m => m);
    db.manager = db.members[0];
    db.subName = document.getElementById('new-foreign-name').value || "å¤–å¹£";
    
    save();
    alert("å¸³ç°¿å»ºç«‹æˆåŠŸï¼");
    checkBookExist();
}

function renderUserSelect() {
    const sel = document.getElementById('user-select');
    sel.innerHTML = db.members.map(m => `<option value="${m}">${m}</option>`).join('');
    const lastUser = localStorage.getItem(`ts_last_user_${db.id}`);
    if (lastUser) sel.value = lastUser;
    
    sel.onchange = () => {
        document.getElementById('admin-pass-input-box').classList.toggle('hidden', sel.value !== db.manager || !db.adminPass);
    };
    sel.onchange();
}

function lockIdentityAndEnter() {
    const selected = document.getElementById('user-select').value;
    const passInput = document.getElementById('login-pass').value;

    if (passInput !== db.pass) return alert("å¸³ç°¿å¯†ç¢¼éŒ¯èª¤ï¼");

    if (selected === db.manager) {
        if (!db.adminPass) {
            const p = prompt("é¦–æ¬¡ä»¥ç®¡ç†å“¡èº«åˆ†ç™»å…¥ï¼Œè«‹è¨­å®šã€Œç®¡ç†å“¡å¯†ç¢¼ã€ï¼š");
            if (!p) return;
            db.adminPass = p;
            save();
        } else {
            if (document.getElementById('admin-login-pass').value !== db.adminPass) return alert("ç®¡ç†å“¡å¯†ç¢¼éŒ¯èª¤ï¼");
        }
    }

    currentUser = selected;
    localStorage.setItem('ts_last_id', db.id);
    localStorage.setItem(`ts_last_user_${db.id}`, currentUser);
    initApp();
}

/** 2. æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ– **/
function initApp() {
    document.getElementById('login-page').classList.add('hidden');
    document.getElementById('main-content').classList.remove('hidden');
    document.getElementById('display-user').innerText = `ğŸ‘¤ ${currentUser} ${currentUser === db.manager ? '(ç®¡ç†å“¡)' : ''}`;
    document.getElementById('display-sub-name').innerText = db.subName;

    // åˆå§‹åŒ–è¼¸å…¥é¸å–®
    document.getElementById('payer-member').innerHTML = db.members.map(m => `<option value="${m}">${m}</option>`).join('');
    document.getElementById('splitters-grid').innerHTML = db.members.map(m => `
        <label class="flex items-center gap-1 p-2 bg-slate-50 rounded border">
            <input type="checkbox" value="${m}" checked> ${safe(m)}
        </label>
    `).join('');

    if (currentUser === db.manager) {
        document.getElementById('admin-fund-tab').classList.remove('hidden');
        document.getElementById('admin-setting-tab').classList.remove('hidden');
        document.getElementById('seal-admin-zone').classList.remove('hidden');
        document.getElementById('opt-public-pay').disabled = false;
        
        // è¨­å®šå€é å¡«
        document.getElementById('set-members').value = db.members.join(',');
        document.getElementById('set-sub-name').value = db.subName;
        document.getElementById('set-rate').value = db.rate;
        document.getElementById('set-book-pass').value = db.pass;
        document.getElementById('set-admin-pass').value = db.adminPass;
        document.getElementById('set-manager').innerHTML = db.members.map(m => `<option value="${m}" ${m===db.manager?'selected':''}>${m}</option>`).join('');
    } else {
        document.getElementById('opt-public-pay').disabled = true;
        document.getElementById('exp-path').value = "advance";
        togglePayerSelection();
    }

    refreshUI();
}

/** æ ¸å¿ƒè¨ˆç®—èˆ‡æ¸²æŸ“ (13, 14, 15) **/
function refreshUI() {
    if (!db.id) return; // ä¿®æ­£ï¼šå°‡ currentBookId æ”¹ç‚º db.id
    save(); 

    // 1. è¨ˆç®—å…¬å¸³ç¸½æ”¶å…¥ (é ç¹³)
    const totalIncome = db.items
        .filter(i => i.type === 'fund' && i.cur === currentCur)
        .reduce((sum, i) => sum + i.amt, 0);

    // 2. è¨ˆç®—å…¬å¸³ç¸½æ”¯å‡º
    const totalSpend = db.items
        .filter(i => i.type === 'public' && i.cur === currentCur)
        .reduce((sum, i) => sum + i.amt, 0);

    // 3. æ›´æ–°ä¸Šæ–¹å¡ç‰‡æ•¸å­— (å°æ‡‰æ‚¨ HTML ä¸­çš„ sum-income, sum-expense, sum-balance)
    document.getElementById('sum-income').innerText = `$${Math.round(totalIncome)}`;
    document.getElementById('sum-expense').innerText = `$${Math.round(totalSpend)}`;
    document.getElementById('sum-balance').innerText = `$${Math.round(totalIncome - totalSpend)}`;

    // 4. é‡æ–°æ¸²æŸ“æ‰€æœ‰åˆ—è¡¨
    renderIncomeList();
    renderPublicExpList(); // ä¿®æ­£ï¼šæ‚¨çš„æª”æ¡ˆåç¨±æ˜¯é€™å€‹
    renderAdvList();
    renderLedger();
    renderSettleReport();
}

/** 4, 5. è¼¸å…¥åŠŸèƒ½ **/
function addRecord() {
    if (db.isSealed) return;
    const amt = parseFloat(document.getElementById('exp-amt').value);
    const title = document.getElementById('exp-title').value;
    const date = document.getElementById('exp-date').value;
    const splitters = Array.from(document.querySelectorAll('#splitters-grid input:checked')).map(i => i.value);

    if (!amt || !title || !date || splitters.length === 0) return alert("è³‡æ–™è¼¸å…¥ä¸å®Œæ•´ï¼");

    const path = document.getElementById('exp-path').value;
    const payer = (path === 'public') ? 'å…¬å¸³' : document.getElementById('payer-member').value;

    db.items.push({
        id: Date.now(),
        date, cat: document.getElementById('exp-cat').value,
        title: safe(title),
        amt, cur: currentCur,
        type: path, payer, splitters
    });

    save(); refreshUI();
    document.getElementById('exp-amt').value = "";
    document.getElementById('exp-title').value = "";
}

function addFundRecord() {
    if (db.isSealed) return;
    const perAmt = parseFloat(document.getElementById('fund-amt').value);
    const date = document.getElementById('fund-date').value;
    if (!perAmt || !date) return alert("è«‹è¼¸å…¥é ç¹³é‡‘é¡èˆ‡æ—¥æœŸ");

    // çµ±ä¸€é‚è¼¯ï¼šamt å­˜å„²ã€Œç¸½é‡‘é¡ã€
    db.items.push({
        id: Date.now(),
        date, cat: "ğŸ’°", title: "å…¨å“¡å…¬å¸³é ç¹³",
        amt: perAmt * db.members.length, // é€™è£å­˜ç¸½é¡ï¼šæ¯äºº200 * 8äºº = 1600
        cur: currentCur,
        type: 'fund', payer: "å…¨å“¡", splitters: [...db.members]
    });

    save(); refreshUI();
    document.getElementById('fund-amt').value = "";
}

/** 6. å€‹äººçµç®—æµæ°´å¸³ (æ ¸å¿ƒ) **/
function renderLedger() {
    const list = db.items.filter(i => i.cur === currentCur).sort(sortFn);
    let html = "";

    if (LMode === 'pub') {
        let plusHtml = ""; let minusHtml = "";
        let plusSum = 0; let minusSum = 0;

        list.forEach(i => {
            if (i.type === 'fund' && i.splitters.includes(currentUser)) {
                const myShare = i.amt / i.splitters.length;
                plusHtml += `<div class="flex justify-between text-sm py-1 border-b"><span>${i.date} é ç¹³å…¬å¸³</span><span class="text-green-600">+$${Math.round(myShare)}</span></div>`;
                plusSum += myShare;
            }
            if (i.type === 'public' && i.splitters.includes(currentUser)) {
                const myShare = i.amt / i.splitters.length;
                minusHtml += `<div class="flex justify-between text-sm py-1 border-b"><span>${i.date} ${i.title}</span><span class="text-red-600">-$${Math.round(myShare)}</span></div>`;
                minusSum += myShare;
            }
        });
        html = `
            <div class="p-3 bg-green-50 rounded-lg">
                <p class="font-bold text-green-700">é ç¹³å…¬å¸³ (+)</p>${plusHtml || '<p class="text-xs text-slate-400">ç„¡ç´€éŒ„</p>'}
                <p class="text-right font-black mt-1">å°è¨ˆ: $${Math.round(plusSum)}</p>
            </div>
            <div class="p-3 bg-red-50 rounded-lg mt-3">
                <p class="font-bold text-red-700">å…¬å¸³åˆ†æ”¤ (-)</p>${minusHtml || '<p class="text-xs text-slate-400">ç„¡ç´€éŒ„</p>'}
                <p class="text-right font-black mt-1">å°è¨ˆ: $${Math.round(minusSum)}</p>
            </div>
            <div class="text-center p-4 bg-slate-800 text-yellow-400 rounded-xl mt-4 font-black text-xl">
                æœ€çµ‚çµé¤˜: $${Math.round(plusSum - minusSum)}
            </div>
        `;
    } else {
        let plusHtml = ""; let minusHtml = "";
        let plusSum = 0; let minusSum = 0;

        list.forEach(i => {
            if (i.type === 'advance') {
                const share = i.amt / i.splitters.length;
                if (i.payer === currentUser) {
                    plusHtml += `<div class="flex justify-between text-sm py-1 border-b"><span>${i.date} ${i.title}</span><span class="text-blue-600">+$${Math.round(i.amt)}</span></div>`;
                    plusSum += i.amt;
                } 
                if (i.splitters.includes(currentUser)) {
                    minusHtml += `<div class="flex justify-between text-sm py-1 border-b"><span>${i.date} ${i.title} (${i.payer}å¢Š)</span><span class="text-orange-600">-$${Math.round(share)}</span></div>`;
                    minusSum += share;
                }
            }
        });
        html = `
            <div class="p-3 bg-blue-50 rounded-lg">
                <p class="font-bold text-blue-700">æˆ‘çš„ä»£å¢Š (+)</p>${plusHtml || '<p class="text-xs text-slate-400">ç„¡ç´€éŒ„</p>'}
                <p class="text-right font-black mt-1">å°è¨ˆ: $${Math.round(plusSum)}</p>
            </div>
            <div class="p-3 bg-orange-50 rounded-lg mt-3">
                <p class="font-bold text-orange-700">ä»£å¢Šåˆ†å¸³ (-)</p>${minusHtml || '<p class="text-xs text-slate-400">ç„¡ç´€éŒ„</p>'}
                <p class="text-right font-black mt-1">å°è¨ˆ: $${Math.round(minusSum)}</p>
            </div>
            <div class="text-center p-4 bg-slate-800 text-yellow-400 rounded-xl mt-4 font-black text-xl">
                æœ€çµ‚çµé¤˜: $${Math.round(plusSum - minusSum)}
            </div>
        `;
    }
    document.getElementById('ledger-content').innerHTML = html;
}

/** 7, 8, 9. å„é …æ˜ç´°æ¸²æŸ“ **/
function renderIncomeList() {
    const list = db.items.filter(i => i.type === 'fund' && i.cur === currentCur).sort(sortFn);
    let html = ""; let lastDate = "";
    list.forEach(i => {
        if(i.date !== lastDate) { html += `<div class="date-header">${i.date}</div>`; lastDate = i.date; }
        
        const perAmt = Math.round(i.amt / i.splitters.length);
        const totalAmt = Math.round(i.amt);
        
        html += `
           <div class="flex justify-between items-center p-4 bg-white border-b hover:bg-slate-50">
                <div class="detail-item">
                    <span class="text-slate-500 text-sm">${i.cat} ${i.title}</span>
                    <div class="font-bold text-lg text-slate-800">${perAmt}/äºº</div>
                </div>
                <div class="text-right">
                    <div class="font-black text-2xl text-green-600">$${totalAmt}</div>
                    <div class="flex justify-end gap-3 mt-1">
                        ${currentUser === db.manager ? `
                            <button onclick="editItem(${i.id})" class="text-blue-500 text-sm font-medium">[ç·¨ä¿®]</button>
                            <button onclick="deleteItem(${i.id})" class="text-red-400 text-sm font-medium">åˆªé™¤</button>
                        ` : ""}
                    </div>
                </div>
            </div>
        `;
    });
    document.getElementById('income-list').innerHTML = html || "<p class='p-4 text-slate-400'>æš«ç„¡é ç¹³è³‡æ–™</p>";
}

function renderPublicExpList() {
    const list = db.items.filter(i => i.type === 'public' && i.cur === currentCur).sort(sortFn);
    let html = ""; let lastDate = "";
    list.forEach(i => {
        const share = (i.amt / i.splitters.length).toFixed(0);
        if(i.date !== lastDate) { html += `<div class="date-header">${i.date}</div>`; lastDate = i.date; }
        html += `
            <div class="flex justify-between items-center p-4 bg-white border-b">
                <div class="detail-item">
                    <span class="text-slate-500 text-sm">${i.cat} ${i.title}</span>
                    <div class="font-bold text-lg text-slate-800">${share}/äºº</div>
                </div>
                <div class="text-right">
                    <div class="font-black text-2xl text-red-600">$${Math.round(i.amt)}</div>
                    ${currentUser === db.manager ? `<button onclick="editItem(${i.id})" class="text-blue-500 btn-edit mr-3">[ç·¨ä¿®]</button><button onclick="deleteItem(${i.id})" class="text-red-500 btn-delete">åˆªé™¤</button>` : ""}
                </div>
            </div>
        `;
    });
    document.getElementById('public-exp-list').innerHTML = html || "<p class='p-4 text-slate-400'>æš«ç„¡å…¬å¸³æ”¯å‡º</p>";
}

function renderAdvList() {
    // ä¿®æ­£ï¼šä½¿ç”¨ ASubMode é€²è¡Œç¯©é¸
    let list = db.items.filter(i => i.type === 'advance' && i.cur === currentCur);
    if (ASubMode === 'me') {
        list = list.filter(i => i.payer === currentUser || i.splitters.includes(currentUser));
    }
    list.sort(sortFn);

    // ä¿®æ­£ï¼šæŒ‰éˆ•å‘¼å« switchAdvSubTab ä¸¦åŒæ­¥ ASubMode ç‹€æ…‹
    let html = "";
    let lastDate = "";
    list.forEach(i => {
        if(i.date !== lastDate) { html += `<div class="date-header">${i.date}</div>`; lastDate = i.date; }
        const perAmt = Math.round(i.amt / i.splitters.length);
        
        html += `
            <div class="flex justify-between items-center p-4 bg-white border-b hover:bg-slate-50">
                <div class="detail-item">
                    <div class="text-slate-500 text-sm mb-1">${i.cat} ${i.title}</div>
                    <div class="text-xs text-slate-400">ä»£å¢Šï¼š${i.payer} | åˆ†å¸³ï¼š${i.splitters.join(', ')}</div>
                    <div class="font-bold text-lg text-slate-800">${perAmt}/äºº</div>
                </div>
                <div class="text-right">
                    <div class="font-black text-2xl text-red-600">$${Math.round(i.amt)}</div>
                    <div class="flex justify-end gap-3 mt-1">
                        ${currentUser === db.manager ? `
                            <button onclick="editItem(${i.id})" class="text-blue-500 text-sm font-medium">[ç·¨ä¿®]</button>
                            <button onclick="deleteItem(${i.id})" class="text-red-400 text-sm font-medium">åˆªé™¤</button>
                        ` : ""}
                    </div>
                </div>
            </div>
        `;
    });
    document.getElementById('adv-list').innerHTML = html || "<p class='p-4 text-slate-400'>æš«ç„¡ä»£å¢Šç´€éŒ„</p>";
}


/** 10. æœ€çµ‚çµç®—å ±å‘Š (ç®¡ç†å“¡é€€æ¬¾é‚è¼¯ç‰ˆ) **/
function renderSettleReport() {
    const results = {};
    const members = db.members;
    const managerName = db.manager || members[0]; // é è¨­ç¬¬ä¸€å€‹æˆå“¡ç‚ºç®¡ç†å“¡
    
    members.forEach(m => results[m] = { totalPaid: 0, totalCost: 0 });

    db.items.forEach(i => {
        let val = i.amt;
        if (SMode === 'MIX' && i.cur === 'SUB') val = i.amt * db.rate;
        if (SMode === 'TWD' && i.cur !== 'TWD') return;
        if (SMode === 'SUB' && i.cur !== 'SUB') return;

        if (i.type === 'fund') {
            const perFund = val / i.splitters.length;
            i.splitters.forEach(m => { if(results[m]) results[m].totalPaid += perFund; });
        } else if (i.type === 'public') {
            const share = val / i.splitters.length;
            i.splitters.forEach(m => { if(results[m]) results[m].totalCost += share; });
        } else if (i.type === 'advance') {
            if(results[i.payer]) results[i.payer].totalPaid += val;
            const share = val / i.splitters.length;
            i.splitters.forEach(m => { if(results[m]) results[m].totalCost += share; });
        }
    });

    // 1. å»ºç«‹å ±è¡¨è¡¨æ ¼
    let html = `
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-slate-100 text-slate-600">
                    <tr>
                        <th class="p-2">æˆå“¡</th>
                        <th class="p-2 text-right">ç¸½ä»˜å‡º(+)</th>
                        <th class="p-2 text-right">ç¸½æ”¯å‡º(-)</th>
                        <th class="p-2 text-right">æœ€çµ‚çµé¤˜</th>
                    </tr>
                </thead>
                <tbody>`;
    
    const netArr = [];
    members.forEach(m => {
        const bal = results[m].totalPaid - results[m].totalCost;
        netArr.push({ name: m, bal: bal });
        html += `
            <tr class="border-b">
                <td class="p-2 font-bold">${m} ${m === managerName ? '<span class="text-xs bg-orange-100 text-orange-600 px-1 rounded">ä¿ç®¡äºº</span>' : ''}</td>
                <td class="p-2 text-right text-green-600">$${Math.round(results[m].totalPaid)}</td>
                <td class="p-2 text-right text-red-600">$${Math.round(results[m].totalCost)}</td>
                <td class="p-2 text-right font-black ${bal >= 0 ? 'text-blue-600' : 'text-orange-600'}">
                    ${bal >= 0 ? '+' : ''}${Math.round(bal)}
                </td>
            </tr>`;
    });
    html += `</tbody></table></div>`;

    // 2. è¨ˆç®—æ”¯ä»˜æ¸…å–® (åŒ…å«ç®¡ç†å“¡é€€å…¬å¸³é‚è¼¯)
    html += `
        <div class="mt-6 p-4 bg-indigo-50 rounded-xl border border-indigo-100">
            <p class="font-black text-indigo-800 mb-3 underline">ğŸ’¸ çµæ¸…æ”¯ä»˜æŒ‡ä»¤ï¼š</p>
            <div class="space-y-2">`;
    
    // æ‡‰æ”¶æ¬¾çš„äºº (çµé¤˜ > 0)
    let receivers = netArr.filter(n => n.bal > 0.5).sort((a,b) => b.bal - a.bal);
    // æ‡‰ä»˜æ¬¾çš„äºº (çµé¤˜ < 0)
    let payers = netArr.filter(n => n.bal < -0.5).map(n => ({...n, bal: Math.abs(n.bal)})).sort((a,b) => b.bal - a.bal);

    let logs = [];

    // å…ˆè®“æ¬ éŒ¢çš„äºº (Payers) æŠŠéŒ¢çµ¦ æ‡‰æ”¶æ¬¾çš„äºº (Receivers)
    payers.forEach(p => {
        receivers.forEach(r => {
            if (p.bal <= 0 || r.bal <= 0) return;
            let transfer = Math.min(p.bal, r.bal);
            logs.push(`ğŸ“ <b>${p.name}</b> â¡ï¸ çµ¦ <b>${r.name}</b>ï¼š<span class="text-blue-700 font-bold">$${Math.round(transfer)}</span>`);
            p.bal -= transfer;
            r.bal -= transfer;
        });
    });

    // å¦‚æœæœ€å¾Œé‚„æœ‰ Receivers æ²’æ‹¿åˆ°éŒ¢ï¼Œä¸” Payers éƒ½ä»˜æ¸…äº†ï¼Œå‰©ä¸‹çš„éŒ¢å°±æ˜¯å¾ã€Œå…¬å¸³é¤˜é¡ã€å‡º (ç”±ç®¡ç†å“¡æ”¯ä»˜)
    receivers.forEach(r => {
        if (r.bal > 0.5 && r.name !== managerName) {
            logs.push(`ğŸ¦ <b>${managerName} (é€€å…¬å¸³)</b> â¡ï¸ çµ¦ <b>${r.name}</b>ï¼š<span class="text-green-700 font-bold">$${Math.round(r.bal)}</span>`);
        }
    });

    html += logs.length ? logs.map(l => `<div class="bg-white p-2 rounded shadow-sm border-l-4 border-blue-400 text-sm">${l}</div>`).join('') : "<p class='text-slate-400 italic text-center'>å¸³ç›®å·²å¹³è¡¡</p>";
    html += `</div></div>`;

    document.getElementById('settle-content').innerHTML = html;
}


/** åŠŸèƒ½è¼”åŠ©å‡½æ•¸ **/
function save() { localStorage.setItem(`ts_book_${db.id}`, JSON.stringify(db)); }
function logout() { location.reload(); }
function switchCurrency(c) {
    currentCur = c;
    document.getElementById('btn-twd').className = c==='TWD' ? 'flex-1 lg:flex-none px-10 py-4 rounded-xl font-bold border-2 currency-active' : 'flex-1 lg:flex-none px-10 py-4 rounded-xl font-bold border-2 bg-white';
    document.getElementById('btn-sub').className = c==='SUB' ? 'flex-1 lg:flex-none px-10 py-4 rounded-xl font-bold border-2 currency-active' : 'flex-1 lg:flex-none px-10 py-4 rounded-xl font-bold border-2 bg-white';
    refreshUI();
}
function togglePayerSelection() {
    document.getElementById('payer-select-div').classList.toggle('hidden', document.getElementById('exp-path').value === 'public');
}
function switchLedgerTab(m) { LMode = m; document.getElementById('lt-pub').className = m==='pub'?'flex-1 py-2 rounded-md font-bold bg-white shadow-sm':'flex-1 py-2 rounded-md font-bold text-slate-500'; document.getElementById('lt-adv').className = m==='adv'?'flex-1 py-2 rounded-md font-bold bg-white shadow-sm':'flex-1 py-2 rounded-md font-bold text-slate-500'; renderLedger(); }
function switchAdvSubTab(m) { ASubMode = m; document.getElementById('at-all').className = m==='all'?'px-6 py-2 rounded-md font-bold bg-white shadow-sm':'px-6 py-2 rounded-md font-bold text-slate-500'; document.getElementById('at-me').className = m==='me'?'px-6 py-2 rounded-md font-bold bg-white shadow-sm':'px-6 py-2 rounded-md font-bold text-slate-500'; renderAdvList(); }
function switchSettleMode(m) { SMode = m; document.getElementById('sm-twd').className = m==='TWD'?'flex-1 py-2 rounded-md font-bold bg-white':'flex-1 py-2 rounded-md font-bold'; document.getElementById('sm-sub').className = m==='SUB'?'flex-1 py-2 rounded-md font-bold bg-white':'flex-1 py-2 rounded-md font-bold'; document.getElementById('sm-mix').className = m==='MIX'?'flex-1 py-2 rounded-md font-bold bg-white':'flex-1 py-2 rounded-md font-bold'; renderSettleReport(); }
function toggleSort() { sortDesc = !sortDesc; refreshUI(); }
function sortFn(a, b) { return sortDesc ? new Date(b.date) - new Date(a.date) : new Date(a.date) - new Date(b.date); }

function deleteItem(id) {
    if (db.isSealed) return;
    if (confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™ç­†å¸³ç›®å—ï¼Ÿ") && confirm("ğŸ“¢ é€™æ˜¯ç¬¬äºŒæ¬¡ç¢ºèªï¼šåˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸï¼")) {
        db.items = db.items.filter(i => i.id !== id);
        save(); refreshUI();
    }
}

function editItem(id) {
    if (db.isSealed) return;
    const item = db.items.find(i => i.id == id); // æ³¨æ„é€™è£¡ç”¨ == ç›¸å®¹æ•¸å­—æˆ–å­—ä¸² ID
    if (!item) return;

    // 1. ä¿®æ”¹å…§å®¹
    const newTitle = prompt("è«‹è¼¸å…¥ä¿®æ”¹å¾Œçš„å…§å®¹ï¼š", item.title);
    if (newTitle !== null) item.title = safe(newTitle);

    // 2. ä¿®æ”¹æ—¥æœŸ (æ–°å¢åŠŸèƒ½)
    const newDate = prompt("è«‹è¼¸å…¥æ—¥æœŸ (æ ¼å¼: YYYY/MM/DD)ï¼š", item.date || "");
    if (newDate !== null) item.date = newDate;

    // 3. è™•ç†é‡‘é¡é€£å‹•
    if (item.type === 'fund') {
        const currentPerAmt = item.amt / item.splitters.length;
        const newPerAmt = prompt("ç›®å‰æ¯äººé ç¹³ $" + currentPerAmt + "ï¼Œè«‹è¼¸å…¥ã€Œæ–°æ¯äººé‡‘é¡ã€ï¼š", currentPerAmt);
        
        if (newPerAmt !== null) {
            const perAmtValue = parseFloat(newPerAmt);
            // é€£å‹•æ ¸å¿ƒï¼šç¸½é‡‘é¡ = æ¯äººé‡‘é¡ * äººæ•¸
            item.amt = perAmtValue * item.splitters.length;
        }
    } else {
        const newAmt = prompt("è«‹è¼¸å…¥ä¿®æ”¹å¾Œçš„ç¸½é‡‘é¡ï¼š", item.amt);
        if (newAmt !== null) item.amt = parseFloat(newAmt);
    }

    save(); 
    refreshUI();
}

function updateSettings() {
    db.members = document.getElementById('set-members').value.split(/[,ï¼Œ]/).map(m => m.trim()).filter(m => m);
    db.subName = document.getElementById('set-sub-name').value;
    db.rate = parseFloat(document.getElementById('set-rate').value);
    db.pass = document.getElementById('set-book-pass').value;
    db.adminPass = document.getElementById('set-admin-pass').value;
    db.manager = document.getElementById('set-manager').value;
    save(); alert("è¨­å®šå·²æ›´æ–°ï¼"); initApp();
}

function toggleSeal() {
    if (confirm(`ç¢ºå®šè¦${db.isSealed ? 'è§£é™¤' : 'åŸ·è¡Œ'}çµç®—å°å­˜å—ï¼Ÿ${db.isSealed ? '' : 'å°å­˜å¾Œå°‡ä¸å¯ç·¨ä¿®å¸³ç›®ï¼'}`)) {
        db.isSealed = !db.isSealed;
        save(); refreshUI();
    }
}

function deleteAllData() {
    if (confirm("ğŸ§¨ ç¢ºå®šè¦åˆªé™¤ã€Œæ•´æœ¬å¸³ç°¿ã€æ‰€æœ‰è³‡æ–™å—ï¼Ÿ") && confirm("äºŒæ¬¡ç¢ºèªï¼šé€™æœƒæ¸…ç©ºæ‰€æœ‰æ­·å²ç´€éŒ„ä¸”ä¸å¯æ¢å¾©ï¼")) {
        db.items = []; save(); refreshUI();
    }
}
</script>
</body>
</html>
