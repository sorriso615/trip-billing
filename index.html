<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripSplit v62.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto+Sans+TC', sans-serif; background-color: #f8fafc; }
        .is-locked { background-color: #f1f5f9 !important; cursor: not-allowed; color: #94a3b8 !important; }
        .admin-hidden { display: none !important; }
        summary { list-style: none; cursor: pointer; }
        .dropdown-card { background: white; border-radius: 1.25rem; overflow: hidden; border: 1px solid #e2e8f0; margin-bottom: 0.75rem; }
        .dropdown-summary { padding: 1.25rem 1rem; font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
        .compact-input { padding: 0.75rem !important; font-size: 0.875rem !important; border-radius: 1rem !important; }
        .btn-action { font-size: 10px; font-weight: 800; padding: 3px 8px; border-radius: 6px; margin-left: 4px; }
        
        /* æ—¥æœŸåˆ†çµ„æ¨£å¼ */
        .date-divider { position: relative; text-align: left; margin: 1.5rem 0 0.75rem 0.5rem; }
        .date-label { background: #6366f1; color: white; padding: 2px 10px; border-radius: 20px; font-size: 10px; font-weight: 900; letter-spacing: 1px; }

        @media (min-width: 1024px) { .desktop-grid { display: grid; grid-template-columns: 450px 1fr; gap: 2rem; align-items: start; } .sticky-form { position: sticky; top: 20px; } }
    </style>
</head>
<body class="p-3 pb-24 lg:p-8">

    <div class="max-w-6xl mx-auto">
        <div id="loginSection" class="max-w-xl mx-auto space-y-4">
            <div class="bg-indigo-700 p-8 rounded-[2rem] shadow-2xl text-white">
                <h1 class="text-4xl font-black text-center mb-8 italic text-yellow-400 tracking-tighter">TripSplit</h1>
                <div class="space-y-4">
                    <input type="text" id="roomId" class="w-full p-4 rounded-2xl text-black font-bold text-center outline-none" placeholder="æˆ¿é–“ ID">
                    <input type="password" id="roomPass" class="w-full p-4 rounded-2xl text-black font-bold text-center outline-none" placeholder="é€²å…¥æš—è™Ÿ">
                    <button onclick="handleAuth('login')" class="w-full bg-yellow-400 text-indigo-900 p-4 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-all">é€²å…¥å¸³ç°¿</button>
                    <button onclick="handleAuth('create')" class="w-full bg-indigo-800 text-indigo-100 p-3 rounded-2xl font-bold text-xs opacity-70">å»ºç«‹å…¨æ–°æˆ¿é–“</button>
                    <div class="flex items-center justify-center gap-2 py-2">
                        <input type="checkbox" id="rememberId" class="w-5 h-5 accent-yellow-400 cursor-pointer">
                        <label for="rememberId" class="font-bold text-sm cursor-pointer">è¨˜ä½æˆ¿é–“ ID</label>
                    </div>
                </div>
            </div>

            <details class="dropdown-card border-l-8 border-sky-400">
                <summary class="dropdown-summary text-sky-800 bg-sky-50"><span>ğŸš€ è©³ç›¡ä½¿ç”¨èªªæ˜ (v56.1 ç‰ˆ)</span><span>âŠ•</span></summary>
                <div class="p-5 text-[13px] text-slate-600 space-y-4 leading-relaxed font-medium">
                    <p>1ï¸âƒ£ <strong class="text-sky-700">æˆå“¡èˆ‡ç®¡ç†ï¼š</strong>é€²å…¥å¾Œè«‹ç®¡ç†å“¡å„ªå…ˆæ–¼ä¸‹æ–¹ã€Œè¨­å®šã€ä¸­è¼¸å…¥æˆå“¡åå–®ä¸¦é»æ“Šã€Œå„²å­˜è¨­å®šã€ã€‚</p>
                    <p>2ï¸âƒ£ <strong class="text-sky-700">é–å®šèº«ä»½ï¼š</strong>å³ä¸Šè§’é¸æ“‡å§“åå¾Œé»æ“Šã€Œé–å®šèº«ä»½ã€ã€‚é–å®šå¾Œå³å¯é–‹å§‹æ–°å¢å¸³ç›®ã€‚ç®¡ç†å“¡é–å®šéœ€é©—è­‰ç®¡ç†å¯†ç¢¼ã€‚</p>
                    <p>3ï¸âƒ£ <strong class="text-sky-700">å…¬å¸³æ“ä½œï¼š</strong>å…¬å¸³æ”¶å…¥ï¼ˆé ç¹³ï¼‰åƒ…é™ç®¡ç†å“¡æ“ä½œã€‚æ”¯å‡ºæ™‚å¯é¸æ“‡ç”±ã€Œå…¬å¸³ã€æ”¯ä»˜æˆ–å€‹äººã€Œä»£å¢Šã€ã€‚</p>
                    <p>4ï¸âƒ£ <strong class="text-sky-700">åŒ¯ç‡åŠŸèƒ½ï¼š</strong>è‹¥æœ‰å¤–å¹£éœ€æ±‚ï¼Œè«‹åœ¨ä¸‹æ–¹è¨­å®šå¤–å¹£åç¨±ï¼Œä¸¦åœ¨çµç®—å€è¼¸å…¥åŒ¯ç‡ï¼ˆ1 å¤–å¹£ = å¤šå°‘å°å¹£ï¼‰ã€‚</p>
                    <p>5ï¸âƒ£ <strong class="text-sky-700">æœ€çµ‚çµç®—ï¼š</strong>æ”¯æ´ã€Œå°å¹£ã€å¤–å¹£ã€åˆä½µã€ä¸‰ç¨®å ±è¡¨ï¼Œç³»çµ±æœƒè‡ªå‹•ç®—å‡ºèª°è©²åŒ¯éŒ¢çµ¦èª°ï¼Œé”åˆ°å¸³ç›®å¹³è¡¡ã€‚</p>
                </div>
            </details>
        </div>

        <div id="mainUI" class="hidden">
            <div id="settledBanner" class="hidden bg-rose-600 text-white text-center py-2 rounded-xl mb-4 font-black text-sm animate-pulse">ğŸ ç¸½çµç®—å·²å•Ÿå‹• Â· å¸³ç›®å°å­˜ä¸­</div>

            <div class="bg-slate-900 text-white p-5 rounded-[2.5rem] shadow-xl border-b-8 border-emerald-500 mb-6">
                <div class="flex justify-between items-start mb-5">
                    <div>
                        <p class="text-[10px] opacity-50 font-black uppercase italic tracking-widest mb-1">Public Balance</p>
                        <p id="fundBalance" class="text-4xl font-mono font-black text-yellow-400 tracking-tighter">$0</p>
                    </div>
                    <div class="text-right flex flex-col items-end gap-2">
                        <div class="flex items-center gap-2">
                            <select id="currentUser" class="bg-slate-800 text-white font-bold text-xs rounded-xl p-2 outline-none border border-slate-700"></select>
                            <button id="btnLockUser" onclick="lockMyIdentity()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-black text-[11px] shadow-lg">é–å®šèº«ä»½</button>
                        </div>
                        <div id="lockBadge" class="hidden text-emerald-400 font-black text-[10px] flex items-center gap-1"><span>â— ONLINE</span> <span id="displayUserName"></span> <button onclick="logout()" class="text-slate-500 underline ml-2">ç™»å‡º</button></div>
                    </div>
                </div>
                <div class="flex gap-2 bg-slate-800/50 p-1.5 rounded-2xl">
                    <button id="btnSwitchTWD" onclick="changeCurrentCurrency('TWD')" class="flex-1 py-2.5 rounded-xl font-black text-xs transition-all">TWD</button>
                    <button id="btnSwitchSUB" onclick="changeCurrentCurrency('SUB')" class="flex-1 py-2.5 rounded-xl font-black text-xs transition-all">å¤–å¹£</button>
                </div>
            </div>

            <div class="desktop-grid">
                <div class="sticky-form space-y-4">
                    <div id="expenseFormBox" class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200">
                        <h2 id="formTitle" class="font-black text-lg text-slate-800 mb-5 border-l-4 border-indigo-500 pl-4 flex justify-between items-center">
                            <span>æ–°å¢æ”¯å‡º (<span class="cur-text">TWD</span>)</span>
                            <button id="cancelEdit" onclick="resetForm()" class="hidden text-xs bg-rose-100 text-rose-500 px-3 py-1 rounded-full">å–æ¶ˆ</button>
                        </h2>
                        <div class="space-y-4">
                            <div class="flex gap-2"><input type="date" id="expDate" class="w-1/2 compact-input bg-slate-50 border-none font-bold"><select id="expCategory" class="w-1/2 compact-input bg-slate-50 border-none font-bold"></select></div>
                            <input type="text" id="expDesc" placeholder="æ¶ˆè²»å…§å®¹" class="w-full compact-input bg-slate-50 border-none font-bold">
                            <div class="flex gap-2"><input type="number" id="expAmount" placeholder="é‡‘é¡" class="w-1/2 compact-input bg-indigo-50 font-black text-indigo-700 text-lg"><select id="expPayer" class="w-1/2 compact-input bg-indigo-50 font-bold text-indigo-700"></select></div>
                            <div id="involvedGrid" class="grid grid-cols-3 gap-2 py-2"></div>
                            <button id="submitBtn" onclick="saveExpense()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-black text-xl shadow-xl active:scale-95 transition-all opacity-50 pointer-events-none">ç¢ºèª</button>
                        </div>
                    </div>

                    <details id="depositBox" class="admin-hidden dropdown-card border-l-8 border-amber-400">
                        <summary class="dropdown-summary text-amber-800"><span>ğŸ“¥ å…¬å¸³æ”¶å…¥ç®¡ç†</span><span>âŠ•</span></summary>
                        <div class="p-4 space-y-3">
                            <div class="flex gap-2"><input type="date" id="depDate" class="w-1/2 compact-input bg-slate-50 border"><input type="number" id="depAmount" class="w-1/2 compact-input text-center font-black bg-slate-50 border" placeholder="é‡‘é¡"></div>
                            <button onclick="addBulkDep()" class="w-full bg-amber-500 text-white p-3 rounded-xl font-black text-xs shadow-md">å…¨å“¡å„é ç¹³ä¸€ä»½</button>
                            <div class="flex gap-2"><select id="depMember" class="flex-1 p-2 border rounded-xl text-xs font-bold"></select><button onclick="addSingleDep()" class="bg-slate-800 text-white px-4 rounded-xl font-bold text-xs">å–®äººè£œç¹³</button></div>
                        </div>
                    </details>
                </div>

                <div class="space-y-4">
                    <details class="dropdown-card border-l-8 border-amber-200"><summary class="dropdown-summary">ğŸ“’ å…¬å¸³æ”¶å…¥æ˜ç´° <span>â–¼</span></summary><div id="incomeTimeline" class="p-4 pt-0"></div></details>
                    <details class="dropdown-card border-l-8 border-emerald-400"><summary class="dropdown-summary">ğŸ’° å…¬å¸³æ”¯ä»˜æ˜ç´° <span>â–¼</span></summary><div id="publicTimeline" class="p-4 pt-0"></div></details>
                    <details class="dropdown-card border-l-8 border-indigo-400"><summary class="dropdown-summary">ğŸ‘¤ å€‹äººä»£å¢Šæ˜ç´° <span>â–¼</span></summary><div id="personalTimeline" class="p-4 pt-0"></div></details>

                    <details class="dropdown-card border-l-8 border-slate-900 bg-slate-900 text-white">
                        <summary class="dropdown-summary text-yellow-400"><span class="font-black italic">ğŸ æœ€çµ‚çµç®—å ±å‘Š</span><span>â–¼</span></summary>
                        <div class="p-4 pt-0">
                            <div class="flex gap-1 mb-4 bg-white/5 p-1 rounded-xl">
                                <button onclick="setSettleMode('TWD')" id="btnSettleTWD" class="flex-1 py-2 rounded-lg font-black text-[11px]">å°å¹£å€</button>
                                <button onclick="setSettleMode('SUB')" id="btnSettleSUB" class="flex-1 py-2 rounded-lg font-black text-[11px]">å¤–å¹£å€</button>
                                <button onclick="setSettleMode('MIX')" id="btnSettleMIX" class="flex-1 py-2 rounded-lg font-black text-[11px]">åˆä½µçµç®—</button>
                            </div>
                            <div id="rateZone" class="hidden bg-indigo-900/50 p-4 rounded-2xl mb-4 border border-indigo-500/30 flex items-center justify-between">
                                <span class="text-xs font-black text-indigo-200 uppercase tracking-tighter">1 <span id="mixCurName">JPY</span> =</span>
                                <input type="number" id="manualRate" step="0.0001" class="w-28 p-2 bg-white text-indigo-900 rounded-xl font-black text-center outline-none" onchange="pushData()">
                            </div>
                            <div id="balanceAudit" class="bg-white/10 rounded-2xl p-4 mb-4 space-y-2 text-xs"></div>
                            <div id="splitResult" class="space-y-2 mb-6"></div>
                            <div id="adminSettleZone" class="admin-hidden border-t border-white/10 pt-4"><button onclick="toggleSettlement()" class="w-full bg-rose-500/20 text-rose-300 p-3 rounded-xl font-black text-xs border border-rose-500/30">å•Ÿå‹•/è§£é™¤çµç®—å°å­˜</button></div>
                        </div>
                    </details>

                    <details id="adminMemberSettings" class="dropdown-card border-l-8 border-slate-400 bg-slate-50">
                        <summary class="dropdown-summary text-slate-700"><span>âš™ï¸ ç®¡ç†å“¡èˆ‡æˆ¿é–“è¨­å®š</span><span>âŠ•</span></summary>
                        <div class="p-5 space-y-5">
                            <div id="initNotice" class="hidden bg-amber-100 p-3 rounded-xl border border-amber-200 text-[11px] font-bold text-amber-700 italic">åˆå§‹åŒ–ä¸­ï¼šè«‹å…ˆè¼¸å…¥åå–®ã€å„²å­˜è¨­å®šå¾Œé–å®šèº«ä»½ã€‚</div>
                            <div><label class="text-[10px] font-bold text-slate-400 block mb-1">æˆå“¡åå–® (ä»¥é€—è™Ÿåˆ†éš”)</label><input type="text" id="memberInput" class="w-full p-3 bg-white border rounded-xl font-bold text-sm"></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-[10px] font-bold text-slate-400 block mb-1">æˆ¿é–“å¯†ç¢¼</label><input type="text" id="roomPassInput" class="w-full p-3 bg-white border rounded-xl font-bold text-sm"></div>
                                <div><label class="text-[10px] font-bold text-slate-400 block mb-1">ç®¡ç†å¯†ç¢¼</label><input type="text" id="adminPassInput" class="w-full p-3 bg-white border rounded-xl font-bold text-sm"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-[10px] font-bold text-slate-400 block mb-1 text-indigo-600">ğŸ‘‘ æ›´æ›ç®¡ç†å“¡</label><select id="newAdminSelect" class="w-full p-3 bg-indigo-50 border border-indigo-100 rounded-xl font-black text-indigo-700 text-sm"></select></div>
                                <div><label class="text-[10px] font-bold text-slate-400 block mb-1">å¤–å¹£åç¨±</label><input type="text" id="subCurrencyInput" class="w-full p-3 bg-white border rounded-xl font-bold text-sm"></div>
                            </div>
                            <button onclick="confirmAdminSettings()" class="w-full bg-slate-800 text-white p-4 rounded-2xl font-black text-sm shadow-xl active:scale-95 transition-all">å„²å­˜ä¸¦å¥—ç”¨è¨­å®š</button>
                        </div>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://project-2641836624074325409-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let members = [], expenses = [], deposits = [], manager = "", managerPass = "1234", roomId = "", roomPass = "", currentRate = 1;
        let isSettled = false, currentCurrency = "TWD", subCurrency = "å¤–å¹£", settleMode = "TWD", editingId = null;
        const emojis = { "æ—©é¤":"ğŸ³", "åˆé¤":"ğŸ±", "æ™šé¤":"ğŸ½ï¸", "é»å¿ƒ":"ğŸ°", "äº¤é€š":"ğŸš—", "ä½å®¿":"ğŸ¨", "è³¼ç‰©":"ğŸ›ï¸", "å…¶ä»–":"ğŸ·ï¸" };

        async function handleAuth(mode) {
            const rid = document.getElementById('roomId').value.trim();
            const rps = document.getElementById('roomPass').value.trim();
            if (!rid || !rps) return alert("è«‹è¼¸å…¥ ID èˆ‡æš—è™Ÿ");
            const snap = await db.ref('rooms/' + rid).once('value');
            const data = snap.val();
            if (mode === 'login') {
                if (!data || data.password !== rps) return alert("é€²å…¥æš—è™ŸéŒ¯èª¤");
                roomId = rid; roomPass = rps; startSync();
            } else {
                if (data) return alert("ID å·²å­˜åœ¨");
                roomId = rid; roomPass = rps;
                await db.ref('rooms/' + rid).set({ password: rps, manager: "", managerPass: "1234", isSettled: false, members: ["è«‹å…ˆè¨­å®šåå–®"], subCurrency: "JPY", rate: 1 });
                startSync();
            }
        }

        function startSync() {
            if (document.getElementById('rememberId').checked) localStorage.setItem('saved_room_id', roomId);
            db.ref('rooms/' + roomId).on('value', (snap) => {
                const data = snap.val(); if (!data) return;
                members = data.members || []; expenses = data.expenses || []; deposits = data.deposits || [];
                manager = data.manager || ""; managerPass = data.managerPass || "1234";
                subCurrency = data.subCurrency || "å¤–å¹£"; roomPass = data.password || "";
                currentRate = data.rate || 1; isSettled = data.isSettled || false;
                updateUI();
            });
        }

        function updateUI() {
            document.getElementById('mainUI').classList.remove('hidden');
            document.getElementById('loginSection').classList.add('hidden');
            document.querySelectorAll('.cur-text').forEach(el => el.innerText = currentCurrency);
            document.getElementById('btnSwitchSUB').innerText = subCurrency;
            document.getElementById('mixCurName').innerText = subCurrency;
            document.getElementById('roomPassInput').value = roomPass;
            document.getElementById('adminPassInput').value = managerPass;
            document.getElementById('subCurrencyInput').value = subCurrency;
            document.getElementById('manualRate').value = currentRate;
            document.getElementById('settledBanner').classList.toggle('hidden', !isSettled);

            const isValid = members.length > 0 && members[0] !== "è«‹å…ˆè¨­å®šåå–®";
            document.getElementById('memberInput').value = isValid ? members.join(', ') : "";
            document.getElementById('initNotice').classList.toggle('hidden', manager !== "");
            
            const savedU = localStorage.getItem(`locked_user_${roomId}`);
            const isAdmin = (manager === "" || savedU === manager);
            document.querySelectorAll('.admin-hidden').forEach(el => isAdmin ? el.classList.remove('admin-hidden') : el.classList.add('admin-hidden'));
            document.getElementById('adminMemberSettings').classList.toggle('admin-hidden', !isAdmin);

            const uSel = document.getElementById('currentUser');
            uSel.innerHTML = isValid ? `<option value="">-- æˆ‘æ˜¯ --</option>` + members.map(m => `<option value="${m}" ${m===savedU?'selected':''}>${m}</option>`).join('') : `<option value="">è«‹å…ˆè¨­å®šåå–®</option>`;
            
            const sBtn = document.getElementById('submitBtn');
            if (savedU && members.includes(savedU)) {
                uSel.disabled = true; uSel.classList.add('is-locked');
                document.getElementById('btnLockUser').classList.add('hidden');
                document.getElementById('lockBadge').classList.remove('hidden');
                document.getElementById('displayUserName').innerText = savedU;
                sBtn.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                uSel.disabled = false; uSel.classList.remove('is-locked');
                document.getElementById('btnLockUser').classList.remove('hidden');
                document.getElementById('lockBadge').classList.add('hidden');
                sBtn.classList.add('opacity-50', 'pointer-events-none');
            }

            const admSel = document.getElementById('newAdminSelect');
            admSel.innerHTML = `<option value="">-- ä¿æŒä¸è®Š --</option>` + members.map(m => `<option value="${m}" ${m===manager?'selected':''}>${m}</option>`).join('');

            updateForm(); 
            renderDateGroupedTimeline('incomeTimeline', deposits.filter(d => d.currency === currentCurrency || (!d.currency && currentCurrency === "TWD")), 'deposit');
            renderDateGroupedTimeline('publicTimeline', expenses.filter(e => e.paid_by === "å…¬å¸³" && (e.currency === currentCurrency || (!e.currency && currentCurrency === "TWD"))), 'expense');
            renderPersonalTimelineGrouped();
            calculate();
            setSettleMode(settleMode);
        }

        // æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ï¼šæŒ‰æ—¥æœŸåˆ†çµ„
        function renderDateGroupedTimeline(containerId, dataList, type) {
            const container = document.getElementById(containerId), user = localStorage.getItem(`locked_user_${roomId}`);
            container.innerHTML = "";
            if (!dataList.length) { container.innerHTML = `<p class='text-center py-6 text-xs text-slate-300 italic'>å°šç„¡è³‡æ–™</p>`; return; }

            // æŒ‰æ—¥æœŸé™åºæ’åº
            const sorted = [...dataList].sort((a,b) => new Date(b.date) - new Date(a.date));
            let currentDate = "";

            sorted.forEach(item => {
                if (item.date !== currentDate) {
                    currentDate = item.date;
                    container.innerHTML += `<div class="date-divider"><span class="date-label">${currentDate}</span></div>`;
                }
                
                if (type === 'deposit') {
                    container.innerHTML += `<div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center border border-slate-100 mb-1 shadow-sm mx-1">
                        <div class="font-black text-slate-700 text-xs">${item.from === "å…¨å“¡" ? 'âœ¨ å…¨å“¡é ç¹³' : 'ğŸ‘¤ ' + item.from}</div>
                        <div class="text-right"><div class="font-black text-amber-600">$${Math.round(item.amount)}</div>
                        ${(!isSettled && user === manager) ? `<button onclick="delDep(${item.id})" class="btn-action bg-rose-100 text-rose-500">åˆªé™¤</button>` : ''}</div></div>`;
                } else {
                    const canEdit = (!isSettled && (user === manager || user === item.paid_by));
                    container.innerHTML += `<div class="bg-slate-50 p-3 rounded-2xl flex items-center gap-3 border border-slate-100 mb-1 shadow-sm mx-1">
                        <div class="text-2xl">${emojis[item.category] || 'ğŸ·ï¸'}</div>
                        <div class="flex-1 min-w-0"><div class="font-black text-sm text-slate-800 truncate">${item.desc}</div><div class="text-[9px] text-slate-400 font-bold">${item.paid_by} â” å…¨å“¡åˆ†æ”¤</div></div>
                        <div class="text-right"><div class="font-black text-slate-900">$${Math.round(item.amount)}</div>
                        ${canEdit ? `<div class="flex mt-1"><button onclick="editExp(${item.id})" class="btn-action bg-indigo-100 text-indigo-600">ç·¨</button><button onclick="delExp(${item.id})" class="btn-action bg-rose-100 text-rose-500">åˆª</button></div>`:''}</div></div>`;
                }
            });
        }

        // å€‹äººä»£å¢Šç‰¹æ®Šæ¬Šé™æ¸²æŸ“ (æŒ‰æ—¥æœŸåˆ†çµ„)
        function renderPersonalTimelineGrouped() {
            const container = document.getElementById('personalTimeline'), user = localStorage.getItem(`locked_user_${roomId}`);
            container.innerHTML = "";
            const filtered = expenses.filter(e => e.paid_by !== "å…¬å¸³" && (e.currency === currentCurrency || (!e.currency && currentCurrency === "TWD"))).sort((a,b) => new Date(b.date) - new Date(a.date));
            if (!filtered.length) { container.innerHTML = "<p class='text-center py-6 text-xs text-slate-300 italic'>å°šç„¡å€‹äººä»£å¢Šè³‡æ–™</p>"; return; }
            
            let currentDate = "";
            filtered.forEach(e => {
                // æ¬Šé™æª¢æŸ¥ï¼šç®¡ç†å“¡å¯è¦‹å…¨éƒ¨ï¼›ä¸€èˆ¬æˆå“¡é™è¦‹è‡ªå·±ä»£å¢Šæˆ–è¢«åˆ†å¸³çš„
                const isPart = (user === manager || user === e.paid_by || (e.inv && e.inv.includes(user)));
                if (!isPart) return;

                if (e.date !== currentDate) {
                    currentDate = e.date;
                    container.innerHTML += `<div class="date-divider"><span class="date-label">${currentDate}</span></div>`;
                }

                // ä¿®æ”¹æ¬Šé™ï¼šç®¡ç†å“¡ã€ä»£å¢Šäººã€è¢«åˆ†å¸³äººçš†å¯ç·¨ä¿®åˆªé™¤
                const canEdit = (!isSettled && isPart);

                container.innerHTML += `<div class="bg-slate-50 p-3 rounded-2xl flex items-center gap-3 border border-slate-100 mb-1 shadow-sm mx-1">
                    <div class="text-2xl">${emojis[e.category] || 'ğŸ·ï¸'}</div>
                    <div class="flex-1 min-w-0"><div class="font-black text-sm text-slate-800 truncate">${e.desc}</div><div class="text-[9px] text-slate-400 font-bold">${e.paid_by} â” ${e.inv.length===members.length?'å…¨å“¡':e.inv.join(',')}</div></div>
                    <div class="text-right"><div class="font-black text-slate-900">$${Math.round(e.amount)}</div>
                    ${canEdit ? `<div class="flex mt-1"><button onclick="editExp(${e.id})" class="btn-action bg-indigo-100 text-indigo-600">ç·¨</button><button onclick="delExp(${e.id})" class="btn-action bg-rose-100 text-rose-500">åˆª</button></div>`:''}</div></div>`;
            });
        }

        function confirmAdminSettings() {
            const mVal = document.getElementById('memberInput').value;
            const newMembers = mVal.split(',').map(s=>s.trim()).filter(s=>s);
            if (newMembers.length === 0) return alert("æˆå“¡åå–®ä¸èƒ½ç‚ºç©º");
            if (confirm("å„²å­˜è¨­å®šï¼Ÿ")) {
                let updateData = { members: newMembers, password: document.getElementById('roomPassInput').value, managerPass: document.getElementById('adminPassInput').value, subCurrency: document.getElementById('subCurrencyInput').value };
                const potAdm = document.getElementById('newAdminSelect').value;
                if (potAdm && potAdm !== "-- ä¿æŒä¸è®Š --") updateData.manager = potAdm;
                db.ref('rooms/' + roomId).update(updateData).then(() => alert("æ›´æ–°æˆåŠŸ"));
            }
        }

        function lockMyIdentity() {
            const user = document.getElementById('currentUser').value;
            if (!user || user.includes("è¨­å®šåå–®")) return alert("è«‹é¸å–æ­£ç¢ºå§“å");
            if (manager === "") {
                if (confirm(`æ‚¨å°‡æˆç‚ºæ­¤æˆ¿é–“çš„ç®¡ç†å“¡ï¼Œç¢ºå®šå—ï¼Ÿ`)) db.ref('rooms/' + roomId).update({ manager: user }); else return;
            } else if (user === manager && prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼") !== managerPass) return alert("å¯†ç¢¼éŒ¯èª¤");
            localStorage.setItem(`locked_user_${roomId}`, user); updateUI();
        }

        function calculate() {
            const paid = {}, consumed = {}; members.forEach(m => { paid[m] = 0; consumed[m] = 0; });
            if (members[0] === "è«‹å…ˆè¨­å®šåå–®") return;
            let fundBal = 0;
            if (settleMode === 'MIX') {
                deposits.forEach(d => { const amt = (d.currency === subCurrency) ? d.amount * currentRate : d.amount; if(d.from === "å…¨å“¡") members.forEach(m => paid[m] += amt); else paid[d.from] += amt; });
                expenses.forEach(e => { const amt = (e.currency === subCurrency) ? e.amount * currentRate : e.amount; const per = amt / e.inv.length; if(e.paid_by === "å…¬å¸³") members.forEach(m => consumed[m] += per); else { paid[e.paid_by] += amt; e.inv.forEach(m => consumed[m] += per); } });
            } else {
                const cur = (settleMode === "TWD") ? "TWD" : subCurrency;
                let tDep = 0, tExp = 0;
                deposits.filter(d => d.currency === cur || (!d.currency && cur === "TWD")).forEach(d => { if(d.from === "å…¨å“¡") { members.forEach(m => paid[m] += d.amount); tDep += d.amount * members.length; } else paid[d.from] += d.amount; });
                expenses.filter(e => e.currency === cur || (!e.currency && cur === "TWD")).forEach(e => { const per = e.amount / e.inv.length; if(e.paid_by === "å…¬å¸³") tExp += e.amount; else paid[e.paid_by] += e.amount; e.inv.forEach(m => consumed[m] += per); });
                fundBal = tDep - tExp;
            }
            if (settleMode === currentCurrency) document.getElementById('fundBalance').innerText = `$${Math.round(fundBal)}`;
            const bal = {}; members.forEach(m => bal[m] = paid[m] - consumed[m]);
            if (manager && settleMode !== 'MIX') {
                const cur = (settleMode === "TWD") ? "TWD" : subCurrency;
                let tDep = 0, tExp = 0;
                deposits.filter(d => d.currency === cur || (!d.currency && cur === "TWD")).forEach(d => { if(d.from === "å…¨å“¡") tDep += d.amount * members.length; else tDep += d.amount; });
                expenses.filter(e => e.currency === cur || (!e.currency && cur === "TWD")).forEach(e => { if(e.paid_by === "å…¬å¸³") tExp += e.amount; });
                bal[manager] -= (tDep - tExp);
            }
            document.getElementById('balanceAudit').innerHTML = members.map(m => {
                const diff = bal[m]; return `<div class="grid grid-cols-4 text-center py-2 border-b border-white/5"><span>${m}</span><span>${Math.round(paid[m])}</span><span>${Math.round(consumed[m])}</span><span class="${diff>0.5?'text-emerald-400':'text-rose-400'}">${Math.round(diff)}</span></div>`;
            }).join('');
            let cr = [], dbts = [], splits = [];
            Object.keys(bal).forEach(m => { if(bal[m]>0.5) cr.push({n:m, v:bal[m]}); else if(bal[m]<-0.5) dbts.push({n:m, v:Math.abs(bal[m])}); });
            let i=0, j=0; while(i<dbts.length && j<cr.length) { let a = Math.min(dbts[i].v, cr[j].v); splits.push(`<div class="bg-white/5 p-3 rounded-xl flex justify-between text-xs font-bold"><span>${dbts[i].n} â” ${cr[j].n}</span><span class="text-yellow-400">$${Math.round(a)}</span></div>`); dbts[i].v -= a; cr[j].v -= a; if(dbts[i].v<=0.5) i++; if(cr[j].v<=0.5) j++; }
            document.getElementById('splitResult').innerHTML = splits.join('') || "<p class='text-center text-[11px] opacity-30 py-4'>å¸³ç›®å¹³è¡¡</p>";
        }

        function setSettleMode(mode) { settleMode = mode; document.getElementById('rateZone').classList.toggle('hidden', mode !== 'MIX'); ['TWD', 'SUB', 'MIX'].forEach(m => { const el = document.getElementById('btnSettle'+m); el.className = (m===mode) ? "flex-1 py-2 rounded-lg bg-yellow-400 text-indigo-900 font-black text-[11px]" : "flex-1 py-2 rounded-lg text-white font-black text-[11px]"; }); calculate(); }
        function saveExpense() {
            const data = { id: editingId || Date.now(), date: document.getElementById('expDate').value, category: document.getElementById('expCategory').value, desc: document.getElementById('expDesc').value, amount: parseFloat(document.getElementById('expAmount').value), paid_by: document.getElementById('expPayer').value, inv: Array.from(document.querySelectorAll('.m-check:checked')).map(el => el.value), currency: currentCurrency };
            if (!data.date || isNaN(data.amount)) return alert("å¡«å¯«æ—¥æœŸèˆ‡é‡‘é¡");
            if (editingId) expenses[expenses.findIndex(e => e.id === editingId)] = data; else expenses.push(data);
            resetForm(); pushData();
        }
        function resetForm() { editingId = null; document.getElementById('formTitle').querySelector('span').innerText = "æ–°å¢æ”¯å‡º ("+currentCurrency+")"; document.getElementById('expDesc').value = ""; document.getElementById('expAmount').value = ""; document.getElementById('cancelEdit').classList.add('hidden'); }
        function editExp(id) { const e = expenses.find(x => x.id === id); editingId = id; document.getElementById('formTitle').querySelector('span').innerText = "ğŸ“ ç·¨è¼¯ä¸­..."; document.getElementById('cancelEdit').classList.remove('hidden'); document.getElementById('expDate').value = e.date; document.getElementById('expDesc').value = e.desc; document.getElementById('expAmount').value = e.amount; document.getElementById('expCategory').value = e.category; document.getElementById('expPayer').value = e.paid_by; document.querySelectorAll('.m-check').forEach(ck => ck.checked = e.inv.includes(ck.value)); window.scrollTo({ top: 100, behavior: 'smooth' }); }
        function pushData() { db.ref('rooms/' + roomId).update({ expenses, deposits, isSettled, rate: parseFloat(document.getElementById('manualRate').value) }); }
        function delExp(id) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æ”¯å‡ºï¼Ÿ")) { expenses = expenses.filter(x => x.id !== id); pushData(); } }
        function delDep(id) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æ”¶å…¥ï¼Ÿ")) { deposits = deposits.filter(x => x.id !== id); pushData(); } }
        function addBulkDep() { const amt = parseFloat(document.getElementById('depAmount').value); if(isNaN(amt)) return; deposits.push({id:Date.now(), date:document.getElementById('depDate').value, amount:amt, from:"å…¨å“¡", currency:currentCurrency}); pushData(); }
        function addSingleDep() { const amt = parseFloat(document.getElementById('depAmount').value); if(isNaN(amt)) return; deposits.push({id:Date.now(), date:document.getElementById('depDate').value, amount:amt, from:document.getElementById('depMember').value, currency:currentCurrency}); pushData(); }
        function toggleSettlement() { isSettled = !isSettled; pushData(); }
        function logout() { localStorage.removeItem(`locked_user_${roomId}`); location.reload(); }
        function updateForm() {
            const user = localStorage.getItem(`locked_user_${roomId}`), pSel = document.getElementById('expPayer');
            pSel.innerHTML = (user === manager ? `<option value="å…¬å¸³">âœ¨ å…¬å¸³æ”¯ä»˜</option>` : ``) + members.map(m => `<option value="${m}">${m} ä»£å¢Š</option>`).join('');
            document.getElementById('involvedGrid').innerHTML = (isValidList() ? members.map(m => `<label class="flex items-center gap-1.5 p-2 bg-slate-50 rounded-xl border border-transparent has-[:checked]:border-indigo-600 has-[:checked]:bg-indigo-50"><input type="checkbox" checked value="${m}" class="m-check w-4 h-4 accent-indigo-600"><span class="font-bold text-slate-700 text-[10px] truncate">${m}</span></label>`).join('') : "");
            const catSel = document.getElementById('expCategory'); if (catSel.innerHTML === "") catSel.innerHTML = Object.keys(emojis).map(k => `<option value="${k}">${emojis[k]} ${k}</option>`).join('');
            document.getElementById('depMember').innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
        }
        function isValidList() { return members.length > 0 && members[0] !== "è«‹å…ˆè¨­å®šåå–®"; }
        function changeCurrentCurrency(type) { 
            currentCurrency = (type === 'TWD') ? 'TWD' : subCurrency; 
            ['btnSwitchTWD', 'btnSwitchSUB'].forEach(id => document.getElementById(id).className = "flex-1 py-2.5 rounded-xl font-black text-xs transition-all text-slate-500");
            document.getElementById(type === 'TWD' ? 'btnSwitchTWD' : 'btnSwitchSUB').className = "flex-1 py-2.5 rounded-xl font-black text-xs transition-all bg-emerald-500 text-white shadow-lg";
            updateUI(); 
        }
        window.onload = () => { 
            const now = new Date().toISOString().split('T')[0]; document.getElementById('expDate').value = now; document.getElementById('depDate').value = now; 
            const saved = localStorage.getItem('saved_room_id'); if(saved) { document.getElementById('roomId').value = saved; document.getElementById('rememberId').checked = true; }
        };
    </script>
</body>
</html>
