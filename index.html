<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…éŠåˆ†å¸³åŠ©æ‰‹ v24 - æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto+Sans+TC', sans-serif; 
            font-size: 1.15rem; /* å…¨å±€åŸºç¤å­—é«”æ”¾å¤§ */
            line-height: 1.6;
        }
        input, select, button { font-size: 1.1rem !important; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .collapsible-content.active { max-height: 1200px; }
        .arrow-icon { transition: transform 0.3s; }
        .arrow-icon.active { transform: rotate(180deg); }
        .user-warn { background-color: #fef08a !important; border: 3px solid #eab308 !important; }
        /* é‡å°æ‰‹æ©Ÿåˆ—è¡¨å¼·åŒ– */
        .expense-card { border-radius: 1rem; padding: 1rem; margin-bottom: 0.75rem; border: 1px solid #e2e8f0; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="bg-slate-50 p-3 md:p-6 text-slate-800">

    <div class="max-w-xl mx-auto"> <div id="statusHeader" class="text-center text-xs mb-2 font-bold text-rose-500 uppercase tracking-widest">âš ï¸ å°šæœªé€£ç·š</div>
        
        <div id="loginBox" class="bg-indigo-600 text-white p-6 rounded-[2.5rem] shadow-2xl mb-6">
            <h1 class="text-3xl font-black mb-6 text-center">âœˆï¸ é›²ç«¯åˆ†å¸³ v24</h1>
            <div class="space-y-4">
                <input type="text" id="roomId" class="w-full p-4 rounded-2xl text-black font-bold text-center" placeholder="è¼¸å…¥æˆ¿é–“ ID">
                <input type="password" id="roomPass" class="w-full p-4 rounded-2xl text-black font-bold text-center" placeholder="è¼¸å…¥æš—è™Ÿ">
                <button onclick="initSync()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-indigo-900 p-5 rounded-2xl font-black text-xl shadow-lg transition-all active:scale-95">é€²å…¥æˆ¿é–“</button>
                <div class="flex justify-center gap-4 pt-2">
                    <button onclick="prepareNewLedger()" class="text-indigo-200 text-sm font-bold underline">â• å»ºç«‹æ–°å¸³ç°¿</button>
                    <label class="flex items-center gap-1 text-sm text-indigo-100">
                        <input type="checkbox" id="saveIdCheck" class="w-5 h-5 accent-emerald-400"> è¨˜ä½ ID
                    </label>
                </div>
            </div>
        </div>

        <div id="mainUI" class="hidden space-y-5">
            
            <div class="bg-indigo-700 p-6 rounded-[2rem] shadow-xl border-b-8 border-indigo-900">
                <label class="block text-indigo-200 text-sm font-bold mb-2">è«‹ç¢ºèªæ‚¨çš„èº«ä»½ï¼š</label>
                <select id="currentUser" class="w-full p-4 rounded-2xl font-black text-indigo-800 outline-none shadow-inner bg-white appearance-none text-center" onchange="checkAuth()">
                    <option value="">âš ï¸ è«‹é»æ­¤é¸æ“‡å§“å</option>
                </select>
            </div>

            <div class="bg-slate-900 p-6 rounded-[2rem] text-white shadow-xl flex justify-between items-center">
                <div class="text-center flex-1 border-r border-white/10">
                    <p class="text-xs opacity-60 mb-1">å…¬å¸³ç¸½æ”¯å‡º</p>
                    <p id="fundSpent" class="font-mono font-black text-xl text-rose-400"></p>
                </div>
                <div class="text-center flex-1">
                    <p class="text-sm text-yellow-400 font-black mb-1">ğŸ’° å…¬å¸³å‰©é¤˜</p>
                    <p id="fundBalance" class="font-mono font-black text-3xl text-yellow-400"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                    <button onclick="toggleCollapsible('setupContent', 'setupArrow')" class="w-full p-5 flex justify-between items-center bg-slate-100">
                        <span class="font-bold text-slate-600">âš™ï¸ å¸³ç°¿èˆ‡ç®¡ç†å“¡è¨­å®š</span>
                        <span id="setupArrow" class="arrow-icon">â–¼</span>
                    </button>
                    <div id="setupContent" class="collapsible-content px-5">
                        <div class="py-5 space-y-4 border-t">
                            <div>
                                <label class="text-xs font-bold text-slate-400">æˆå“¡åå–® (ç”¨é€—è™Ÿéš”é–‹)</label>
                                <input type="text" id="memberInput" class="w-full p-3 border-2 rounded-xl" onchange="pushData()">
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-orange-600">ğŸŒŸ æŒ‡å®šç®¡ç†å“¡:</span>
                                <select id="fundManager" class="p-3 border-2 rounded-xl bg-yellow-50 font-bold" onchange="handleManagerChange()"></select>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="depositSection" class="bg-white rounded-3xl shadow-sm border border-orange-200 overflow-hidden">
                    <button onclick="toggleCollapsible('depositContent', 'depositArrow')" class="w-full p-5 flex justify-between items-center bg-orange-50">
                        <span class="font-bold text-orange-700">ğŸ“¥ é ç¹³/é›†è³‡æ”¶éŒ¢</span>
                        <div class="flex items-center gap-2">
                            <span id="lockHint" class="text-[10px] bg-rose-100 text-rose-500 px-2 py-1 rounded font-bold">èº«åˆ†é–å®š</span>
                            <span id="depositArrow" class="arrow-icon">â–¼</span>
                        </div>
                    </button>
                    <div id="depositContent" class="collapsible-content px-5">
                        <div class="py-5 space-y-4 border-t">
                            <input type="number" id="depAmount" placeholder="è¼¸å…¥æ¯äººé‡‘é¡" class="w-full p-4 border-2 rounded-xl text-2xl font-mono font-bold text-center">
                            <button id="btnBulk" onclick="addBulkDeposit()" disabled class="w-full bg-slate-300 text-white p-4 rounded-2xl font-black">å…¨å“¡çµ±ä¸€æ”¶éŒ¢</button>
                            <div class="flex gap-2">
                                <select id="depMember" class="flex-1 p-3 border-2 rounded-xl text-sm"></select>
                                <button id="btnSingle" onclick="addSingleDeposit()" disabled class="bg-slate-300 text-white px-5 py-3 rounded-xl font-bold">å–®äººæ”¶</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="expenseBox" class="p-6 bg-white rounded-[2rem] shadow-lg border-2 border-indigo-100">
                <h2 class="font-black text-2xl text-slate-700 mb-5 flex items-center gap-2">
                    <span class="bg-indigo-100 p-2 rounded-xl">ğŸ–Šï¸</span> æ–°å¢æ¶ˆè²»
                </h2>
                <div class="space-y-4">
                    <div class="flex gap-2">
                        <input type="date" id="expDate" class="w-1/2 p-4 border-2 rounded-2xl font-bold bg-slate-50">
                        <select id="expCategory" class="w-1/2 p-4 border-2 rounded-2xl font-bold text-center">
                            <option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option><option>é»å¿ƒ</option>
                            <option>å®µå¤œ</option><option>é£²æ–™</option><option>é–€ç¥¨</option><option>äº¤é€š</option>
                            <option>å¨›æ¨‚</option><option selected>å…¶ä»–</option>
                        </select>
                    </div>
                    <input type="text" id="expDesc" placeholder="é …ç›®å…§å®¹ (å¦‚ï¼šè¨ˆç¨‹è»Š)" class="w-full p-4 border-2 rounded-2xl font-bold">
                    <div class="flex gap-2">
                        <div class="w-1/2 relative">
                            <span class="absolute left-3 top-4 text-slate-400 font-bold">$</span>
                            <input type="number" id="expAmount" placeholder="é‡‘é¡" class="w-full p-4 pl-8 border-2 rounded-2xl font-mono text-2xl font-black text-indigo-600">
                        </div>
                        <select id="expPayer" class="w-1/2 p-4 border-2 rounded-2xl font-bold text-indigo-700 bg-indigo-50"></select>
                    </div>
                    
                    <p class="text-sm font-bold text-slate-400 mt-2">å“ªäº›äººåˆ†æ“”ï¼Ÿ (é è¨­å…¨é¸)</p>
                    <div id="involvedChecks" class="flex flex-wrap gap-3 p-4 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200"></div>
                    
                    <button id="btnSubmitExp" onclick="addExpense()" class="w-full bg-slate-300 text-white p-5 rounded-2xl font-black text-2xl shadow-xl active:scale-95 transition-all mt-2">
                        è«‹å…ˆé¸æ“‡èº«åˆ†
                    </button>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <div class="flex justify-between items-end px-2 mb-2">
                        <h3 class="font-black text-xl text-orange-600">ğŸ“™ å…¬å¸³æ”¯å‡ºæ˜ç´°</h3>
                        <span id="subtotalFund" class="text-sm font-mono bg-orange-100 px-3 py-1 rounded-full text-orange-700 font-bold"></span>
                    </div>
                    <div id="listFund" class="space-y-3"></div>
                </div>

                <div>
                    <div class="flex justify-between items-end px-2 mb-2">
                        <h3 class="font-black text-xl text-blue-600">ğŸ“˜ å€‹äººä»£å¢Šæ˜ç´°</h3>
                        <span id="subtotalIndiv" class="text-sm font-mono bg-blue-100 px-3 py-1 rounded-full text-blue-700 font-bold"></span>
                    </div>
                    <div id="listIndiv" class="space-y-3"></div>
                </div>

                <div class="bg-emerald-50 rounded-3xl p-4 border border-emerald-200">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-black text-emerald-800">ğŸ’µ é ç¹³ç´€éŒ„</h3>
                        <span id="totalDeposit" class="font-mono font-bold text-emerald-600"></span>
                    </div>
                    <div id="listDeposit" class="space-y-2"></div>
                </div>
            </div>

            <div class="p-8 bg-white rounded-[2.5rem] border-4 border-emerald-500 shadow-2xl">
                <h2 class="font-black text-emerald-800 text-2xl mb-6 text-center underline decoration-emerald-200 underline-offset-8">ğŸ çµç®—å°å¸³å»ºè­°</h2>
                <div id="splitResult" class="space-y-4"></div>
                
                <div class="mt-10 grid grid-cols-2 gap-4">
                    <button onclick="exportCSV()" class="bg-slate-100 p-4 rounded-2xl font-bold text-slate-600 border active:bg-slate-200">ğŸ“¥ å ±è¡¨</button>
                    <button onclick="clearAllData()" class="bg-rose-50 text-rose-600 p-4 rounded-2xl font-bold border border-rose-100 active:bg-rose-200">âš ï¸ æ¸…ç©º</button>
                </div>
            </div>
            
            <p class="text-center text-[10px] text-slate-300 pb-10">æ—…éŠåˆ†å¸³åŠ©æ‰‹ v24 å°ˆæ¥­æ‰‹æ©Ÿç‰ˆ</p>
        </div>
    </div>

    <script>
        // --- Firebase è¨­å®š (æ²¿ç”¨æ‚¨çš„è¨­å®š) ---
        const firebaseConfig = { databaseURL: "https://project-2641836624074325409-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let members = [], expenses = [], deposits = [], roomId = "", roomPass = "", manager = "";
        const catEmoji = { "æ—©é¤":"ğŸ³", "åˆé¤":"ğŸ±", "æ™šé¤":"ğŸ½ï¸", "é»å¿ƒ":"ğŸ°", "å®µå¤œ":"ğŸŒ™", "é£²æ–™":"ğŸ¥¤", "é–€ç¥¨":"ğŸ«", "äº¤é€š":"ğŸš—", "å¨›æ¨‚":"ğŸ®", "å…¶ä»–":"ğŸ·ï¸" };
        
        window.onload = function() {
            document.getElementById('expDate').valueAsDate = new Date();
            const sid = localStorage.getItem('last_room_id');
            if (sid) { document.getElementById('roomId').value = sid; document.getElementById('saveIdCheck').checked = true; }
        };

        function prepareNewLedger() {
            const rid = 'trip-' + Math.random().toString(36).substr(2, 6);
            document.getElementById('roomId').value = rid;
            alert("æ–°å¸³ç°¿ ID: " + rid + "\nè«‹è¨˜ä½é€™å€‹ ID æˆ–æ˜¯å‹¾é¸ã€Œè¨˜ä½ IDã€");
        }

        function toggleCollapsible(cId, aId) {
            document.getElementById(cId).classList.toggle('active');
            document.getElementById(aId).classList.toggle('active');
        }

        function initSync() {
            roomId = document.getElementById('roomId').value.trim();
            roomPass = document.getElementById('roomPass').value.trim();
            if (!roomId || !roomPass) return alert("è«‹è¼¸å…¥ ID èˆ‡æš—è™Ÿ");
            db.ref('rooms/' + roomId).on('value', (snap) => {
                const data = snap.val();
                if (data) {
                    if (data.password && data.password !== roomPass) { alert("æš—è™ŸéŒ¯èª¤ï¼"); location.reload(); return; }
                    if (document.getElementById('saveIdCheck').checked) localStorage.setItem('last_room_id', roomId);
                    else localStorage.removeItem('last_room_id');
                    members = data.members || []; expenses = data.expenses || []; deposits = data.deposits || []; manager = data.manager || "";
                    document.getElementById('memberInput').value = members.join(', ');
                    document.getElementById('mainUI').classList.remove('hidden');
                    document.getElementById('loginBox').classList.add('hidden');
                    document.getElementById('statusHeader').innerText = "âœ… å·²é€£ç·šï¼š" + roomId;
                    document.getElementById('statusHeader').className = "text-center text-[10px] mb-2 font-bold text-emerald-500 uppercase tracking-widest";
                    updateUI();
                } else { db.ref('rooms/' + roomId).set({ password: roomPass }); }
            });
        }

        function pushData() {
            members = document.getElementById('memberInput').value.split(',').map(s => s.trim()).filter(s => s !== "");
            manager = document.getElementById('fundManager').value;
            db.ref('rooms/' + roomId).update({ members, expenses, deposits, manager });
        }

        function handleManagerChange() {
            manager = document.getElementById('fundManager').value;
            pushData();
        }

        function updateUI() {
            const uSel = document.getElementById('currentUser'), currentVal = uSel.value;
            let uOpts = `<option value="">âš ï¸ è«‹å…ˆé»æ­¤é¸æ“‡å§“å</option>`;
            uOpts += members.map(m => `<option value="${m}" ${m===currentVal?'selected':''}>æˆ‘æ˜¯ ${m}</option>`).join('');
            uSel.innerHTML = uOpts;
            
            document.getElementById('fundManager').innerHTML = members.map(m => `<option value="${m}" ${m===manager?'selected':''}>${m}</option>`).join('');
            document.getElementById('depMember').innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
            checkAuth(); renderLists(); calculate();
        }

        function checkAuth() {
            const u = document.getElementById('currentUser').value, m = document.getElementById('fundManager').value;
            const uSel = document.getElementById('currentUser');
            const btnSubmit = document.getElementById('btnSubmitExp');
            
            if (!u) {
                uSel.classList.add('user-warn');
                btnSubmit.disabled = true;
                btnSubmit.innerText = "è«‹å…ˆé¸æ“‡èº«åˆ†";
                btnSubmit.className = "w-full bg-slate-300 text-white p-5 rounded-2xl font-black text-2xl shadow-md cursor-not-allowed";
            } else {
                uSel.classList.remove('user-warn');
                btnSubmit.disabled = false;
                btnSubmit.innerText = "ç¢ºèªæ–°å¢ç´€éŒ„";
                btnSubmit.className = "w-full bg-indigo-600 text-white p-5 rounded-2xl font-black text-2xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all";
            }

            const isM = (u === m && m !== "");
            const btnB = document.getElementById('btnBulk'), btnS = document.getElementById('btnSingle'), depS = document.getElementById('depositSection'), hint = document.getElementById('lockHint');
            
            if (isM) {
                depS.classList.remove('opacity-60'); btnB.disabled = false; btnS.disabled = false;
                btnB.className = "w-full bg-orange-500 text-white p-4 rounded-2xl font-black shadow"; btnS.className = "bg-slate-700 text-white px-5 py-3 rounded-xl font-bold";
                hint.innerText = "ğŸ”“ ç®¡ç†å“¡å·²æˆæ¬Š"; hint.className = "text-[10px] bg-emerald-100 text-emerald-600 px-2 py-1 rounded font-bold";
            } else {
                depS.classList.add('opacity-60'); btnB.disabled = true; btnS.disabled = true;
                btnB.className = "w-full bg-slate-300 text-white p-4 rounded-2xl font-black cursor-not-allowed"; btnS.className = "bg-slate-300 text-white px-5 py-3 rounded-xl font-bold cursor-not-allowed";
                hint.innerText = u ? "é™ç®¡ç†å“¡æ“ä½œ" : "èº«åˆ†æœªç¢ºèª"; hint.className = "text-[10px] bg-rose-100 text-rose-500 px-2 py-1 rounded font-bold";
            }

            const pSel = document.getElementById('expPayer'), pVal = pSel.value;
            let opts = isM ? `<option value="å…¬å¸³">âœ¨ å…¬å¸³æ”¯ä»˜</option>` : `<option value="" disabled>ğŸš« å…¬å¸³ (é™ç®¡ç†å“¡)</option>`;
            opts += members.map(mem => `<option value="${mem}" ${mem===pVal?'selected':''}>ğŸ‘¤ ${mem} ä»£å¢Š</option>`).join('');
            pSel.innerHTML = opts;
            
            const inv = document.getElementById('involvedChecks');
            if (inv.innerHTML === "") inv.innerHTML = members.map(mem => `<label class="flex items-center gap-3 cursor-pointer bg-white px-4 py-3 rounded-2xl border-2 active:bg-indigo-50"><input type="checkbox" checked value="${mem}" class="m-check w-6 h-6 accent-indigo-600"> <span class="font-black text-lg text-slate-700">${mem}</span></label>`).join('');
        }

        function addBulkDeposit() {
            const a = parseFloat(document.getElementById('depAmount').value);
            if (isNaN(a) || a <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡");
            if(confirm(`å…¨å“¡æ”¶éŒ¢ï¼š${members.length} äººå„æ”¶ $${a}ï¼Ÿ`)) {
                members.forEach(m => { deposits.push({ id: Date.now() + Math.random(), from: m, amount: a, date: new Date().toISOString().split('T')[0] }); });
                document.getElementById('depAmount').value = ""; pushData();
            }
        }

        function addSingleDeposit() {
            const f = document.getElementById('depMember').value, a = parseFloat(document.getElementById('depAmount').value);
            if (isNaN(a) || a <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡");
            deposits.push({ id: Date.now(), from: f, amount: a, date: new Date().toISOString().split('T')[0] });
            document.getElementById('depAmount').value = ""; pushData();
        }

        function addExpense() {
            const u = document.getElementById('currentUser').value;
            if (!u) return alert("è«‹å…ˆé¸æ“‡æ‚¨çš„å§“åï¼");
            const d = document.getElementById('expDate').value, c = document.getElementById('expCategory').value, de = document.getElementById('expDesc').value, a = parseFloat(document.getElementById('expAmount').value), p = document.getElementById('expPayer').value, i = Array.from(document.querySelectorAll('.m-check:checked')).map(el => el.value);
            if (!p || isNaN(a) || !de || i.length === 0) return alert("è³‡æ–™ä¸å®Œæ•´");
            expenses.push({ id: Date.now(), date: d, category: c, desc: de, amount: a, paid_by: p, inv: i });
            expenses.sort((a,b) => new Date(a.date) - new Date(b.date));
            pushData(); document.getElementById('expDesc').value = ""; document.getElementById('expAmount').value = "";
        }

        function renderLists() {
            const fBox = document.getElementById('listFund'), iBox = document.getElementById('listIndiv'), dBox = document.getElementById('listDeposit');
            let sF = 0, sI = 0, sD = 0;
            
            const cardHTML = (e) => `
                <div class="expense-card group relative">
                    <button onclick="deleteExp(${e.id})" class="absolute top-2 right-2 text-rose-300 p-2 text-xl">âœ•</button>
                    <div class="flex items-start gap-3">
                        <div class="text-3xl bg-slate-100 p-3 rounded-2xl">${catEmoji[e.category]||'ğŸ·ï¸'}</div>
                        <div class="flex-1">
                            <div class="font-black text-xl text-slate-800">${e.desc}</div>
                            <div class="text-sm text-slate-500 font-bold">${e.date} Â· ${e.paid_by=='å…¬å¸³'?'å…¬å¸³æ”¯ä»˜':e.paid_by+'ä»£å¢Š'}</div>
                            <div class="text-xs mt-2 text-indigo-500 font-bold bg-indigo-50 inline-block px-2 py-1 rounded">åˆ†æ“”: ${e.inv.join(', ')}</div>
                        </div>
                        <div class="text-2xl font-black font-mono text-indigo-700">$${Math.round(e.amount)}</div>
                    </div>
                </div>`;

            fBox.innerHTML = expenses.filter(e => e.paid_by === 'å…¬å¸³').map(e => { sF += e.amount; return cardHTML(e); }).join('') || "<p class='text-center p-10 text-slate-300 font-bold'>ç„¡å…¬å¸³ç´€éŒ„</p>";
            iBox.innerHTML = expenses.filter(e => e.paid_by !== 'å…¬å¸³').map(e => { sI += e.amount; return cardHTML(e); }).join('') || "<p class='text-center p-10 text-slate-300 font-bold'>ç„¡ä»£å¢Šç´€éŒ„</p>";
            
            const groupedD = {};
            deposits.forEach(d => {
                const k = d.date + "_" + d.amount;
                if (!groupedD[k]) groupedD[k] = { date: d.date, amount: d.amount, people: [], ids: [] };
                groupedD[k].people.push(d.from); groupedD[k].ids.push(d.id); sD += d.amount;
            });
            dBox.innerHTML = Object.values(groupedD).map(g => `
                <div class="bg-white p-3 rounded-xl flex justify-between items-center text-sm shadow-sm">
                    <div class="font-bold"><span class="text-slate-400 font-mono text-xs">${g.date}</span> <span class="text-emerald-600">${g.people.length === members.length ? 'å…¨å“¡' : g.people.length+'äºº'}é ç¹³</span> <span class="font-mono">$${g.amount}</span></div>
                    <button onclick="deleteBulkDep('${g.ids.join(',')}')" class="text-rose-300 px-2">âœ•</button>
                </div>`).join('');

            document.getElementById('totalDeposit').innerText = `ç¸½æ”¶ $${Math.round(sD)}`;
            document.getElementById('fundSpent').innerText = `$${Math.round(sF)}`;
            document.getElementById('fundBalance').innerText = `$${Math.round(sD - sF)}`;
            document.getElementById('subtotalFund').innerText = `å°è¨ˆ $${Math.round(sF)}`;
            document.getElementById('subtotalIndiv').innerText = `å°è¨ˆ $${Math.round(sI)}`;
        }

        function deleteExp(id) { if(confirm("ç¢ºå®šåˆªé™¤é€™ç­†æ¶ˆè²»ï¼Ÿ")) { expenses = expenses.filter(e => e.id !== id); pushData(); } }
        function deleteBulkDep(idsStr) { if(confirm("ç¢ºå®šåˆªé™¤é€™ç­†ç¹³è²»ç´€éŒ„ï¼Ÿ")) { const ids = idsStr.split(',').map(Number); deposits = deposits.filter(d => !ids.includes(d.id)); pushData(); } }

        function calculate() {
            if (members.length === 0) return;
            const b = {}; members.forEach(m => b[m] = 0);
            let ti = 0, to = 0;
            deposits.forEach(d => { if(b.hasOwnProperty(d.from)) { ti += d.amount; b[d.from] += d.amount; } });
            expenses.forEach(e => {
                const p = e.amount / e.inv.length;
                if (e.paid_by === "å…¬å¸³") { to += e.amount; e.inv.forEach(m => { if(b.hasOwnProperty(m)) b[m] -= p; }); }
                else { if (b.hasOwnProperty(e.paid_by)) b[e.paid_by] += e.amount; e.inv.forEach(m => { if(b.hasOwnProperty(m)) b[m] -= p; }); }
            });
            const r = ti - to; if (manager && b.hasOwnProperty(manager)) b[manager] -= r;
            let cr = [], dbts = [], splits = [];
            Object.keys(b).forEach(n => { let v = b[n]; if (v > 0.5) cr.push({n, v}); else if (v < -0.5) dbts.push({n, v: Math.abs(v)}); });
            let i=0, j=0;
            while(i<dbts.length && j<cr.length) {
                let a = Math.min(dbts[i].v, cr[j].v); 
                splits.push({f: dbts[i].n, t: cr[j].n, a: Math.round(a)});
                dbts[i].v -= a; cr[j].v -= a; if(dbts[i].v <= 0.5) i++; if(cr[j].v <= 0.5) j++;
            }
            document.getElementById('splitResult').innerHTML = splits.map(s => `
                <div class="bg-emerald-50 p-5 rounded-[1.5rem] border-2 border-emerald-200 flex justify-between items-center shadow-sm">
                    <span class="text-lg font-bold"><b>${s.f}</b> â” <b>${s.t}</b></span>
                    <span class="text-rose-600 font-black text-2xl font-mono">$${s.a}</span>
                </div>`).join('') || "<p class='text-center text-slate-400 font-black py-10 w-full'>ğŸ‰ å¸³ç›®å·²æ¸…ï¼Œä¸ç›¸æ¬ ï¼</p>";
        }

        function exportCSV() {
            let csv = "\ufeffæ—¥æœŸ,é …ç›®,é‡‘é¡,ä»˜æ¬¾äºº,åƒèˆ‡è€…\n";
            expenses.forEach(e => csv += `${e.date},${e.desc},${e.amount},${e.paid_by},"${e.inv.join('/')}"\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
            a.download = `æ—…éŠåˆ†å¸³_${roomId}.csv`; a.click();
        }
        function clearAllData() { if (confirm("é€™å°‡æ°¸ä¹…æ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼Œç¢ºå®šï¼Ÿ")) { db.ref('rooms/' + roomId).remove(); location.reload(); } }
    </script>
</body>
</html>