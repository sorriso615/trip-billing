<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripSplit v82.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto+Sans+TC', sans-serif; background-color: #f8fafc; }
        summary { list-style: none; cursor: pointer; }
        .dropdown-card { background: white; border-radius: 1.25rem; overflow: hidden; border: 1px solid #e2e8f0; margin-bottom: 0.75rem; }
        .dropdown-summary { padding: 1.25rem 1rem; font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
        .compact-input { padding: 0.75rem !important; font-size: 0.875rem !important; border-radius: 1rem !important; border: 1px solid #e2e8f0; }
        .btn-action { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 8px; margin-left: 4px; }
        .date-label { background: #6366f1; color: white; padding: 2px 10px; border-radius: 20px; font-size: 10px; font-weight: 900; }
        
        .toggle-btn { flex: 1; padding: 10px; font-size: 11px; font-weight: 900; border-radius: 10px; transition: all 0.2s; }
        .btn-all-active { background: #4f46e5; color: white; }
        .btn-self-active { background: #f59e0b; color: white; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); border: 2px solid #fbbf24; }
        .btn-inactive { background: #f1f5f9; color: #64748b; }

        .cur-btn-active-twd { background: #4f46e5 !important; color: white !important; }
        .cur-btn-active-sub { background: #f59e0b !important; color: white !important; }
        .cur-btn-inactive { background: #1e293b !important; color: #64748b !important; opacity: 0.5; }
        
        .instruction-box { border-left: 10px solid #38bdf8; background: #f0f9ff; }
        .ins-header { color: #0369a1; font-weight: 900; font-size: 1.1rem; margin-bottom: 0.5rem; border-bottom: 2px solid #bae6fd; padding-bottom: 4px; }
        .ins-section { margin-bottom: 1.5rem; }
        .ins-tag { background: #0ea5e9; color: white; padding: 1px 6px; border-radius: 4px; font-size: 10px; margin-right: 4px; }

        @media (min-width: 1024px) { .desktop-grid { display: grid; grid-template-columns: 450px 1fr; gap: 2rem; align-items: start; } .sticky-form { position: sticky; top: 20px; } }
    </style>
</head>
<body class="p-3 pb-24 lg:p-8">

    <div class="max-w-6xl mx-auto">
        <div id="loginSection" class="max-w-xl mx-auto space-y-4">
            <div class="bg-indigo-700 p-8 rounded-[2rem] shadow-2xl text-white text-center">
                <h1 class="text-4xl font-black mb-8 italic text-yellow-400 tracking-tighter">TripSplit</h1>
                <div class="space-y-4">
                    <input type="text" id="roomId" class="w-full p-4 rounded-2xl text-black font-bold text-center outline-none" placeholder="æˆ¿é–“ ID">
                    <input type="password" id="roomPass" class="w-full p-4 rounded-2xl text-black font-bold text-center outline-none" placeholder="é€²å…¥æš—è™Ÿ">
                    <button onclick="handleAuth('login')" class="w-full bg-yellow-400 text-indigo-900 p-4 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-all">é€²å…¥å¸³ç°¿</button>
                    <button onclick="handleAuth('create')" class="w-full bg-indigo-800 text-indigo-100 p-3 rounded-2xl font-bold text-xs opacity-70">å»ºç«‹æ–°æˆ¿é–“ (è¨­å®šæˆå“¡)</button>
                    <div class="flex items-center justify-center gap-2 py-2">
                        <input type="checkbox" id="rememberId" class="w-5 h-5 accent-yellow-400 cursor-pointer">
                        <label for="rememberId" class="font-bold text-sm cursor-pointer select-none text-indigo-200">è¨˜ä½æˆ¿é–“ ID</label>
                    </div>
                </div>
            </div>
            
            <details class="dropdown-card border-l-8 border-sky-400">
                <summary class="dropdown-summary text-sky-800 bg-sky-50"><span>ğŸ“˜ å¸³ç°¿å…¨åŠŸèƒ½ä½¿ç”¨èªªæ˜æ›¸ (v82.0)</span><span>â–¼</span></summary>
                <div class="instruction-box p-6 space-y-6">
                    <div class="ins-section">
                        <div class="ins-header">ğŸ†• 1. é–‹ç°¿èˆ‡åˆå§‹åŒ–æµç¨‹</div>
                        <ul class="ml-4 space-y-1 text-slate-600 font-bold text-sm list-disc">
                            <li>é»é¸å»ºç«‹æˆ¿é–“å¾Œï¼Œç³»çµ±æœƒè¦æ±‚å…ˆè¼¸å…¥<b class="text-indigo-600">æ‰€æœ‰æˆå“¡å§“å</b>ï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼‰ã€‚</li>
                            <li>å»ºç«‹æˆåŠŸå¾Œï¼Œè«‹ç”±ä¸‹æ‹‰é¸å–®é¸å®šæ‚¨çš„èº«åˆ†ä¸¦ã€Œé–å®šã€ï¼Œé¦–ä½é–å®šè€…å³ç‚ºç®¡ç†å“¡ã€‚</li>
                        </ul>
                    </div>
                    <div class="ins-section">
                        <div class="ins-header">ğŸ›¡ï¸ 2. ç®¡ç†å“¡èˆ‡æ¬Šé™</div>
                        <ul class="ml-4 space-y-1 text-slate-600 font-bold text-sm list-disc">
                            <li>åªæœ‰ç®¡ç†å“¡å¯æ“ä½œã€Œå…¬å¸³é ç¹³ã€èˆ‡ã€Œçµç®—å°å­˜ã€ã€‚</li>
                            <li><span class="ins-tag">ç·¨è¼¯æ¬Šé™</span><b class="text-rose-500">ä»£å¢Šäººã€åˆ†å¸³äººã€ç®¡ç†å“¡</b>çš†å¯ä¿®æ”¹æˆ–åˆªé™¤æ”¯å‡ºæ˜ç´°ã€‚</li>
                        </ul>
                    </div>
                    <div class="ins-section">
                        <div class="ins-header">ğŸ 3. ä¸‰ç¨®çµç®—æ¨¡å¼</div>
                        <ul class="ml-4 space-y-1 text-slate-600 font-bold text-sm list-disc">
                            <li><b class="text-emerald-700">åˆä½µçµç®— (å°å¹£çµæ¸…)</b>ï¼šè‡ªå‹•å°‡å¤–å¹£ä¾åŒ¯ç‡è½‰ç‚ºå°å¹£ï¼Œç”¢å‡ºå–®ä¸€æ‰¾é›¶è¡¨ã€‚</li>
                            <li>å…¶é¤˜é‚„æœ‰ã€Œç´”å°å¹£ã€èˆ‡ã€Œç´”å¤–å¹£ã€çµç®—å¯åˆ‡æ›ã€‚</li>
                        </ul>
                    </div>
                </div>
            </details>
        </div>

        <div id="mainUI" class="hidden">
            <div id="settledBanner" class="hidden bg-rose-600 text-white text-center py-2 rounded-xl mb-4 font-black text-sm">ğŸ ç¸½çµç®—å·²å•Ÿå‹• Â· å¸³ç›®å°å­˜ä¸­</div>

            <div class="bg-slate-900 text-white p-5 rounded-[2.5rem] shadow-xl border-b-8 border-emerald-500 mb-6">
                <div class="flex justify-between items-start mb-5">
                    <div><p class="text-[10px] opacity-50 font-black italic mb-1 uppercase tracking-widest">Public Balance</p><p id="fundBalance" class="text-4xl font-mono font-black text-yellow-400 tracking-tighter">$0</p></div>
                    <div class="text-right">
                        <div class="flex items-center gap-2 mb-2">
                            <select id="currentUser" class="bg-slate-800 text-white font-bold text-xs rounded-xl p-2 outline-none border border-slate-700"></select>
                            <button id="btnLockUser" onclick="lockMyIdentity()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-black text-[11px]">é–å®šèº«ä»½</button>
                        </div>
                        <div id="lockBadge" class="hidden text-emerald-400 font-black text-[10px]">â— ONLINE <span id="displayUserName"></span> <button onclick="logout()" class="text-slate-500 underline ml-1">ç™»å‡º</button></div>
                    </div>
                </div>
                <div class="flex gap-2 bg-slate-800/50 p-1.5 rounded-2xl">
                    <button id="btnSwitchTWD" onclick="changeCurrentCurrency('TWD')" class="flex-1 py-3 rounded-xl font-black text-xs transition-all">TWD</button>
                    <button id="btnSwitchSUB" onclick="changeCurrentCurrency('SUB')" class="flex-1 py-3 rounded-xl font-black text-xs transition-all">å¤–å¹£</button>
                </div>
            </div>

            <div class="desktop-grid">
                <div class="sticky-form space-y-4">
                    <div id="expenseFormBox" class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200">
                        <h2 id="formTitle" class="font-black text-lg text-slate-800 mb-5 border-l-4 border-indigo-500 pl-4 flex justify-between items-center">
                            <span>æ–°å¢æ”¯å‡º (<span class="cur-text">TWD</span>)</span>
                            <button id="cancelEdit" onclick="resetForm()" class="hidden text-xs bg-rose-100 text-rose-500 px-3 py-1 rounded-full">å–æ¶ˆç·¨è¼¯</button>
                        </h2>
                        <div class="space-y-4">
                            <div class="flex gap-2"><input type="date" id="expDate" class="w-1/2 compact-input"><select id="expCategory" class="w-1/2 compact-input"></select></div>
                            <input type="text" id="expDesc" placeholder="æ¶ˆè²»å…§å®¹" class="w-full compact-input font-bold">
                            <div class="flex gap-2"><input type="number" id="expAmount" placeholder="é‡‘é¡" class="w-1/2 compact-input bg-indigo-50 font-black"><select id="expPayer" class="w-1/2 compact-input bg-indigo-50 font-bold"></select></div>
                            <div id="involvedGrid" class="grid grid-cols-3 gap-2 py-2"></div>
                            <button id="submitBtn" onclick="saveExpense()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-black text-xl shadow-xl opacity-50 pointer-events-none transition-all">ç¢ºèªé€å‡º</button>
                        </div>
                    </div>

                    <details id="depositBox" class="hidden dropdown-card border-l-8 border-amber-400">
                        <summary class="dropdown-summary text-amber-800"><span>ğŸ“¥ å…¬å¸³é ç¹³ (ç®¡ç†å“¡)</span><span>â–¼</span></summary>
                        <div class="p-4 space-y-3">
                            <h3 id="depFormTitle" class="text-xs font-black text-slate-400 mb-2">æ–°å¢é ç¹³/è£œç¹³</h3>
                            <div class="flex gap-2"><input type="date" id="depDate" class="w-1/2 compact-input"><input type="number" id="depAmount" class="w-1/2 compact-input text-center font-black" placeholder="é‡‘é¡"></div>
                            <div class="flex flex-col gap-2">
                                <button id="btnBulkDep" onclick="addBulkDep()" class="w-full bg-amber-500 text-white p-3 rounded-xl font-black text-xs">å…¨å“¡é ç¹³</button>
                                <div class="flex gap-2"><select id="depMember" class="flex-1 p-2 border rounded-xl text-xs font-bold"></select><button id="btnSingleDep" onclick="addSingleDep()" class="bg-slate-800 text-white px-4 rounded-xl font-bold text-xs">å–®äººè£œç¹³</button></div>
                                <button id="cancelDepEdit" onclick="resetDepForm()" class="hidden w-full bg-slate-200 text-slate-600 p-2 rounded-xl font-bold text-xs mt-2">å–æ¶ˆç·¨è¼¯</button>
                            </div>
                        </div>
                    </details>
                </div>

                <div class="space-y-4">
                    <details class="dropdown-card border-l-8 border-amber-200"><summary class="dropdown-summary">ğŸ“’ å…¬å¸³æ”¶å…¥æ˜ç´°</summary><div id="incomeTimeline" class="p-4 pt-0"></div></details>
                    <details class="dropdown-card border-l-8 border-emerald-400"><summary class="dropdown-summary">ğŸ’° å…¬å¸³æ”¯ä»˜æ˜ç´°</summary><div id="publicTimeline" class="p-4 pt-0"></div></details>
                    
                    <details class="dropdown-card border-l-8 border-indigo-400"><summary class="dropdown-summary text-indigo-800"><span>ğŸ‘¤ å€‹äººä»£å¢Šæ˜ç´°</span><span>â–¼</span></summary>
                        <div class="px-4 pb-4">
                            <div class="flex gap-2 mb-4 p-1 bg-slate-100 rounded-[12px]">
                                <button id="btnFilterAll" onclick="setPersonalFilter('all')" class="toggle-btn btn-all-active">å…¨éƒ¨ä»£å¢Š</button>
                                <button id="btnFilterSelf" onclick="setPersonalFilter('personal')" class="toggle-btn btn-inactive">æˆ‘çš„ç›¸é—œ (ç¯©é¸ä¸­)</button>
                            </div>
                            <div id="personalTimeline"></div>
                        </div>
                    </details>

                    <details class="dropdown-card border-l-8 border-slate-900 bg-slate-900 text-white"><summary class="dropdown-summary text-yellow-400">ğŸ æœ€çµ‚çµç®—å ±å‘Š</summary>
                        <div class="p-4 pt-0">
                            <div class="flex gap-1 mb-4 bg-white/5 p-1 rounded-xl">
                                <button onclick="setSettleMode('TWD')" id="btnSettleTWD" class="flex-1 py-2 rounded-lg font-black text-[11px] transition-all">å°å¹£</button>
                                <button onclick="setSettleMode('SUB')" id="btnSettleSUB" class="flex-1 py-2 rounded-lg font-black text-[11px] transition-all">å¤–å¹£</button>
                                <button onclick="setSettleMode('MIX')" id="btnSettleMIX" class="flex-1 py-2 rounded-lg font-black text-[11px] transition-all">åˆä½µ(å°å¹£çµæ¸…)</button>
                            </div>
                            <div id="balanceAudit" class="bg-white/10 rounded-2xl p-2 mb-4 text-xs"></div>
                            <div id="splitResult" class="space-y-2 mb-6"></div>
                            <div id="adminSettleBtn" class="hidden border-t border-white/10 pt-4"><button onclick="toggleSettlement()" class="w-full bg-rose-500/20 text-rose-300 p-3 rounded-xl font-black text-xs border border-rose-500/30">å•Ÿå‹•/è§£é™¤çµç®—å°å­˜</button></div>
                        </div>
                    </details>

                    <details id="adminMemberSettings" class="hidden dropdown-card border-l-8 border-slate-400 bg-slate-50">
                        <summary class="dropdown-summary text-slate-700">âš™ï¸ ç®¡ç†å“¡è¨­å®š</summary>
                        <div class="p-5 space-y-4">
                            <input type="text" id="memberInput" class="w-full p-3 bg-white border rounded-xl font-bold text-sm" placeholder="æˆå“¡ (é€—è™Ÿåˆ†éš”)">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="subCurrencyInput" class="w-full p-3 bg-white border rounded-xl font-bold text-sm" placeholder="å¤–å¹£åç¨±">
                                <input type="number" id="exchangeRateInput" step="0.0001" class="w-full p-3 bg-white border rounded-xl font-bold text-sm" placeholder="åŒ¯ç‡">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <select id="adminTransferSelect" class="w-full p-3 bg-white border rounded-xl font-bold text-sm"></select>
                                <input type="text" id="adminPassInput" class="w-full p-3 bg-white border rounded-xl font-bold text-sm" placeholder="ç®¡ç†å¯†ç¢¼">
                            </div>
                            <button onclick="confirmAdminSettings()" class="w-full bg-slate-800 text-white p-4 rounded-2xl font-black text-sm">å„²å­˜è¨­å®š</button>
                            <button onclick="clearAllData()" class="w-full bg-rose-50 text-rose-600 border border-rose-200 p-4 rounded-2xl font-black text-xs">âš ï¸ æ¸…ç©ºæ‰€æœ‰å¸³ç›®</button>
                        </div>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://project-2641836624074325409-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const CREATE_SECRET = "TripSplit-Secure-2026";
        
        let members = [], expenses = [], deposits = [], manager = "", managerPass = "1234", roomId = "", roomPass = "";
        let isSettled = false, currentCurrency = "TWD", subCurrency = "JPY", exchangeRate = 0.22, settleMode = "TWD", editingId = null, depEditingId = null, personalFilter = 'all';
        const emojis = { "æ—©é¤":"ğŸ³", "åˆé¤":"ğŸ±", "æ™šé¤":"ğŸ½ï¸", "é»å¿ƒ":"ğŸ°", "äº¤é€š":"ğŸš—", "ä½å®¿":"ğŸ¨", "è³¼ç‰©":"ğŸ›ï¸", "å…¶ä»–":"ğŸ·ï¸" };

        async function handleAuth(mode) {
            const rid = document.getElementById('roomId').value.trim(), rps = document.getElementById('roomPass').value.trim();
            if (!rid || !rps) return alert("è«‹è¼¸å…¥ ID èˆ‡æš—è™Ÿ");

            if (mode === 'create') {
                if (prompt("å»ºç«‹æˆ¿é–“å®‰å…¨å¯†ç¢¼ï¼š") !== CREATE_SECRET) return alert("å¯†ç¢¼éŒ¯èª¤");
                const initialMembers = prompt("è«‹è¼¸å…¥åˆå§‹æˆå“¡åå–® (ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚: å°æ˜,å°è¯,ç¾ç¾)ï¼š");
                if (!initialMembers) return alert("å¿…é ˆè¼¸å…¥æˆå“¡åå–®æ‰èƒ½é–‹ç°¿");
                const memberList = initialMembers.split(',').map(s => s.trim()).filter(s => s);
                if (memberList.length === 0) return alert("ç„¡æ•ˆçš„æˆå“¡æ¸…å–®");

                const snap = await db.ref('rooms/' + rid).once('value');
                if (snap.val()) return alert("ID å·²å­˜åœ¨");
                
                roomId = rid; roomPass = rps;
                await db.ref('rooms/' + rid).set({ 
                    password: rps, manager: "", managerPass: "1234", isSettled: false, 
                    members: memberList, subCurrency: "JPY", exchangeRate: 0.22 
                });
                startSync();
                alert("å¸³ç°¿å»ºç«‹æˆåŠŸï¼è«‹å¾é¸å–®é–å®šèº«åˆ†æˆç‚ºç®¡ç†å“¡ã€‚");
            } else {
                const snap = await db.ref('rooms/' + rid).once('value'), data = snap.val();
                if (!data || data.password !== rps) return alert("IDä¸å­˜åœ¨æˆ–æš—è™ŸéŒ¯èª¤");
                roomId = rid; roomPass = rps; startSync();
            }
        }

        function startSync() {
            if (document.getElementById('rememberId').checked) localStorage.setItem('saved_room_id', roomId);
            else localStorage.removeItem('saved_room_id');
            db.ref('rooms/' + roomId).on('value', (snap) => {
                const data = snap.val(); if (!data) return;
                members = data.members || []; expenses = data.expenses || []; deposits = data.deposits || [];
                manager = data.manager || ""; managerPass = data.managerPass || "1234";
                subCurrency = data.subCurrency || "å¤–å¹£"; exchangeRate = data.exchangeRate || 1; isSettled = data.isSettled || false;
                updateUI();
            });
        }

        function updateUI() {
            document.getElementById('mainUI').classList.remove('hidden');
            document.getElementById('loginSection').classList.add('hidden');
            document.querySelectorAll('.cur-text').forEach(el => el.innerText = currentCurrency);
            
            const user = localStorage.getItem(`locked_user_${roomId}`);
            const isAdmin = (manager === "" || user === manager);
            
            document.getElementById('btnSwitchTWD').className = currentCurrency === 'TWD' ? "flex-1 py-3 rounded-xl font-black text-xs cur-btn-active-twd" : "flex-1 py-3 rounded-xl font-black text-xs cur-btn-inactive";
            document.getElementById('btnSwitchSUB').innerText = subCurrency;
            document.getElementById('btnSwitchSUB').className = currentCurrency !== 'TWD' ? "flex-1 py-3 rounded-xl font-black text-xs cur-btn-active-sub" : "flex-1 py-3 rounded-xl font-black text-xs cur-btn-inactive";
            document.getElementById('btnFilterAll').className = personalFilter === 'all' ? "toggle-btn btn-all-active" : "toggle-btn btn-inactive";
            document.getElementById('btnFilterSelf').className = personalFilter === 'personal' ? "toggle-btn btn-self-active" : "toggle-btn btn-inactive";
            document.getElementById('btnSettleTWD').className = settleMode === 'TWD' ? "flex-1 py-2 rounded-lg font-black text-[11px] bg-indigo-600 text-white" : "flex-1 py-2 rounded-lg font-black text-[11px] bg-white/5 opacity-50";
            document.getElementById('btnSettleSUB').className = settleMode === 'SUB' ? "flex-1 py-2 rounded-lg font-black text-[11px] bg-amber-500 text-white" : "flex-1 py-2 rounded-lg font-black text-[11px] bg-white/5 opacity-50";
            document.getElementById('btnSettleMIX').className = settleMode === 'MIX' ? "flex-1 py-2 rounded-lg font-black text-[11px] bg-emerald-500 text-white" : "flex-1 py-2 rounded-lg font-black text-[11px] bg-white/5 opacity-50";

            document.getElementById('adminMemberSettings').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('depositBox').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('adminSettleBtn').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('settledBanner').classList.toggle('hidden', !isSettled);

            updateForm(); 
            renderDateGroupedTimeline('incomeTimeline', deposits.filter(d => (d.currency||'TWD') === currentCurrency), 'deposit');
            renderDateGroupedTimeline('publicTimeline', expenses.filter(e => e.paid_by === "å…¬å¸³" && (e.currency||'TWD') === currentCurrency), 'expense');
            renderPersonalTimelineGrouped();
            calculate();
        }

        function calculate() {
            const auditBox = document.getElementById('balanceAudit'), splitBox = document.getElementById('splitResult');
            let finalAuditHTML = "", finalSplitHTML = "";
            const getBal = (cur) => {
                const paid = {}, consumed = {}; members.forEach(m => { paid[m] = 0; consumed[m] = 0; });
                let tDep = 0, tExp = 0;
                deposits.filter(d => (d.currency||'TWD') === cur).forEach(d => { 
                    const a = d.amount; if(d.from === "å…¨å“¡") { members.forEach(m => paid[m] += a); tDep += a * members.length; } else { paid[d.from] += a; tDep += a; } 
                });
                expenses.filter(e => (e.currency||'TWD') === cur).forEach(e => { 
                    const per = e.amount / e.inv.length; if(e.paid_by === "å…¬å¸³") { tExp += e.amount; } else { paid[e.paid_by] += e.amount; } e.inv.forEach(m => consumed[m] += per); 
                });
                const net = {}; members.forEach(m => { net[m] = paid[m] - consumed[m]; if (m === manager) net[m] -= (tDep - tExp); });
                return { net, fund: (tDep - tExp), paid, consumed };
            };
            const twdData = getBal('TWD'), subData = getBal(subCurrency);
            document.getElementById('fundBalance').innerText = `$${Math.round(currentCurrency === 'TWD' ? twdData.fund : subData.fund)}`;
            let finalBal = {};
            if (settleMode === 'MIX') {
                members.forEach(m => { finalBal[m] = twdData.net[m] + (subData.net[m] * exchangeRate); });
                finalAuditHTML = `<div class="p-2 text-center text-emerald-400 font-bold">åˆä½µçµç®— (åŒ¯ç‡ ${exchangeRate} è½‰å°å¹£)</div>`;
            } else {
                const data = (settleMode === 'TWD' ? twdData : subData);
                members.forEach(m => finalBal[m] = data.net[m]);
                finalAuditHTML = members.map(m => `<div class="grid grid-cols-4 text-center py-1"><span>${m}</span><span class="opacity-40">$${Math.round(data.paid[m])}</span><span class="opacity-40">$${Math.round(data.consumed[m])}</span><span class="${finalBal[m]>=0?'text-emerald-400':'text-rose-400'} font-black">$${Math.round(finalBal[m])}</span></div>`).join('');
            }
            let cr = [], dbts = []; Object.keys(finalBal).forEach(m => { if(finalBal[m]>0.5) cr.push({n:m, v:finalBal[m]}); else if(finalBal[m]<-0.5) dbts.push({n:m, v:Math.abs(finalBal[m])}); });
            let i=0, j=0; while(i<dbts.length && j<cr.length) { 
                let a = Math.min(dbts[i].v, cr[j].v); 
                finalSplitHTML += `<div class="bg-white/5 p-3 rounded-xl flex justify-between text-[11px] font-bold border-l-4 border-indigo-500"><span>${dbts[i].n} â” ${cr[j].n}</span><span class="text-yellow-400">${settleMode==='MIX'?'NT$':''}${Math.round(a)}</span></div>`; 
                dbts[i].v -= a; cr[j].v -= a; if(dbts[i].v<=0.5) i++; if(cr[j].v<=0.5) j++; 
            }
            auditBox.innerHTML = finalAuditHTML; splitBox.innerHTML = finalSplitHTML || "<p class='text-center opacity-30 py-4 text-xs italic'>å·²çµæ¸…</p>";
        }

        function renderDateGroupedTimeline(cId, data, type) {
            const container = document.getElementById(cId), user = localStorage.getItem(`locked_user_${roomId}`);
            container.innerHTML = ""; if (!data.length) return;
            let currentDate = "";
            [...data].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(item => {
                if (item.date !== currentDate) { currentDate = item.date; container.innerHTML += `<div class="mt-4 mb-2"><span class="date-label">${currentDate}</span></div>`; }
                const isAdmin = (user === manager), canEdit = (!isSettled && (type === 'deposit' ? isAdmin : (isAdmin || user === item.paid_by)));
                container.innerHTML += `<div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center border border-slate-100 mb-1 mx-1 shadow-sm"><div class="flex items-center gap-2"><div><div class="font-black text-slate-700 text-xs">${item.from === "å…¨å“¡" ? "ğŸ‘¥ å…¨å“¡é ç¹³" : (item.desc || item.from)}</div></div></div><div class="text-right"><div class="font-black ${type==='deposit'?'text-amber-600':'text-slate-900'}">$${Math.round(item.amount)}</div>${canEdit ? `<div class="flex mt-1 justify-end"><button onclick="${type==='deposit'?'editDep':'editExp'}(${item.id})" class="btn-action bg-slate-200 text-slate-500">ç·¨è¼¯</button><button onclick="${type==='deposit'?'delDep':'delExp'}(${item.id})" class="btn-action bg-rose-50 text-rose-500">åˆªé™¤</button></div>`:''}</div></div>`;
            });
        }

        function renderPersonalTimelineGrouped() {
            const container = document.getElementById('personalTimeline'), user = localStorage.getItem(`locked_user_${roomId}`);
            container.innerHTML = ""; let filtered = expenses.filter(e => e.paid_by !== "å…¬å¸³" && (e.currency||'TWD') === currentCurrency);
            if (personalFilter === 'personal' && user) filtered = filtered.filter(e => (user === e.paid_by || (e.inv && e.inv.includes(user))));
            if (!filtered.length) { container.innerHTML = "<p class='text-center py-6 text-xs text-slate-300 italic'>ç„¡ç›¸é—œä»£å¢Š</p>"; return; }
            let currentDate = "";
            filtered.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(e => {
                if (e.date !== currentDate) { currentDate = e.date; container.innerHTML += `<div class="mt-4 mb-2"><span class="date-label">${currentDate}</span></div>`; }
                const canEdit = (!isSettled && user && (user === manager || user === e.paid_by || (e.inv && e.inv.includes(user))));
                container.innerHTML += `<div class="bg-slate-50 p-3 rounded-xl flex flex-col gap-1 border border-slate-100 mb-1 mx-1 shadow-sm">
                    <div class="flex justify-between items-center"><div class="flex items-center gap-2"><div class="font-black text-xs text-slate-800">${e.desc}</div></div><div class="font-black text-slate-900">$${Math.round(e.amount)}</div></div>
                    <div class="flex justify-between items-end"><div class="text-[9px] font-bold text-slate-400">${e.paid_by} â” ${e.inv.join(', ')}</div>${canEdit ? `<div><button onclick="editExp(${e.id})" class="btn-action bg-indigo-100 text-indigo-600">ç·¨è¼¯</button><button onclick="delExp(${e.id})" class="btn-action bg-rose-100 text-rose-500">åˆªé™¤</button></div>`:''}</div>
                </div>`;
            });
        }

        function saveExpense() {
            const data = { id: editingId || Date.now(), date: document.getElementById('expDate').value, category: document.getElementById('expCategory').value, desc: document.getElementById('expDesc').value, amount: parseFloat(document.getElementById('expAmount').value), paid_by: document.getElementById('expPayer').value, inv: Array.from(document.querySelectorAll('.m-check:checked')).map(el => el.value), currency: currentCurrency };
            if (!data.date || isNaN(data.amount) || data.inv.length === 0) return alert("å¡«å¯«ä¸å®Œæ•´");
            if (editingId) expenses = expenses.map(x => x.id === editingId ? data : x); else expenses.push(data);
            resetForm(); pushData();
        }

        function addBulkDep() {
            const amt = parseFloat(document.getElementById('depAmount').value), dt = document.getElementById('depDate').value; if(isNaN(amt)) return;
            const data = {id: depEditingId || Date.now(), date: dt, amount: amt, from: "å…¨å“¡", currency: currentCurrency, category: "å…¶ä»–"};
            if (depEditingId) deposits = deposits.map(d => d.id === depEditingId ? data : d); else deposits.push(data);
            resetDepForm(); pushData();
        }

        function addSingleDep() {
            const amt = parseFloat(document.getElementById('depAmount').value), dt = document.getElementById('depDate').value, fr = document.getElementById('depMember').value; if(isNaN(amt)) return;
            const data = {id: depEditingId || Date.now(), date: dt, amount: amt, from: fr, currency: currentCurrency, category: "å…¶ä»–"};
            if (depEditingId) deposits = deposits.map(d => d.id === depEditingId ? data : d); else deposits.push(data);
            resetDepForm(); pushData();
        }

        function editDep(id) {
            const d = deposits.find(x => x.id === id); depEditingId = id;
            document.getElementById('depFormTitle').innerText = "ğŸ“ ç·¨è¼¯æ”¶å…¥ä¸­";
            document.getElementById('depDate').value = d.date;
            document.getElementById('depAmount').value = d.amount;
            document.getElementById('btnBulkDep').innerText = "æ›´æ–°å…¨å“¡é ç¹³";
            document.getElementById('btnSingleDep').innerText = "æ›´æ–°å–®äººè£œç¹³";
            document.getElementById('cancelDepEdit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetDepForm() {
            depEditingId = null; document.getElementById('depFormTitle').innerText = "æ–°å¢é ç¹³/è£œç¹³";
            document.getElementById('depAmount').value = ""; document.getElementById('btnBulkDep').innerText = "å…¨å“¡é ç¹³";
            document.getElementById('btnSingleDep').innerText = "å–®äººè£œç¹³"; document.getElementById('cancelDepEdit').classList.add('hidden');
        }

        function confirmAdminSettings() { 
            members = document.getElementById('memberInput').value.split(',').map(s=>s.trim()).filter(s=>s); 
            subCurrency = document.getElementById('subCurrencyInput').value;
            exchangeRate = parseFloat(document.getElementById('exchangeRateInput').value) || 1;
            manager = document.getElementById('adminTransferSelect').value; 
            managerPass = document.getElementById('adminPassInput').value; 
            pushData(); alert("è¨­å®šå·²å„²å­˜"); 
        }

        function setPersonalFilter(mode) { personalFilter = mode; updateUI(); }
        function lockMyIdentity() { 
            const user = document.getElementById('currentUser').value; if (!user) return; 
            if (manager === "") { db.ref('rooms/' + roomId).update({ manager: user }); } 
            else if (user === manager && prompt("ç®¡ç†å¯†ç¢¼") !== managerPass) return alert("éŒ¯èª¤"); 
            localStorage.setItem(`locked_user_${roomId}`, user); updateUI(); 
        }
        function changeCurrentCurrency(t) { currentCurrency = (t==='TWD'?'TWD':subCurrency); updateUI(); }
        function setSettleMode(m) { settleMode = m; updateUI(); }
        function toggleSettlement() { isSettled = !isSettled; pushData(); }
        function resetForm() { editingId = null; document.getElementById('formTitle').querySelector('span').innerText = "æ–°å¢æ”¯å‡º"; document.getElementById('expDesc').value = ""; document.getElementById('expAmount').value = ""; document.getElementById('cancelEdit').classList.add('hidden'); }
        function editExp(id) { const e = expenses.find(x => x.id === id); editingId = id; document.getElementById('formTitle').querySelector('span').innerText = "ğŸ“ ç·¨è¼¯æ”¯å‡ºä¸­"; document.getElementById('cancelEdit').classList.remove('hidden'); document.getElementById('expDate').value = e.date; document.getElementById('expDesc').value = e.desc; document.getElementById('expAmount').value = e.amount; document.getElementById('expCategory').value = e.category; document.getElementById('expPayer').value = e.paid_by; document.querySelectorAll('.m-check').forEach(ck => ck.checked = e.inv.includes(ck.value)); window.scrollTo({ top: 0, behavior: 'smooth' }); }
        function delExp(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { expenses = expenses.filter(x => x.id !== id); pushData(); } }
        function delDep(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { deposits = deposits.filter(x => x.id !== id); pushData(); } }
        function pushData() { db.ref('rooms/' + roomId).update({ expenses, deposits, isSettled, members, manager, managerPass, subCurrency, exchangeRate }); }
        function logout() { localStorage.removeItem(`locked_user_${roomId}`); location.reload(); }
        function clearAllData() { if (confirm("âš ï¸ æ¸…ç©ºï¼Ÿ") && prompt("å¯†ç¢¼") === managerPass) { expenses = []; deposits = []; pushData(); } }

        function updateForm() { 
            const user = localStorage.getItem(`locked_user_${roomId}`);
            document.getElementById('memberInput').value = members.join(', ');
            document.getElementById('subCurrencyInput').value = subCurrency;
            document.getElementById('exchangeRateInput').value = exchangeRate;
            document.getElementById('adminPassInput').value = managerPass;
            document.getElementById('currentUser').innerHTML = `<option value="">-- æˆ‘æ˜¯ --</option>` + members.map(m => `<option value="${m}" ${m===user?'selected':''}>${m}</option>`).join('');
            document.getElementById('expPayer').innerHTML = ((manager===""||user===manager)?`<option value="å…¬å¸³">âœ¨ å…¬å¸³æ”¯ä»˜</option>`:``) + members.map(m => `<option value="${m}">${m} ä»£å¢Š</option>`).join('');
            document.getElementById('involvedGrid').innerHTML = members.map(m => `<label class="flex items-center gap-1 p-2 bg-slate-50 rounded-xl"><input type="checkbox" checked value="${m}" class="m-check w-4 h-4 accent-indigo-600"><span class="text-[10px] font-bold truncate">${m}</span></label>`).join('');
            if (!document.getElementById('expCategory').innerHTML) document.getElementById('expCategory').innerHTML = Object.keys(emojis).map(k => `<option value="${k}">${emojis[k]} ${k}</option>`).join('');
            document.getElementById('depMember').innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('adminTransferSelect').innerHTML = `<option value="">æœªæŒ‡å®š</option>` + members.map(m => `<option value="${m}" ${m===manager?'selected':''}>${m}</option>`).join('');
            if (user && members.includes(user)) { document.getElementById('currentUser').disabled = true; document.getElementById('btnLockUser').classList.add('hidden'); document.getElementById('lockBadge').classList.remove('hidden'); document.getElementById('displayUserName').innerText = user; document.getElementById('submitBtn').classList.remove('opacity-50', 'pointer-events-none'); }
        }
        window.onload = () => { const now = new Date().toISOString().split('T')[0]; document.getElementById('expDate').value = now; document.getElementById('depDate').value = now; const saved = localStorage.getItem('saved_room_id'); if(saved) { document.getElementById('roomId').value = saved; document.getElementById('rememberId').checked = true; } };
    </script>
</body>
</html>
