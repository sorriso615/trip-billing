<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…éŠåˆ†å¸³åŠ©æ‰‹ v45.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto+Sans+TC', sans-serif; background-color: #f1f5f9; }
        .is-locked { background-color: #e2e8f0 !important; cursor: not-allowed; color: #64748b !important; }
        .btn-disabled { background-color: #cbd5e1 !important; cursor: not-allowed !important; opacity: 0.6; }
        .admin-hidden { display: none !important; }
        .settled-lock { pointer-events: none; opacity: 0.5; position: relative; }
        .settled-lock::after { content: 'ğŸ”’ å¸³ç›®å·²å°å­˜'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 99px; font-weight: 900; z-index: 50; }
        .section-title { position: relative; padding-left: 1rem; border-left: 5px solid #6366f1; font-weight: 900; }
        /* v45 ç‰¹è‰²å¤§åœ“è§’ */
        .card-v45 { border-radius: 2.5rem; }
    </style>
</head>
<body class="p-3 pb-24">

    <div class="max-w-xl mx-auto">
        <div id="status" class="text-[10px] text-center font-bold text-slate-400 mb-2 tracking-widest uppercase italic">ç³»çµ±é€£ç·šä¸­...</div>
        
        <div id="settledBanner" class="hidden bg-rose-600 text-white text-center py-2 rounded-xl mb-4 font-black text-sm animate-pulse shadow-lg">ğŸ ç¸½çµç®—å·²å•Ÿå‹• Â· å¸³ç›®å°å­˜ä¸­</div>

        <div id="loginSection" class="bg-indigo-700 p-8 card-v45 shadow-2xl text-white mb-4">
            <h1 class="text-3xl font-black text-center mb-6 italic tracking-tight">TripSplit v45.1</h1>
            <div class="space-y-3">
                <input type="text" id="roomId" class="w-full p-4 rounded-2xl text-black font-bold text-center outline-none focus:ring-4 ring-yellow-400" placeholder="æˆ¿é–“ ID (ä¾‹å¦‚: Tokyo2024)">
                <input type="password" id="roomPass" class="w-full p-4 rounded-2xl text-black font-bold text-center outline-none focus:ring-4 ring-yellow-400" placeholder="æˆ¿é–“é€²å…¥æš—è™Ÿ">
                <div class="flex items-center justify-center gap-2 py-2">
                    <input type="checkbox" id="rememberId" class="w-5 h-5 accent-yellow-400">
                    <label for="rememberId" class="font-bold text-sm">è¨˜ä½æ­¤æˆ¿é–“ ID</label>
                </div>
                <div class="flex flex-col gap-3">
                    <button onclick="handleAuth('login')" class="w-full bg-yellow-400 text-indigo-900 p-5 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-transform">é€²å…¥å¸³ç°¿</button>
                    <button onclick="handleAuth('create')" class="w-full bg-indigo-800 border-2 border-indigo-400 text-indigo-100 p-4 rounded-2xl font-bold text-sm active:scale-95 transition-transform">ï¼‹ å»ºç«‹å…¨æ–°å¸³ç°¿</button>
                </div>
            </div>
            <p class="text-[10px] text-center mt-6 opacity-60 leading-relaxed italic">
                * è‹¥è¦å»ºç«‹æ–°æˆ¿ï¼Œè«‹è¼¸å…¥æ–°çš„ ID èˆ‡æš—è™Ÿå¾Œé»é¸ã€Œå»ºç«‹ã€<br>
                * ç®¡ç†å“¡é è¨­æš—è™Ÿç‚º 1234
            </p>
        </div>

        <div id="mainUI" class="hidden space-y-6">
            <div class="flex justify-between items-center px-2">
                <div id="adminSettleZone" class="admin-hidden flex-1 mr-2">
                    <button id="btnToggleSettle" onclick="toggleSettlement()" class="w-full py-2 rounded-xl font-black text-xs border-2 flex items-center justify-center gap-2 bg-white">
                        <span id="settleIcon">ğŸ</span> <span id="settleText">å•Ÿå‹•ç¸½çµç®—</span>
                    </button>
                </div>
                <button onclick="logout()" class="bg-slate-200 text-slate-500 px-4 py-2 rounded-xl font-bold text-xs">ç™»å‡º / åˆ‡æ›æˆ¿é–“</button>
            </div>

            <div class="bg-white p-5 card-v45 shadow-sm flex items-center justify-between">
                <div class="flex-1">
                    <label class="text-[10px] font-black text-slate-400 block uppercase italic">Identity</label>
                    <select id="currentUser" class="w-full font-black text-lg outline-none bg-transparent" onchange="updateUI()"></select>
                </div>
                <button id="btnLockUser" onclick="lockMyIdentity()" class="bg-indigo-600 text-white px-5 py-2 rounded-xl font-bold text-sm">é–å®šèº«ä»½</button>
                <div id="lockBadge" class="hidden bg-emerald-100 text-emerald-600 px-4 py-2 rounded-xl font-black text-xs">âœ“ å·²é–å®š</div>
            </div>

            <div class="bg-slate-900 text-white p-7 card-v45 flex justify-between items-end shadow-xl border-b-8 border-emerald-500">
                <div>
                    <p class="text-[10px] opacity-60 font-black mb-1 uppercase tracking-wider">Public Fund</p>
                    <p id="fundFormula" class="text-xs font-mono font-bold text-emerald-400 mb-1">($0) - ($0)</p>
                    <p id="fundBalance" class="text-4xl font-mono font-black text-yellow-400">$0</p>
                </div>
                <div class="text-right">
                    <p class="opacity-50 font-bold uppercase mb-1 text-[9px]">Manager</p>
                    <p id="managerDisplay" class="font-bold text-indigo-300">---</p>
                </div>
            </div>

            <div id="depositBox" class="admin-hidden bg-amber-50 border-2 border-amber-200 card-v45 p-6 space-y-4 shadow-inner">
                <h3 class="font-black text-amber-800 text-sm italic">ğŸ“¥ ç™»è¨˜å…¬å¸³æ”¶å…¥</h3>
                <div class="flex gap-2">
                    <input type="date" id="depDate" class="w-1/2 p-4 rounded-2xl border-none font-bold text-sm bg-white shadow-sm">
                    <input type="number" id="depAmount" class="w-1/2 p-4 rounded-2xl border-none text-center font-black bg-white shadow-sm" placeholder="é‡‘é¡ $">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="addBulkDep()" class="bg-amber-500 text-white p-4 rounded-2xl font-black text-sm shadow-md active:scale-95">å…¨å“¡å„ç¹³ä¸€ä»½</button>
                    <div class="flex flex-col gap-1">
                        <select id="depMember" class="p-2 border rounded-xl text-xs font-bold"></select>
                        <button onclick="addSingleDep()" class="bg-slate-800 text-white p-2 rounded-xl font-bold text-xs">å–®äººè£œç¹³</button>
                    </div>
                </div>
            </div>

            <div id="expenseFormBox" class="bg-white p-6 card-v45 shadow-lg border border-slate-100 relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="formTitle" class="section-title text-2xl text-slate-800 ml-2">æ–°å¢æ”¯å‡º</h2>
                    <button id="cancelEdit" onclick="resetForm()" class="hidden text-xs bg-rose-100 text-rose-500 px-3 py-1 rounded-full font-bold">å–æ¶ˆç·¨è¼¯</button>
                </div>
                <div class="space-y-4">
                    <div class="flex gap-2">
                        <input type="date" id="expDate" class="w-1/2 p-4 bg-slate-100 rounded-2xl font-bold border-none">
                        <select id="expCategory" class="w-1/2 p-4 bg-slate-100 rounded-2xl font-bold border-none"></select>
                    </div>
                    <input type="text" id="expDesc" placeholder="é …ç›®å…§å®¹" class="w-full p-4 bg-slate-100 rounded-2xl font-bold border-none">
                    <div class="flex gap-2">
                        <input type="number" id="expAmount" placeholder="é‡‘é¡" class="w-1/2 p-4 bg-indigo-50 rounded-2xl font-black text-indigo-700 text-2xl border-none">
                        <select id="expPayer" class="w-1/2 p-4 bg-indigo-50 rounded-2xl font-bold border-none text-indigo-700"></select>
                    </div>
                    <div id="involvedGrid" class="grid grid-cols-2 gap-2"></div>
                    <button id="submitBtn" onclick="saveExpense()" class="w-full bg-indigo-600 text-white p-5 rounded-2xl font-black text-xl shadow-xl active:scale-95 transition-all">ç¢ºèªå„²å­˜</button>
                    <p id="lockReminder" class="text-center text-xs text-rose-500 font-bold hidden">âš ï¸ è«‹å…ˆé–å®šèº«ä»½æ‰èƒ½é–‹å§‹ç™»å¸³</p>
                </div>
            </div>

            <div class="space-y-10">
                <section><h2 class="section-title text-xl text-slate-800 mb-4 ml-2" style="border-left-color: #f59e0b;">ğŸ“¥ å…¬å¸³æ”¶å…¥æ˜ç´°</h2><div id="incomeTimeline" class="space-y-4"></div></section>
                <section><h2 class="section-title text-xl text-slate-800 mb-4 ml-2">ğŸ’° å…¬å¸³æ”¯å‡ºæ˜ç´°</h2><div id="publicTimeline" class="space-y-4"></div></section>
                <section><h2 class="section-title text-xl text-slate-800 mb-4 ml-2" style="border-left-color: #64748b;">ğŸ‘¤ å€‹äººä»£å¢Šæ˜ç´°</h2><div id="personalTimeline" class="space-y-4"></div></section>
            </div>

            <div id="settleArea" class="bg-indigo-900 p-9 rounded-[3rem] shadow-2xl text-white">
                <h2 class="text-2xl font-black mb-6 text-center tracking-widest uppercase italic text-yellow-400">Settlement</h2>
                <div class="bg-white/10 rounded-3xl p-5 mb-6 border border-white/20">
                    <div id="balanceAudit" class="space-y-2"></div>
                </div>
                <div id="splitResult" class="space-y-3 mb-8"></div>
                <button onclick="exportCSV()" class="w-full bg-white/10 p-4 rounded-2xl font-bold text-xs mb-3 hover:bg-white/20">ğŸ“¥ ä¸‹è¼‰ CSV å ±è¡¨</button>
                <button id="adminClearBtn" onclick="clearAll()" class="admin-hidden w-full text-rose-300 p-4 rounded-2xl font-black text-[10px] uppercase opacity-40 hover:opacity-100">ğŸ’£ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
            </div>

            <details id="adminMemberSettings" class="admin-hidden bg-white border-2 border-indigo-100 card-v45 overflow-hidden">
                <summary class="p-5 font-black text-indigo-600 cursor-pointer text-center text-sm bg-indigo-50">âš™ï¸ æˆå“¡èˆ‡å®‰å…¨è¨­å®š</summary>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">æˆå“¡åå–® (é€—è™Ÿéš”é–‹)ï¼š</label>
                        <input type="text" id="memberInput" class="w-full p-4 border-2 rounded-2xl font-bold mt-1 outline-none focus:border-indigo-500" onchange="pushData()" placeholder="A, B, C">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">ä¿®æ”¹ç®¡ç†å“¡èº«åˆ†å¯†ç¢¼ï¼š</label>
                        <input type="password" id="managerPassInput" class="w-full p-4 border-2 rounded-2xl font-bold mt-1 outline-none focus:border-rose-500" onchange="updateManagerPass()" placeholder="ç•¶å‰å¯†ç¢¼">
                    </div>
                </div>
            </details>
        </div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://project-2641836624074325409-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let members = [], expenses = [], deposits = [], manager = "", managerPass = "", roomId = "", roomPass = "", editingId = null, isSettled = false;
        const emojis = { "æ—©é¤":"ğŸ³", "åˆé¤":"ğŸ±", "æ™šé¤":"ğŸ½ï¸", "é»å¿ƒ":"ğŸ°", "å®µå¤œ":"ğŸœ", "é£²æ–™":"ğŸ¥¤", "äº¤é€š":"ğŸš—", "ä½å®¿":"ğŸ¨", "é–€ç¥¨":"ğŸ«", "è³¼ç‰©":"ğŸ›ï¸", "å¨›æ¨‚":"ğŸ¡", "å…¶ä»–":"ğŸ·ï¸" };

        // --- ç™»å…¥èˆ‡å»ºç«‹é‚è¼¯å„ªåŒ– ---
        async function handleAuth(mode) {
            roomId = document.getElementById('roomId').value.trim();
            roomPass = document.getElementById('roomPass').value.trim();
            if (!roomId || !roomPass) return alert("è«‹è¼¸å…¥æˆ¿é–“ ID èˆ‡æš—è™Ÿ");

            const snap = await db.ref('rooms/' + roomId).once('value');
            const data = snap.val();

            if (mode === 'login') {
                if (!data) return alert("æ‰¾ä¸åˆ°æ­¤æˆ¿é–“ IDï¼Œè«‹æª¢æŸ¥æ˜¯å¦è¼¸å…¥æ­£ç¢ºï¼Œæˆ–é»é¸ä¸‹æ–¹æŒ‰éˆ•å»ºç«‹æ–°å¸³ç°¿ã€‚");
                if (data.password !== roomPass) return alert("é€²å…¥æš—è™ŸéŒ¯èª¤ï¼");
                startSync();
            } else if (mode === 'create') {
                if (data) return alert("æ­¤æˆ¿é–“ ID å·²è¢«ä½¿ç”¨ï¼Œè«‹æ›´æ›ä¸€å€‹åç¨±ã€‚");
                if (confirm(`ç¢ºå®šè¦å»ºç«‹æˆ¿é–“ã€Œ${roomId}ã€å—ï¼Ÿ`)) {
                    await db.ref('rooms/' + roomId).set({ 
                        password: roomPass, 
                        manager: "", 
                        managerPass: "1234", 
                        isSettled: false,
                        members: ["æˆå“¡1", "æˆå“¡2"] // é è¨­æä¾›å…©å€‹æˆå“¡ç¯„æœ¬
                    });
                    alert("å»ºç«‹æˆåŠŸï¼ç®¡ç†å“¡é è¨­ç¢ºèªå¯†ç¢¼ç‚º 1234");
                    startSync();
                }
            }
        }

        function startSync() {
            if (document.getElementById('rememberId').checked) localStorage.setItem('saved_room_id', roomId);
            
            db.ref('rooms/' + roomId).on('value', (snap) => {
                const data = snap.val();
                if (!data) return;
                members = data.members || []; 
                expenses = data.expenses || []; 
                deposits = data.deposits || []; 
                manager = data.manager || ""; 
                managerPass = data.managerPass || "1234"; 
                isSettled = data.isSettled || false;

                document.getElementById('memberInput').value = members.join(', ');
                document.getElementById('managerPassInput').value = managerPass;
                document.getElementById('mainUI').classList.remove('hidden');
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('status').innerText = `ROOM: ${roomId}`;
                updateUI();
            });
        }

        // --- ä»¥ä¸‹ä¿ç•™ v45 æ ¸å¿ƒé‚è¼¯ ---
        function updateUI() {
            const uSel = document.getElementById('currentUser'), curU = uSel.value;
            uSel.innerHTML = `<option value="">-- æˆ‘æ˜¯èª° --</option>` + members.map(m => `<option value="${m}" ${m===curU?'selected':''}>${m}</option>`).join('');
            
            const savedLockedUser = localStorage.getItem(`locked_user_${roomId}`);
            const isLocked = !!savedLockedUser;
            const isAdminLocked = (isLocked && savedLockedUser === manager);

            if (isLocked) {
                uSel.value = savedLockedUser; uSel.disabled = true; uSel.classList.add('is-locked');
                document.getElementById('btnLockUser').classList.add('hidden');
                document.getElementById('lockBadge').classList.remove('hidden');
                document.getElementById('submitBtn').classList.remove('btn-disabled');
                document.getElementById('lockReminder').classList.add('hidden');
            } else {
                uSel.disabled = false; uSel.classList.remove('is-locked');
                document.getElementById('btnLockUser').classList.remove('hidden');
                document.getElementById('lockBadge').classList.add('hidden');
                document.getElementById('submitBtn').classList.add('btn-disabled');
                document.getElementById('lockReminder').classList.remove('hidden');
            }

            document.getElementById('settledBanner').classList.toggle('hidden', !isSettled);
            document.getElementById('expenseFormBox').classList.toggle('settled-lock', isSettled);
            
            const adminZones = document.querySelectorAll('.admin-hidden');
            adminZones.forEach(el => {
                if (!manager && el.id === 'adminMemberSettings') el.classList.remove('admin-hidden');
                else if (isAdminLocked) el.classList.remove('admin-hidden');
                else el.classList.add('admin-hidden');
            });

            const sBtn = document.getElementById('btnToggleSettle');
            if (isSettled) { 
                sBtn.className = "w-full py-2 rounded-xl font-black text-xs border-2 bg-white border-rose-600 text-rose-600"; 
                document.getElementById('settleText').innerText = "è§£é™¤é–å®šé‡æ–°ç·¨è¼¯"; 
            } else { 
                sBtn.className = "w-full py-2 rounded-xl font-black text-xs border-2 bg-rose-600 border-rose-600 text-white"; 
                document.getElementById('settleText').innerText = "å•Ÿå‹•ç¸½çµç®—"; 
            }

            document.getElementById('managerDisplay').innerText = manager || "æœªè¨­å®š";
            updateForm();
            renderIncomeTimeline();
            renderTimeline('publicTimeline', e => e.paid_by === "å…¬å¸³");
            renderTimeline('personalTimeline', e => e.paid_by !== "å…¬å¸³");
            calculate();
        }

        function lockMyIdentity() {
            const user = document.getElementById('currentUser').value;
            if (!user) return alert("è«‹å…ˆé¸æ“‡å§“å");
            if (!manager) {
                if (confirm(`æ‚¨å°‡æ“”ä»»ç®¡ç†å“¡ã€‚é è¨­ç¢ºèªå¯†ç¢¼ç‚º 1234ï¼Œä¹‹å¾Œå¯ä¿®æ”¹ã€‚`)) {
                    const pass = prompt("è«‹è¨­å®šç®¡ç†å“¡ç¢ºèªå¯†ç¢¼ï¼š", "1234");
                    if (!pass) return;
                    manager = user; managerPass = pass;
                    completeLock(user);
                }
            } else if (user === manager) {
                const inputPass = prompt(`è«‹è¼¸å…¥ã€Œ${user}ã€çš„ç®¡ç†å“¡ç¢ºèªå¯†ç¢¼ï¼š`);
                if (inputPass === managerPass) completeLock(user);
                else alert("å¯†ç¢¼éŒ¯èª¤ï¼");
            } else {
                if (confirm(`é–å®šèº«ä»½ç‚ºã€Œ${user}ã€ï¼Ÿ`)) completeLock(user);
            }
        }

        function updateManagerPass() {
            const newPass = document.getElementById('managerPassInput').value;
            if (newPass) { managerPass = newPass; pushData(); alert("å¯†ç¢¼å·²æ›´æ–°ï¼"); }
        }

        function completeLock(user) { localStorage.setItem(`locked_user_${roomId}`, user); pushData(); updateUI(); }
        function pushData() {
            const input = document.getElementById('memberInput').value;
            members = input.split(',').map(s => s.trim()).filter(s => s !== "");
            db.ref('rooms/' + roomId).update({ members, expenses, deposits, manager, managerPass, isSettled });
        }
        function logout() { if(confirm("ç¢ºå®šè¦ç™»å‡ºï¼Ÿ")) { localStorage.removeItem(`locked_user_${roomId}`); location.reload(); } }

        // --- è¨ˆç®—èˆ‡ Timeline é‚è¼¯ ---
        function calculate() {
            if (members.length === 0) return;
            const paid = {}, consumed = {}, bal = {};
            members.forEach(m => { paid[m] = 0; consumed[m] = 0; bal[m] = 0; });
            let totalFSpent = 0, totalDep = 0;
            deposits.forEach(d => { if (d.from === "å…¨å“¡") { members.forEach(m => paid[m] += d.amount); totalDep += d.amount * members.length; } else if(paid[d.from]!==undefined) { paid[d.from] += d.amount; totalDep += d.amount; } });
            expenses.forEach(e => { const per = e.amount / e.inv.length; if (e.paid_by === "å…¬å¸³") { totalFSpent += e.amount; } else if(paid[e.paid_by]!==undefined) { paid[e.paid_by] += e.amount; } e.inv.forEach(m => { if(consumed[m]!==undefined) consumed[m] += per; }); });
            const fundBalance = Math.round(totalDep - totalFSpent);
            document.getElementById('fundFormula').innerText = `($${Math.round(totalDep)}) - ($${Math.round(totalFSpent)})`;
            document.getElementById('fundBalance').innerText = `$${fundBalance}`;
            members.forEach(m => { bal[m] = paid[m] - consumed[m]; });
            if (manager && bal[manager] !== undefined) bal[manager] -= fundBalance;
            document.getElementById('balanceAudit').innerHTML = members.map(m => {
                const diff = paid[m] - consumed[m];
                return `<div class="grid grid-cols-4 text-center text-[11px] font-bold items-center py-1 border-b border-white/5"><span class="text-left truncate">${m}</span><span>${Math.round(paid[m])}</span><span>${Math.round(consumed[m])}</span><span class="${diff > 0.5 ? 'text-emerald-400' : (diff < -0.5 ? 'text-rose-400' : 'opacity-30')}">${diff > 0.5 ? '+' : ''}${Math.round(diff)}</span></div>`;
            }).join('');
            let cr = [], dbts = [], splits = [];
            Object.keys(bal).forEach(m => { if (bal[m] > 0.5) cr.push({ n: m, v: bal[m] }); else if (bal[m] < -0.5) dbts.push({ n: m, v: Math.abs(bal[m]) }); });
            let i = 0, j = 0;
            while (i < dbts.length && j < cr.length) {
                let a = Math.min(dbts[i].v, cr[j].v);
                if (a > 0.5) splits.push(`<div class="flex justify-between items-center bg-white/10 p-4 rounded-2xl border border-white/20 shadow-inner"><div class="flex items-center gap-2 text-sm"><span class="font-black">${dbts[i].n}</span><span class="text-[9px] bg-white/20 px-2 py-0.5 rounded-full uppercase">Pay to</span><span class="font-black text-yellow-400">${cr[j].n}</span></div><span class="font-mono font-black text-xl">$${Math.round(a)}</span></div>`);
                dbts[i].v -= a; cr[j].v -= a; if (dbts[i].v <= 0.5) i++; if (cr[j].v <= 0.5) j++;
            }
            document.getElementById('splitResult').innerHTML = splits.join('') || "<div class='text-center py-6 font-bold opacity-50 italic text-sm'>âœ¨ å¸³ç›®å·²çµæ¸…</div>";
        }

        function saveExpense() {
            if (isSettled) return;
            const myId = localStorage.getItem(`locked_user_${roomId}`);
            const data = { id: editingId || Date.now(), date: document.getElementById('expDate').value, category: document.getElementById('expCategory').value, desc: document.getElementById('expDesc').value, amount: parseFloat(document.getElementById('expAmount').value), paid_by: document.getElementById('expPayer').value, inv: Array.from(document.querySelectorAll('.m-check:checked')).map(el => el.value) };
            if (!data.date || !data.desc || isNaN(data.amount) || data.inv.length === 0) return alert("è³‡è¨Šä¸é½Šå…¨");
            if (editingId) { const idx = expenses.findIndex(e => e.id === editingId); expenses[idx] = data; } else { expenses.push(data); }
            resetForm(); pushData();
        }

        function updateForm() {
            const user = document.getElementById('currentUser').value;
            const pSel = document.getElementById('expPayer');
            let opts = (user === manager) ? `<option value="å…¬å¸³">âœ¨ å…¬å¸³æ”¯ä»˜</option>` : `<option value="" disabled>ğŸš« å…¬å¸³ (é™ç®¡ç†å“¡)</option>`;
            opts += members.map(m => `<option value="${m}">${m} å€‹äººä»£å¢Š</option>`).join('');
            pSel.innerHTML = opts;
            const grid = document.getElementById('involvedGrid');
            if (grid.innerHTML === "") grid.innerHTML = members.map(m => `<label class="flex items-center gap-2 p-3 bg-slate-50 rounded-2xl border-2 border-transparent has-[:checked]:border-indigo-600"><input type="checkbox" checked value="${m}" class="m-check w-5 h-5 accent-indigo-600"><span class="font-bold text-slate-700 text-sm">${m}</span></label>`).join('');
            const catSel = document.getElementById('expCategory');
            if (catSel.innerHTML === "") catSel.innerHTML = Object.keys(emojis).map(k => `<option value="${k}">${emojis[k]} ${k}</option>`).join('');
            const depM = document.getElementById('depMember');
            depM.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function renderIncomeTimeline() {
            const container = document.getElementById('incomeTimeline'), user = document.getElementById('currentUser').value; container.innerHTML = "";
            if (deposits.length === 0) { container.innerHTML = `<p class="text-center py-5 text-slate-300 font-bold text-xs italic">å°šç„¡æ”¶å…¥ç´€éŒ„</p>`; return; }
            deposits.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(d => {
                const isBulk = (d.from === "å…¨å“¡");
                container.innerHTML += `<div class="bg-white p-4 rounded-[2rem] shadow-sm flex items-center justify-between border-l-8 border-amber-400">
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">${isBulk?'ğŸ‘¥':'ğŸ‘¤'}</div>
                        <div><div class="font-black text-slate-800 text-sm">${isBulk?'å…¨å“¡é ç¹³':d.from+' è£œç¹³'}</div><div class="text-[9px] text-slate-400 font-bold uppercase">${d.date}</div></div>
                    </div>
                    <div class="text-right"><div class="font-mono font-black text-amber-600">$${Math.round(d.amount)}</div>${(!isSettled && user===manager)?`<button onclick="delDep('${d.id}')" class="text-[9px] text-rose-400 font-bold underline">åˆªé™¤</button>`:''}</div>
                </div>`;
            });
        }

        function renderTimeline(id, filter) {
            const container = document.getElementById(id), user = document.getElementById('currentUser').value; container.innerHTML = "";
            const filtered = expenses.filter(filter);
            if (filtered.length === 0) { container.innerHTML = `<p class="text-center py-5 text-slate-300 font-bold text-xs italic">ç„¡ç›¸é—œç´€éŒ„</p>`; return; }
            filtered.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(e => {
                const isF = e.paid_by === "å…¬å¸³";
                const canEdit = !isSettled && (isF ? (user === manager) : (user === e.paid_by || e.inv.includes(user)));
                container.innerHTML += `<div class="bg-white p-5 rounded-[2rem] shadow-sm flex items-center gap-4">
                    <div class="text-3xl">${emojis[e.category] || 'ğŸ·ï¸'}</div>
                    <div class="flex-1"><div class="font-black text-slate-800 text-sm">${e.desc}</div><div class="text-[9px] font-bold ${isF?'text-amber-500':'text-indigo-500'} uppercase">${e.date} Â· ${isF?'å…¬å¸³':e.paid_by}</div></div>
                    <div class="text-right"><div class="font-black text-lg text-slate-900">$${Math.round(e.amount)}</div>${canEdit ? `<div class="flex gap-2 justify-end"><button onclick="editExp(${e.id})" class="text-[9px] text-indigo-400 font-bold">ç·¨è¼¯</button><button onclick="delExp(${e.id})" class="text-[9px] text-rose-400 font-bold">åˆªé™¤</button></div>` : ''}</div>
                </div>`;
            });
        }

        function addBulkDep() { if(isSettled) return; const amt = parseFloat(document.getElementById('depAmount').value), date = document.getElementById('depDate').value; if(isNaN(amt)||!date) return alert("è«‹å¡«å ±é‡‘é¡èˆ‡æ—¥æœŸ"); deposits.push({id:Date.now(), from:"å…¨å“¡", amount:amt, date}); pushData(); }
        function addSingleDep() { if(isSettled) return; const f = document.getElementById('depMember').value, amt = parseFloat(document.getElementById('depAmount').value), date = document.getElementById('depDate').value; if(isNaN(amt)||!date) return alert("è«‹å¡«å ±é‡‘é¡èˆ‡æ—¥æœŸ"); deposits.push({id:Date.now(), from:f, amount:amt, date}); pushData(); }
        function delExp(id) { if(!isSettled && confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { expenses = expenses.filter(x => x.id !== id); pushData(); } }
        function delDep(id) { if(!isSettled && confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { deposits = deposits.filter(x => x.id.toString() !== id.toString()); pushData(); } }
        function editExp(id) { if(isSettled) return; const e = expenses.find(x => x.id === id); editingId = id; document.getElementById('formTitle').innerText = "ğŸ“ ç·¨è¼¯ä¸­..."; document.getElementById('cancelEdit').classList.remove('hidden'); document.getElementById('expDate').value = e.date; document.getElementById('expDesc').value = e.desc; document.getElementById('expAmount').value = e.amount; document.getElementById('expCategory').value = e.category; document.getElementById('expPayer').value = e.paid_by; document.querySelectorAll('.m-check').forEach(ck => ck.checked = e.inv.includes(ck.value)); window.scrollTo({ top: 400, behavior: 'smooth' }); }
        function resetForm() { editingId = null; document.getElementById('formTitle').innerText = "æ–°å¢æ”¯å‡º"; document.getElementById('expDesc').value = ""; document.getElementById('expAmount').value = ""; document.getElementById('cancelEdit').classList.add('hidden'); }
        function toggleSettlement() { if (confirm(isSettled ? "ç¢ºå®šè§£é™¤é–å®šï¼Ÿ" : "å•Ÿå‹•çµç®—å¾Œå¸³ç›®å°‡ç„¡æ³•ç·¨è¼¯ï¼Œç¢ºå®šï¼Ÿ")) { isSettled = !isSettled; pushData(); } }
        function exportCSV() { let csv = "\ufeffæ—¥æœŸ,é¡åˆ¥,é …ç›®,é‡‘é¡,æ”¯ä»˜è€…,åˆ†æ“”è€…\n"; expenses.forEach(e => csv += `${e.date},${e.category},${e.desc},${e.amount},${e.paid_by},"${e.inv.join('/')}"\n`); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `çµç®—å ±è¡¨_${roomId}.csv`; a.click(); }
        function clearAll() { if (confirm("ğŸ’£ è­¦å‘Šï¼šå°‡æ°¸ä¹…åˆªé™¤æˆ¿é–“æ‰€æœ‰è³‡æ–™ï¼")) { db.ref('rooms/' + roomId).remove().then(() => { localStorage.removeItem(`locked_user_${roomId}`); location.reload(); }); } }

        window.onload = () => { 
            const now = new Date().toISOString().split('T')[0]; 
            document.getElementById('expDate').value = now; 
            document.getElementById('depDate').value = now; 
            const savedId = localStorage.getItem('saved_room_id'); 
            if (savedId) { document.getElementById('roomId').value = savedId; document.getElementById('rememberId').checked = true; } 
        };
    </script>
</body>
</html>
