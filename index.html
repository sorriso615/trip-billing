<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠåˆ†å¸³åŠ©æ‰‹ v23</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto+Sans+TC', sans-serif; font-size: 1.1rem; }
        input, select, button { font-size: 1rem !important; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .collapsible-content.active { max-height: 1000px; }
        .arrow-icon { transition: transform 0.3s; }
        .arrow-icon.active { transform: rotate(180deg); }
        /* æœªé¸æ“‡ä½¿ç”¨è€…æ™‚çš„éœ‡å‹•æˆ–æé†’æ•ˆæœ */
        .user-warn { background-color: #fef08a !important; border: 2px solid #eab308 !important; }
    </style>
</head>
<body class="bg-slate-100 p-2 md:p-6 text-slate-700">

    <div class="max-w-4xl mx-auto">
        <div id="statusHeader" class="text-center text-[10px] mb-2 font-bold text-rose-500 uppercase tracking-widest">âš ï¸ å°šæœªé€£ç·š</div>
        
        <div id="loginBox" class="bg-indigo-600 text-white p-6 rounded-3xl shadow-xl mb-6">
            <h1 class="text-2xl font-bold mb-6 text-center">âœˆï¸ é›²ç«¯æ—…éŠåˆ†å¸³ v23</h1>
            <div class="space-y-4">
                <div class="flex flex-col md:flex-row gap-3">
                    <button onclick="prepareNewLedger()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-3 rounded-2xl font-bold shadow-md">â• é–‹æ–°å¸³ç°¿</button>
                    <div class="flex-1">
                        <input type="text" id="roomId" class="w-full p-3 rounded-2xl text-black border-none outline-none" placeholder="è¼¸å…¥æˆ¿é–“ ID">
                        <label class="flex items-center gap-1 mt-2 text-[10px] cursor-pointer px-1 text-indigo-100">
                            <input type="checkbox" id="saveIdCheck" class="w-4 h-4 accent-emerald-400"> è¨˜ä½æˆ¿é–“ ID
                        </label>
                    </div>
                    <input type="password" id="roomPass" class="md:w-32 p-3 rounded-2xl text-black border-none outline-none" placeholder="æš—è™Ÿ">
                </div>
                <button onclick="initSync()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-indigo-900 p-4 rounded-2xl font-black text-lg shadow-lg transition-all">é€²å…¥æˆ¿é–“</button>
            </div>
        </div>

        <div id="mainUI" class="hidden space-y-4">
            
            <div class="bg-indigo-700 p-5 rounded-3xl shadow-xl border-b-8 border-indigo-900">
                <div class="flex items-center justify-between">
                    <span class="font-black text-white text-lg">ğŸ‘¤ æˆ‘æ˜¯ï¼š</span>
                    <select id="currentUser" class="p-3 rounded-2xl font-black text-indigo-700 outline-none min-w-[180px] shadow-inner" onchange="checkAuth()">
                        <option value="">âš ï¸ è«‹å…ˆé¸æ“‡å§“å</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <button onclick="toggleCollapsible('setupContent', 'setupArrow')" class="w-full p-4 flex justify-between items-center bg-slate-50 hover:bg-slate-100 transition">
                        <span class="font-bold text-slate-500">âš™ï¸ å¸³ç°¿è¨­å®š</span>
                        <span id="setupArrow" class="arrow-icon text-slate-400">â–¼</span>
                    </button>
                    <div id="setupContent" class="collapsible-content px-4">
                        <div class="py-4 space-y-3 border-t">
                            <input type="text" id="memberInput" class="w-full p-3 border-2 rounded-xl text-sm" onchange="pushData()" placeholder="æˆå“¡å§“å (ç”¨é€—è™Ÿéš”é–‹)">
                            <div class="flex items-center justify-between px-1">
                                <span class="text-xs font-bold text-orange-500">ğŸŒŸ ç®¡ç†å“¡:</span>
                                <select id="fundManager" class="p-2 border-2 rounded-xl bg-yellow-50 font-bold text-sm" onchange="handleManagerChange()"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="depositSection" class="bg-white rounded-3xl shadow-sm border border-orange-200 overflow-hidden">
                    <button onclick="toggleCollapsible('depositContent', 'depositArrow')" class="w-full p-4 flex justify-between items-center bg-orange-50 hover:bg-orange-100 transition">
                        <span class="font-bold text-orange-600">ğŸ“¥ é ç¹³æ”¶éŒ¢</span>
                        <div class="flex items-center gap-2">
                            <span id="lockHint" class="text-[10px] bg-rose-100 text-rose-500 px-2 py-1 rounded font-bold">èº«åˆ†é–å®š</span>
                            <span id="depositArrow" class="arrow-icon text-orange-300">â–¼</span>
                        </div>
                    </button>
                    <div id="depositContent" class="collapsible-content px-4">
                        <div class="py-4 space-y-3 border-t">
                            <div class="flex gap-2">
                                <input type="date" id="depDate" class="w-1/2 p-2 border-2 rounded-xl text-sm font-bold">
                                <input type="number" id="depAmount" placeholder="æ¯äººé‡‘é¡" class="w-1/2 p-2 border-2 rounded-xl text-sm font-mono font-bold">
                            </div>
                            <button id="btnBulk" onclick="addBulkDeposit()" disabled class="w-full bg-slate-300 text-white p-3 rounded-2xl font-black text-sm">å…¨å“¡çµ±ä¸€æ”¶éŒ¢</button>
                            <div class="flex gap-2">
                                <select id="depMember" class="flex-1 p-2 border-2 rounded-xl text-xs"></select>
                                <button id="btnSingle" onclick="addSingleDeposit()" disabled class="bg-slate-300 text-white px-3 py-2 rounded-xl font-bold text-xs">å–®äººæ”¶</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-5 rounded-3xl text-white shadow-lg flex justify-around text-center">
                <div><p class="text-[10px] opacity-50">ç¸½é æ”¶</p><p id="totalDeposit" class="font-mono font-bold text-emerald-400"></p></div>
                <div><p class="text-[10px] opacity-50">ç¸½æ”¯å‡º</p><p id="fundSpent" class="font-mono font-bold text-rose-400"></p></div>
                <div class="border-l border-white/10 pl-4"><p class="text-[10px] text-yellow-400 font-bold">å…¬å¸³é¤˜é¡</p><p id="fundBalance" class="font-mono font-bold text-2xl text-yellow-400"></p></div>
            </div>

            <div id="expenseBox" class="p-6 bg-white rounded-3xl shadow-md border-2 border-indigo-50">
                <h2 class="font-bold text-slate-600 mb-4 border-l-4 border-indigo-500 pl-3">ğŸ–Šï¸ æ–°å¢æ¶ˆè²»</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex gap-2">
                        <input type="date" id="expDate" class="w-1/2 p-3 border-2 rounded-xl font-bold bg-slate-50">
                        <select id="expCategory" class="w-1/2 p-3 border-2 rounded-xl font-bold">
                            <option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option><option>é»å¿ƒ</option>
                            <option>å®µå¤œ</option><option>é£²æ–™</option><option>é–€ç¥¨</option><option>äº¤é€š</option>
                            <option>å¨›æ¨‚</option><option selected>å…¶ä»–</option>
                        </select>
                    </div>
                    <input type="text" id="expDesc" placeholder="æ¶ˆè²»é …ç›®å…§å®¹" class="p-3 border-2 rounded-xl">
                    <div class="flex gap-2">
                        <input type="number" id="expAmount" placeholder="é‡‘é¡" class="w-1/2 p-3 border-2 rounded-xl font-mono text-lg font-bold">
                        <select id="expPayer" class="w-1/2 p-3 border-2 rounded-xl font-bold text-indigo-700 bg-indigo-50"></select>
                    </div>
                    <button id="btnSubmitExp" onclick="addExpense()" class="bg-slate-300 text-white p-4 rounded-2xl font-black text-lg shadow-md transition-all">è«‹å…ˆé¸æ“‡èº«åˆ†</button>
                </div>
                <div id="involvedChecks" class="mt-4 flex flex-wrap gap-2 p-3 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white rounded-2xl shadow-sm border-t-4 border-orange-500 overflow-hidden text-sm">
                    <div class="bg-orange-50 p-2 font-bold flex justify-between"><span>ğŸ“™ å…¬å¸³æ”¯å‡º</span><span id="subtotalFund"></span></div>
                    <div id="listFund" class="max-h-[300px] overflow-y-auto"></div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border-t-4 border-blue-500 overflow-hidden text-sm">
                    <div class="bg-blue-50 p-2 font-bold flex justify-between"><span>ğŸ“˜ å€‹äººä»£å¢Š</span><span id="subtotalIndiv"></span></div>
                    <div id="listIndiv" class="max-h-[300px] overflow-y-auto"></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border-t-4 border-emerald-500 overflow-hidden text-sm">
                <div class="bg-emerald-50 p-2 font-bold flex justify-between text-emerald-800"><span>ğŸ’µ é ç¹³é›†è³‡ç´€éŒ„ (åˆä½µ)</span><span id="subtotalDeposit"></span></div>
                <div id="listDeposit" class="max-h-[200px] overflow-y-auto bg-slate-50/50"></div>
            </div>

            <div class="p-8 bg-white rounded-3xl border-4 border-emerald-500 shadow-2xl">
                <h2 class="font-black text-emerald-800 text-xl mb-6 text-center">ğŸ çµç®—å»ºè­° (å››æ¨äº”å…¥)</h2>
                <div id="splitResult" class="grid grid-cols-1 gap-3"></div>
                <div class="mt-8 flex gap-3 border-t pt-6">
                    <button onclick="exportCSV()" class="flex-1 bg-slate-100 p-3 rounded-xl font-bold text-xs">ğŸ“¥ ä¸‹è¼‰å ±è¡¨</button>
                    <button onclick="clearAllData()" class="flex-1 bg-rose-50 text-rose-600 p-3 rounded-xl font-bold text-xs">âš ï¸ æ¸…ç©ºå¸³ç°¿</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://project-2641836624074325409-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let members = [], expenses = [], deposits = [], roomId = "", roomPass = "", manager = "";
        const catEmoji = { "æ—©é¤":"ğŸ³", "åˆé¤":"ğŸ±", "æ™šé¤":"ğŸ½ï¸", "é»å¿ƒ":"ğŸ°", "å®µå¤œ":"ğŸŒ™", "é£²æ–™":"ğŸ¥¤", "é–€ç¥¨":"ğŸ«", "äº¤é€š":"ğŸš—", "å¨›æ¨‚":"ğŸ®", "å…¶ä»–":"ğŸ·ï¸" };
        
        window.onload = function() {
            document.getElementById('expDate').valueAsDate = new Date();
            document.getElementById('depDate').valueAsDate = new Date();
            const sid = localStorage.getItem('last_room_id');
            if (sid) { document.getElementById('roomId').value = sid; document.getElementById('saveIdCheck').checked = true; }
        };

        function prepareNewLedger() {
            const rid = 'trip-' + Math.random().toString(36).substr(2, 6);
            document.getElementById('roomId').value = rid;
            alert("æ–° ID: " + rid);
        }

        function toggleCollapsible(cId, aId) {
            document.getElementById(cId).classList.toggle('active');
            document.getElementById(aId).classList.toggle('active');
        }

        function initSync() {
            roomId = document.getElementById('roomId').value.trim();
            roomPass = document.getElementById('roomPass').value.trim();
            if (!roomId || !roomPass) return alert("è«‹è¼¸å…¥ ID èˆ‡å¯†ç¢¼");
            db.ref('rooms/' + roomId).on('value', (snap) => {
                const data = snap.val();
                if (data) {
                    if (data.password && data.password !== roomPass) { alert("å¯†ç¢¼éŒ¯èª¤"); location.reload(); return; }
                    if (document.getElementById('saveIdCheck').checked) localStorage.setItem('last_room_id', roomId);
                    else localStorage.removeItem('last_room_id');
                    members = data.members || []; expenses = data.expenses || []; deposits = data.deposits || []; manager = data.manager || "";
                    document.getElementById('memberInput').value = members.join(', ');
                    document.getElementById('mainUI').classList.remove('hidden');
                    document.getElementById('loginBox').classList.add('hidden');
                    document.getElementById('statusHeader').innerText = "âœ… å·²é€£ç·šï¼š" + roomId;
                    document.getElementById('statusHeader').className = "text-center text-[10px] mb-2 font-bold text-emerald-500 uppercase tracking-widest";
                    updateUI();
                } else { db.ref('rooms/' + roomId).set({ password: roomPass }); }
            });
        }

        function pushData() {
            members = document.getElementById('memberInput').value.split(',').map(s => s.trim()).filter(s => s !== "");
            manager = document.getElementById('fundManager').value;
            db.ref('rooms/' + roomId).update({ members, expenses, deposits, manager });
        }

        function handleManagerChange() {
            manager = document.getElementById('fundManager').value;
            pushData();
        }

        function updateUI() {
            const uSel = document.getElementById('currentUser'), currentVal = uSel.value;
            let uOpts = `<option value="">âš ï¸ è«‹å…ˆé¸æ“‡å§“å</option>`;
            uOpts += members.map(m => `<option value="${m}" ${m===currentVal?'selected':''}>${m}</option>`).join('');
            uSel.innerHTML = uOpts;
            
            document.getElementById('fundManager').innerHTML = members.map(m => `<option value="${m}" ${m===manager?'selected':''}>${m}</option>`).join('');
            document.getElementById('depMember').innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
            checkAuth(); renderLists(); calculate();
        }

        function checkAuth() {
            const u = document.getElementById('currentUser').value, m = document.getElementById('fundManager').value;
            const uSel = document.getElementById('currentUser');
            const btnSubmit = document.getElementById('btnSubmitExp');
            
            // ä½¿ç”¨è€…é¸æ“‡ç‹€æ…‹è™•ç†
            if (!u) {
                uSel.classList.add('user-warn');
                btnSubmit.disabled = true;
                btnSubmit.innerText = "è«‹å…ˆé¸æ“‡èº«åˆ†";
                btnSubmit.className = "bg-slate-300 text-white p-4 rounded-2xl font-black text-lg shadow-md cursor-not-allowed";
            } else {
                uSel.classList.remove('user-warn');
                btnSubmit.disabled = false;
                btnSubmit.innerText = "ç¢ºèªæ–°å¢";
                btnSubmit.className = "bg-indigo-600 text-white p-4 rounded-2xl font-black text-lg shadow-md hover:bg-indigo-700";
            }

            const isM = (u === m && m !== "");
            const btnB = document.getElementById('btnBulk'), btnS = document.getElementById('btnSingle'), depS = document.getElementById('depositSection'), hint = document.getElementById('lockHint');
            
            if (isM) {
                depS.classList.remove('opacity-60'); btnB.disabled = false; btnS.disabled = false;
                btnB.className = "w-full bg-orange-500 text-white p-3 rounded-2xl font-black shadow"; btnS.className = "bg-slate-600 text-white px-3 py-2 rounded-xl font-bold";
                hint.innerText = "ğŸ”“ å·²æˆæ¬Šç®¡ç†"; hint.className = "text-[10px] bg-emerald-100 text-emerald-600 px-2 py-1 rounded font-bold";
            } else {
                depS.classList.add('opacity-60'); btnB.disabled = true; btnS.disabled = true;
                btnB.className = "w-full bg-slate-300 text-white p-3 rounded-2xl font-black cursor-not-allowed"; btnS.className = "bg-slate-300 text-white px-3 py-2 rounded-xl font-bold cursor-not-allowed";
                hint.innerText = u ? "é™ç®¡ç†å“¡æ“ä½œ" : "èº«åˆ†é–å®š"; hint.className = "text-[10px] bg-rose-100 text-rose-500 px-2 py-1 rounded font-bold";
            }

            const pSel = document.getElementById('expPayer'), pVal = pSel.value;
            let opts = isM ? `<option value="å…¬å¸³">âœ¨ å…¬å¸³æ”¯ä»˜</option>` : `<option value="" disabled>ğŸš« å…¬å¸³ (é™ç®¡ç†å“¡)</option>`;
            opts += members.map(mem => `<option value="${mem}" ${mem===pVal?'selected':''}>ğŸ‘¤ ${mem} ä»£å¢Š</option>`).join('');
            pSel.innerHTML = opts;
            
            const inv = document.getElementById('involvedChecks');
            if (inv.innerHTML === "") inv.innerHTML = members.map(mem => `<label class="flex items-center gap-2 cursor-pointer bg-white px-3 py-2 rounded-xl border-2"><input type="checkbox" checked value="${mem}" class="m-check w-5 h-5 accent-indigo-600"> <span class="font-bold text-sm">${mem}</span></label>`).join('');
        }

        function addBulkDeposit() {
            const d = document.getElementById('depDate').value, a = parseFloat(document.getElementById('depAmount').value);
            if (isNaN(a) || a <= 0) return alert("é‡‘é¡éŒ¯èª¤");
            if(confirm(`å…¨å“¡æ”¶éŒ¢ï¼š${members.length} äººå„ $${a}ï¼Œç¢ºå®šï¼Ÿ`)) {
                members.forEach(m => { deposits.push({ id: Date.now() + Math.random(), from: m, amount: a, date: d }); });
                document.getElementById('depAmount').value = ""; pushData();
            }
        }

        function addSingleDeposit() {
            const d = document.getElementById('depDate').value, f = document.getElementById('depMember').value, a = parseFloat(document.getElementById('depAmount').value);
            if (isNaN(a) || a <= 0) return alert("é‡‘é¡éŒ¯èª¤");
            deposits.push({ id: Date.now(), from: f, amount: a, date: d });
            document.getElementById('depAmount').value = ""; pushData();
        }

        function addExpense() {
            const u = document.getElementById('currentUser').value;
            if (!u) return alert("è«‹å…ˆåœ¨ä¸Šæ–¹é¸æ“‡æ‚¨çš„å§“åï¼");
            const d = document.getElementById('expDate').value, c = document.getElementById('expCategory').value, de = document.getElementById('expDesc').value, a = parseFloat(document.getElementById('expAmount').value), p = document.getElementById('expPayer').value, i = Array.from(document.querySelectorAll('.m-check:checked')).map(el => el.value);
            if (!p || isNaN(a) || !de || i.length === 0) return alert("è³‡æ–™ä¸å®Œæ•´");
            expenses.push({ id: Date.now(), date: d, category: c, desc: de, amount: a, paid_by: p, inv: i });
            expenses.sort((a,b) => new Date(a.date) - new Date(b.date));
            pushData(); document.getElementById('expDesc').value = ""; document.getElementById('expAmount').value = "";
        }

        function renderLists() {
            const fBox = document.getElementById('listFund'), iBox = document.getElementById('listIndiv'), dBox = document.getElementById('listDeposit');
            let sF = 0, sI = 0, sD = 0;
            const expH = (e) => `<div class="p-3 border-b group hover:bg-slate-50 relative"><button onclick="deleteExp(${e.id})" class="absolute top-1 right-1 text-rose-300 opacity-0 group-hover:opacity-100 p-1">âœ•</button><div class="text-[9px] text-slate-400">${e.date}</div><div class="flex justify-between font-bold text-xs"><span>${catEmoji[e.category]||''}${e.desc}</span><span class="text-indigo-600 font-mono">$${Math.round(e.amount)}</span></div><div class="text-[8px] mt-1 text-slate-500">ä»˜æ¬¾:${e.paid_by=='å…¬å¸³'?'å…¬':e.paid_by} Â· ğŸ‘¥:${e.inv.join(',')}</div></div>`;
            fBox.innerHTML = expenses.filter(e => e.paid_by === 'å…¬å¸³').map(e => { sF += e.amount; return expH(e); }).join('');
            iBox.innerHTML = expenses.filter(e => e.paid_by !== 'å…¬å¸³').map(e => { sI += e.amount; return expH(e); }).join('');
            const grouped = {};
            deposits.forEach(d => {
                const k = d.date + "_" + d.amount;
                if (!grouped[k]) grouped[k] = { date: d.date, amount: d.amount, people: [], ids: [] };
                grouped[k].people.push(d.from); grouped[k].ids.push(d.id); sD += d.amount;
            });
            dBox.innerHTML = Object.values(grouped).map(g => {
                const isE = g.people.length === members.length && members.length > 0;
                return `<div class="p-2 border-b group hover:bg-slate-100 flex justify-between items-center text-[11px]">
                    <div><span class="text-slate-400 font-mono">${g.date}</span> <span class="px-2 py-0.5 rounded ${isE?'bg-emerald-100 text-emerald-700':'bg-blue-100 text-blue-700'} font-bold">${isE ? 'å…¨å“¡é ç¹³' : g.people.length + 'äººé ç¹³'}</span> <span class="font-bold text-slate-600">$${Math.round(g.amount)}</span></div>
                    <button onclick="deleteBulkDep('${g.ids.join(',')}')" class="text-rose-300 opacity-0 group-hover:opacity-100 p-1">âœ•</button>
                </div>`;
            }).join('') || "<p class='text-center p-4 text-slate-300 text-xs'>å°šç„¡ç¹³è²»ç´€éŒ„</p>";
            document.getElementById('totalDeposit').innerText = `$${Math.round(sD)}`;
            document.getElementById('fundSpent').innerText = `-$${Math.round(sF)}`;
            document.getElementById('fundBalance').innerText = `$${Math.round(sD - sF)}`;
            document.getElementById('subtotalFund').innerText = `$${Math.round(sF)}`;
            document.getElementById('subtotalIndiv').innerText = `$${Math.round(sI)}`;
            document.getElementById('subtotalDeposit').innerText = `$${Math.round(sD)}`;
        }

        function deleteExp(id) { if(confirm("åˆªé™¤ï¼Ÿ")) { expenses = expenses.filter(e => e.id !== id); pushData(); } }
        function deleteBulkDep(idsStr) { if(confirm("ç¢ºå®šåˆªé™¤é€™ç­†ç¹³è²»ï¼Ÿ")) { const ids = idsStr.split(',').map(Number); deposits = deposits.filter(d => !ids.includes(d.id)); pushData(); } }

        function calculate() {
            if (members.length === 0) return;
            const b = {}; members.forEach(m => b[m] = 0);
            let ti = 0, to = 0;
            deposits.forEach(d => { if(b.hasOwnProperty(d.from)) { ti += d.amount; b[d.from] += d.amount; } });
            expenses.forEach(e => {
                const p = e.amount / e.inv.length;
                if (e.paid_by === "å…¬å¸³") { to += e.amount; e.inv.forEach(m => { if(b.hasOwnProperty(m)) b[m] -= p; }); }
                else { if (b.hasOwnProperty(e.paid_by)) b[e.paid_by] += e.amount; e.inv.forEach(m => { if(b.hasOwnProperty(m)) b[m] -= p; }); }
            });
            const r = ti - to; if (manager && b.hasOwnProperty(manager)) b[manager] -= r;
            let cr = [], dbts = [], splits = [];
            Object.keys(b).forEach(n => { let v = b[n]; if (v > 0.5) cr.push({n, v}); else if (v < -0.5) dbts.push({n, v: Math.abs(v)}); });
            let i=0, j=0;
            while(i<dbts.length && j<cr.length) {
                let a = Math.min(dbts[i].v, cr[j].v); 
                splits.push({f: dbts[i].n, t: cr[j].n, a: Math.round(a)});
                dbts[i].v -= a; cr[j].v -= a; if(dbts[i].v <= 0.5) i++; if(cr[j].v <= 0.5) j++;
            }
            document.getElementById('splitResult').innerHTML = splits.map(s => `<div class="bg-indigo-50 p-4 rounded-2xl border-2 border-indigo-200 flex justify-between items-center shadow-sm"><span class="text-base"><b>${s.f}</b> â” <b>${s.t}</b></span><span class="text-rose-600 font-black text-xl font-mono">$${s.a}</span></div>`).join('') || "<p class='text-center text-slate-400 font-bold py-10 w-full'>âœ¨ å¸³ç›®å·²çµæ¸…</p>";
        }

        function exportCSV() {
            let csv = "\ufeffæ—¥æœŸ,é …ç›®,é‡‘é¡,ä»˜æ¬¾äºº,åƒèˆ‡è€…\n";
            expenses.forEach(e => csv += `${e.date},${e.desc},${e.amount},${e.paid_by},"${e.inv.join('/')}"\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
            a.download = `æ—…éŠåˆ†å¸³_${roomId}.csv`; a.click();
        }
        function clearAllData() { if (confirm("æ°¸ä¹…æ¸…é™¤å¸³ç°¿ï¼Ÿ")) { db.ref('rooms/' + roomId).remove(); location.reload(); } }
    </script>
</body>
</html>