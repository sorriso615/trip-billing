<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TripSplit 2026 é›²ç«¯å…±ç·¨ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* å…¨åŸŸè¨­å®š */
        :root { font-size: 16px; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* é›»è…¦ç‰ˆè¨­å®š */
        @media (min-width: 1024px) {
            .app-container { display: grid; grid-template-columns: 420px 1fr; gap: 24px; }
            .sticky-panel { position: sticky; top: 20px; height: fit-content; }
            /* é›»è…¦ç‰ˆ Header å›ºå®šåœ¨ä¸Šæ–¹ */
            header.main-header { position: sticky; top: 0; z-index: 50; }
        }

        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ–æ ¸å¿ƒ (è§£æ±ºæ“‹è·¯å•é¡Œ) */
        @media (max-width: 1024px) {
            /* 1. Header æ”¹ç‚ºä¸å›ºå®šï¼Œéš¨é é¢æ²å‹• */
            header.main-header { position: relative !important; margin-bottom: 10px; padding: 12px !important; }
            
            /* 2. å°‡ä¸‰å€‹å…¬å¸³æ•¸æ“šå¼·åˆ¶æ”¹ç‚ºæ©«å‘æ’åˆ— (çœç©ºé–“) */
            #public-stats-grid { 
                display: grid !important; 
                grid-template-columns: repeat(3, 1fr) !important; 
                gap: 4px !important;
                padding-top: 8px !important;
                margin-top: 8px;
                border-top: 1px solid #e2e8f0;
            }
            /* ç¸®å°æ‰‹æ©Ÿç‰ˆå­—é«” */
            #public-stats-grid p:first-child { font-size: 11px !important; color: #64748b; margin-bottom: 0; }
            #public-stats-grid p:last-child { font-size: 15px !important; margin-top: 0; }

            /* 3. åŠ å¤§é ç±¤æŒ‰éˆ•é–“è·ï¼Œé¿å…èª¤è§¸ */
            #main-tabs { gap: 12px !important; padding-bottom: 5px; }
            
            /* 4. é˜²æ­¢ iOS è¼¸å…¥æ¡†æ”¾å¤§ */
            input, select, textarea { font-size: 16px !important; }
        }
        
        .currency-active { background-color: #2563eb !important; color: white !important; border-color: #2563eb !important; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-3 lg:p-8 pb-20">

    <div id="loading-screen" class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-slate-500 font-bold">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</p>
    </div>

    <div id="login-page" class="max-w-md mx-auto bg-white p-6 lg:p-8 rounded-2xl shadow-xl mt-4 lg:mt-10">
        <h1 class="text-2xl lg:text-3xl font-black text-center text-blue-600 mb-2">TripSplit 2026</h1>
        <p class="text-center text-slate-400 mb-6 text-sm">å¤šäººæ—…éŠé›²ç«¯è¨˜å¸³ãƒ»è‡ªå‹•åŒæ­¥</p>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-slate-600 mb-1">ğŸ“˜ å¸³ç°¿ ID</label>
                <input type="text" id="login-id" placeholder="è¼¸å…¥ ID (ä¾‹å¦‚: Tokyo2026)" class="w-full p-3 border rounded-xl bg-slate-50 focus:ring-2 ring-blue-400 outline-none transition">
            </div>

            <button onclick="checkBookExist()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition active:scale-95">é€²å…¥å¸³ç°¿</button>
            
            <div id="identity-zone" class="hidden animate-fade-in mt-6 pt-6 border-t border-dashed border-slate-200">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <label class="block text-sm font-bold text-blue-800 mb-2">ğŸ‘¤ é¸æ“‡èº«åˆ†</label>
                    <select id="user-select" class="w-full p-3 border rounded-xl bg-white mb-3"></select>
                    
                    <input type="password" id="login-pass" placeholder="ğŸ”‘ å¸³ç°¿å¯†ç¢¼" class="w-full p-3 border rounded-xl mb-3">
                    <div id="admin-pass-input-box" class="hidden">
                        <input type="password" id="admin-login-pass" placeholder="ğŸ›¡ï¸ ç®¡ç†å“¡å¯†ç¢¼" class="w-full p-3 border rounded-xl border-orange-300 bg-orange-50 mb-3 text-orange-800">
                    </div>
                    
                    <label class="flex items-center gap-2 mb-3 text-sm text-slate-600">
                        <input type="checkbox" id="remember-me" checked> è¨˜ä½æˆ‘ (ä¸‹æ¬¡è‡ªå‹•ç™»å…¥)
                    </label>

                    <button onclick="lockIdentityAndEnter()" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold shadow hover:bg-green-600 transition">ç¢ºèªç™»å…¥</button>
                </div>
            </div>

            <div id="new-book-zone" class="hidden animate-fade-in mt-6 pt-6 border-t border-dashed border-slate-200">
                <h3 class="font-black text-lg mb-3 text-slate-700">ğŸ†• å»ºç«‹æ–°å¸³ç°¿</h3>
                <div class="space-y-3">
                    <input type="password" id="secure-code" placeholder="è¨­å®šå¸³ç°¿å¯†ç¢¼" class="w-full p-3 border rounded-xl">
                    <input type="text" id="new-foreign-name" placeholder="å¤–å¹£åç¨± (å¦‚: æ—¥å¹£)" class="w-full p-3 border rounded-xl">
                    <textarea id="new-members" placeholder="æˆå“¡åå–® (ç”¨é€—è™Ÿåˆ†éš”ï¼Œç¬¬ä¸€ä½ç‚ºç®¡ç†å“¡)" class="w-full p-3 border rounded-xl h-24"></textarea>
                    <button onclick="createNewBook()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition">ç«‹å³é–‹æˆ¶</button>
                </div>
            </div>
        </div>
    </div>

    <div id="main-content" class="hidden max-w-6xl mx-auto">
        <header class="main-header bg-white p-4 lg:p-6 rounded-2xl shadow-lg mb-4 transition-all duration-300">
            <div class="flex justify-between items-center mb-2 lg:mb-4 border-b pb-2 lg:pb-4">
                <h1 class="text-xl lg:text-2xl font-black text-slate-800 flex items-center gap-2">
                    <span id="display-user" class="text-sm lg:text-base font-normal bg-slate-100 px-2 py-1 rounded-lg"></span>
                </h1>
                <button onclick="logout()" class="text-xs lg:text-sm text-slate-400 font-bold px-3 py-1 border rounded-lg">ç™»å‡º</button>
            </div>

            <div class="flex flex-col lg:flex-row gap-2 lg:gap-4 lg:items-center">
                <div class="flex gap-2 w-full lg:w-auto">
                    <button id="btn-twd" onclick="switchCurrency('TWD')" class="flex-1 lg:flex-none px-4 py-2 lg:px-6 lg:py-3 rounded-xl font-bold border-2 bg-white text-slate-400 text-sm lg:text-base">å°å¹£</button>
                    <button id="btn-sub" onclick="switchCurrency('SUB')" class="flex-1 lg:flex-none px-4 py-2 lg:px-6 lg:py-3 rounded-xl font-bold border-2 currency-active text-sm lg:text-base">å¤–å¹£</button>
                </div>

                <div id="public-stats-grid" class="grid grid-cols-1 lg:grid-cols-3 gap-2 flex-1 text-center bg-slate-50 p-2 rounded-xl">
                    <div><p class="text-xs text-slate-500">é ç¹³ç¸½é¡</p><p id="sum-income" class="text-lg lg:text-xl font-black text-green-600">$0</p></div>
                    <div class="border-l border-slate-200 hidden lg:block"></div>
                    <div><p class="text-xs text-slate-500">æ”¯å‡ºç¸½é¡</p><p id="sum-expense" class="text-lg lg:text-xl font-black text-red-600">$0</p></div>
                    <div class="border-l border-slate-200 hidden lg:block"></div>
                    <div><p class="text-xs text-slate-500">å…¬å¸³é¤˜é¡</p><p id="sum-balance" class="text-lg lg:text-xl font-black text-blue-600">$0</p></div>
                </div>
            </div>
        </header>

        <div class="app-container">
            <aside class="sticky-panel space-y-4 lg:space-y-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h2 id="tab-add-title" class="text-lg font-black text-slate-700 mb-4 flex items-center gap-2">ğŸ“ æ–°å¢æ”¯å‡º</h2>
                    <div class="space-y-3">
                        <input type="date" id="exp-date" class="w-full p-3 bg-slate-50 border-0 rounded-xl font-bold text-slate-600">
                        <div class="grid grid-cols-3 gap-2">
                            <select id="exp-cat" class="p-3 bg-slate-50 rounded-xl font-bold text-center">
                                <option>ğŸ½ï¸</option><option>ğŸš—</option><option>ğŸ </option><option>ğŸ«</option><option>ğŸ›ï¸</option><option>ğŸ¹</option>
                            </select>
                            <input type="text" id="exp-title" placeholder="é …ç›®åç¨±" class="col-span-2 p-3 bg-slate-50 rounded-xl font-bold">
                        </div>
                        <input type="number" id="exp-amt" placeholder="é‡‘é¡" class="w-full p-4 bg-slate-50 rounded-xl font-black text-xl text-blue-600 text-center placeholder-slate-300">
                        
                        <div class="p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-indigo-800">æ”¯ä»˜æ–¹å¼</label>
                                <select id="exp-path" onchange="togglePayerSelection()" class="text-sm p-1 rounded bg-white border-0 font-bold text-indigo-600">
                                    <option id="opt-public-pay" value="public">å…¬å¸³é¤˜é¡æ”¯ä»˜</option>
                                    <option value="advance">å€‹äººä»£å¢Š (ç§å¸³)</option>
                                </select>
                            </div>
                            
                            <div id="payer-select-div" class="hidden mb-3 animate-fade-in">
                                <label class="text-xs font-bold text-slate-500">èª°å…ˆå¢ŠéŒ¢ï¼Ÿ</label>
                                <select id="payer-member" class="w-full p-2 mt-1 rounded border text-sm font-bold"></select>
                            </div>

                            <label class="text-xs font-bold text-indigo-800 mb-2 block">åˆ†æ”¤æˆå“¡ (é è¨­å…¨å“¡)</label>
                            <div id="splitters-grid" class="grid grid-cols-3 gap-2 text-sm"></div>
                        </div>

                        <button onclick="addRecord()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-black text-lg shadow-lg hover:bg-slate-900 transition active:scale-95">ç¢ºèªè¨˜å¸³</button>
                    </div>
                </div>

                <details id="admin-fund-tab" class="group bg-green-50 p-4 rounded-2xl border border-green-100">
                    <summary class="font-bold text-green-800 cursor-pointer flex justify-between items-center list-none">
                        <span>ğŸ’° å…¬å¸³é ç¹³ (å…¥é‡‘)</span><span class="text-green-400 group-open:rotate-180 transition">â–¼</span>
                    </summary>
                    <div class="mt-4 space-y-3">
                        <input type="date" id="fund-date" class="w-full p-2 rounded border">
                        <input type="number" id="fund-amt" placeholder="æ¯äººé ç¹³é‡‘é¡" class="w-full p-3 rounded border font-bold text-center">
                        <button onclick="addFundRecord()" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold shadow hover:bg-green-700">ç¢ºèªå…¥å¸³</button>
                    </div>
                </details>

                <details id="admin-setting-tab" class="group bg-slate-100 p-4 rounded-2xl">
                    <summary class="font-bold text-slate-600 cursor-pointer flex justify-between items-center list-none">
                        <span>âš™ï¸ è¨­å®š</span><span class="text-slate-400 group-open:rotate-180 transition">â–¼</span>
                    </summary>
                    <div class="mt-4 space-y-3 text-sm">
                        <div><label>æˆå“¡</label><input type="text" id="set-members" class="w-full p-2 rounded border"></div>
                        <div><label>å¹£åˆ¥</label><input type="text" id="set-sub-name" class="w-full p-2 rounded border"></div>
                        <div><label>åŒ¯ç‡</label><input type="number" id="set-rate" class="w-full p-2 rounded border" step="0.001"></div>
                        <div><label>ç®¡ç†å“¡</label><select id="set-manager" class="w-full p-2 rounded border"></select></div>
                        <button onclick="updateSettings()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">å„²å­˜</button>
                        <button onclick="toggleSeal()" class="w-full bg-orange-500 text-white py-2 rounded font-bold">å°å­˜/è§£å°</button>
                    </div>
                </details>
            </aside>

            <main>
                <div id="main-tabs" class="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide touch-pan-x">
                    <button onclick="switchTab('pub', this)" class="tab-btn px-4 py-2 rounded-full font-bold bg-slate-800 text-white whitespace-nowrap shadow-md">ğŸ“Š å…¬å¸³æ˜ç´°</button>
                    <button onclick="switchTab('adv', this)" class="tab-btn px-4 py-2 rounded-full font-bold bg-white text-slate-600 border whitespace-nowrap">âš¡ å€‹äººä»£å¢Š</button>
                    <button onclick="switchTab('my', this)" class="tab-btn px-4 py-2 rounded-full font-bold bg-white text-slate-600 border whitespace-nowrap">ğŸ“’ å€‹äººå¸³ç›®</button>
                    <button onclick="switchTab('final', this)" class="tab-btn px-4 py-2 rounded-full font-bold bg-white text-slate-600 border whitespace-nowrap">ğŸ çµç®—å ±å‘Š</button>
                </div>

                <div id="panel-pub" class="space-y-6 animate-fade-in">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100">
                        <div class="bg-green-50 p-3 font-bold text-green-800 rounded-t-2xl">ğŸ“¥ é ç¹³ç´€éŒ„</div>
                        <div id="income-list" class="divide-y divide-slate-100"></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100">
                        <div class="bg-red-50 p-3 font-bold text-red-800 rounded-t-2xl">ğŸ“¤ æ”¯å‡ºç´€éŒ„</div>
                        <div id="public-exp-list" class="divide-y divide-slate-100"></div>
                    </div>
                </div>

                <div id="panel-adv" class="hidden animate-fade-in bg-white rounded-2xl shadow-sm border border-slate-100">
                    <div class="bg-orange-50 p-3 font-bold text-orange-800 rounded-t-2xl">âš¡ ä»£å¢Šåˆ—è¡¨</div>
                    <div id="adv-list" class="divide-y divide-slate-100"></div>
                </div>

                <div id="panel-my" class="hidden animate-fade-in bg-white rounded-2xl shadow-sm border border-slate-100">
                    <div class="bg-indigo-50 p-3 font-bold text-indigo-800 rounded-t-2xl">ğŸ“’ æˆ‘çš„å¸³ç›®</div>
                    <div id="ledger-content" class="divide-y divide-slate-100 p-4 space-y-2"></div>
                </div>

                <div id="panel-final" class="hidden animate-fade-in bg-white rounded-2xl shadow-sm p-4 border border-slate-100">
                    <h3 class="text-xl font-black text-slate-800 mb-4">ğŸ çµç®—å ±å‘Š</h3>
                    <div class="flex gap-2 mb-4">
                        <button onclick="SMode='TWD';refreshUI(false)" class="flex-1 py-2 bg-slate-100 rounded text-sm font-bold">å°å¹£</button>
                        <button onclick="SMode='SUB';refreshUI(false)" class="flex-1 py-2 bg-slate-100 rounded text-sm font-bold">å¤–å¹£</button>
                        <button onclick="SMode='MIX';refreshUI(false)" class="flex-1 py-2 bg-blue-100 rounded text-sm font-bold text-blue-700">æ··åˆ(è½‰å°å¹£)</button>
                    </div>
                    <div id="settle-content" class="space-y-4"></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // 0. Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCzM7T1UWb1MxsE5O1w_lsoMp4sC-wT-v0",
            authDomain: "project-2641836624074325409.firebaseapp.com",
            databaseURL: "https://project-2641836624074325409-default-rtdb.firebaseio.com",
            projectId: "project-2641836624074325409",
            storageBucket: "project-2641836624074325409.firebasestorage.app",
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();

        let db = { items: [], members: [] };
        let currentUser = "";
        let currentCur = "SUB";
        let SMode = 'MIX';

        // 1. è‡ªå‹•ç™»å…¥èˆ‡åˆå§‹åŒ–
        window.onload = function() {
            tryAutoLogin();
        };

        function tryAutoLogin() {
            const savedId = localStorage.getItem('trip_last_id');
            const savedUser = localStorage.getItem('trip_last_user');
            const savedPass = localStorage.getItem('trip_last_pass');

            if (savedId && savedUser && savedPass) {
                document.getElementById('loading-screen').classList.remove('hidden');
                rdb.ref('books/' + savedId).once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.pass === savedPass) {
                        db = data;
                        if (!db.items) db.items = [];
                        currentUser = savedUser;
                        initApp();
                    } else {
                        // ç™»å…¥å¤±æ•ˆ
                        document.getElementById('loading-screen').classList.add('hidden');
                        localStorage.removeItem('trip_last_pass');
                    }
                });
            }
        }

        function checkBookExist() {
            const id = document.getElementById('login-id').value.trim();
            if (!id) return alert("è«‹è¼¸å…¥å¸³ç°¿ ID");

            rdb.ref('books/' + id).once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    db = data;
                    if (!db.items) db.items = [];
                    renderUserSelect();
                    document.getElementById('new-book-zone').classList.add('hidden');
                    document.getElementById('identity-zone').classList.remove('hidden');
                } else {
                    document.getElementById('new-book-zone').classList.remove('hidden');
                    document.getElementById('identity-zone').classList.add('hidden');
                    alert("å¸³ç°¿ä¸å­˜åœ¨ï¼Œè«‹å»ºç«‹æ–°å¸³ç°¿");
                }
            });
        }

        function createNewBook() {
            const id = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('secure-code').value.trim();
            const members = document.getElementById('new-members').value.split(/[,ï¼Œ]/).map(m => m.trim()).filter(m => m);
            const subName = document.getElementById('new-foreign-name').value.trim() || "å¤–å¹£";

            if (!id || !pass || members.length < 1) return alert("è³‡æ–™ä¸å®Œæ•´");

            db = { id, pass, members, subName, manager: members[0], adminPass: "1234", rate: 0.22, items: [], isSealed: false };
            save();
            alert(`å¸³ç°¿ [${id}] å»ºç«‹æˆåŠŸï¼`);
            checkBookExist();
        }

        function lockIdentityAndEnter() {
            const selected = document.getElementById('user-select').value;
            const passInput = document.getElementById('login-pass').value.trim();
            const remember = document.getElementById('remember-me').checked;

            if (passInput !== db.pass) return alert("å¯†ç¢¼éŒ¯èª¤");
            if (selected === db.manager) {
                const adminInput = document.getElementById('admin-login-pass').value.trim();
                if (adminInput !== db.adminPass) return alert("ç®¡ç†å“¡å¯†ç¢¼éŒ¯èª¤");
            }

            currentUser = selected;
            
            // å„²å­˜è‡ªå‹•ç™»å…¥è³‡è¨Š
            if (remember) {
                localStorage.setItem('trip_last_id', db.id);
                localStorage.setItem('trip_last_user', currentUser);
                localStorage.setItem('trip_last_pass', db.pass);
            }

            initApp();
        }

        function initApp() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            document.getElementById('display-user').innerText = `ğŸ‘¤ ${currentUser} ${currentUser === db.manager ? '(ç®¡)' : ''}`;
            document.getElementById('btn-sub').innerText = db.subName;
            
            document.getElementById('exp-date').valueAsDate = new Date();
            document.getElementById('fund-date').valueAsDate = new Date();

            const payerSelect = document.getElementById('payer-member');
            payerSelect.innerHTML = db.members.map(m => `<option value="${m}">${m}</option>`).join('');
            
            const splittersGrid = document.getElementById('splitters-grid');
            splittersGrid.innerHTML = db.members.map(m => `
                <label class="flex items-center gap-1 p-2 bg-slate-50 rounded border cursor-pointer">
                    <input type="checkbox" value="${m}" checked> ${m}
                </label>
            `).join('');

            if (currentUser !== db.manager) {
                document.getElementById('admin-fund-tab').remove();
                document.getElementById('admin-setting-tab').remove();
                const pubOpt = document.getElementById('opt-public-pay');
                pubOpt.disabled = true;
                pubOpt.innerText += " (é™ç®¡ç†)";
                document.getElementById('exp-path').value = 'advance';
                togglePayerSelection();
            } else {
                document.getElementById('set-members').value = db.members.join(',');
                document.getElementById('set-sub-name').value = db.subName;
                document.getElementById('set-rate').value = db.rate;
                const mgrSel = document.getElementById('set-manager');
                mgrSel.innerHTML = db.members.map(m => `<option value="${m}">${m}</option>`).join('');
                mgrSel.value = db.manager;
            }

            startSync();
            refreshUI();
        }

        function save() { if (db.id) rdb.ref('books/' + db.id).set(db); }
        function startSync() {
            if (!db.id) return;
            rdb.ref('books/' + db.id).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && JSON.stringify(data) !== JSON.stringify(db)) {
                    db = data;
                    if (!db.items) db.items = [];
                    refreshUI(false); 
                }
            });
        }

        function refreshUI(shouldSave = true) {
            if (shouldSave) save();
            if (!db.items) db.items = [];

            const currentItems = db.items.filter(i => i.cur === currentCur);
            const totalFund = currentItems.filter(i => i.type === 'fund').reduce((s, i) => s + (i.amt || 0), 0);
            const totalSpend = currentItems.filter(i => i.type === 'public').reduce((s, i) => s + (i.amt || 0), 0);
            
            document.getElementById('sum-income').innerText = `$${Math.round(totalFund)}`;
            document.getElementById('sum-expense').innerText = `$${Math.round(totalSpend)}`;
            document.getElementById('sum-balance').innerText = `$${Math.round(totalFund - totalSpend)}`;

            renderList('income-list', i => i.type === 'fund' && i.cur === currentCur, 'text-green-600', '+');
            renderList('public-exp-list', i => i.type === 'public' && i.cur === currentCur, 'text-red-600', '-');
            renderAdvList();
            renderLedger();
            renderSettleReport();
        }

        function renderList(domId, filterFn, colorClass, sign) {
            const list = db.items.filter(filterFn).sort((a,b) => b.date.localeCompare(a.date));
            const html = list.map(i => `
                <div class="flex justify-between items-center p-3 hover:bg-slate-50 cursor-pointer" onclick="editItem(${i.id})">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${i.cat || 'ğŸ“„'}</span>
                        <div><div class="text-xs text-slate-400">${i.date}</div><div class="font-bold text-slate-700">${i.title}</div></div>
                    </div>
                    <div class="${colorClass} font-bold">${sign}$${Math.round(i.amt)}</div>
                </div>
            `).join('');
            document.getElementById(domId).innerHTML = html || `<p class="p-4 text-center text-slate-300 text-sm">ç„¡è³‡æ–™</p>`;
        }

        function renderAdvList() {
            const list = db.items.filter(i => i.type === 'advance' && i.cur === currentCur).sort((a,b) => b.date.localeCompare(a.date));
            document.getElementById('adv-list').innerHTML = list.map(i => `
                <div class="flex justify-between items-center p-3 border-l-4 border-orange-400 hover:bg-slate-50 cursor-pointer" onclick="editItem(${i.id})">
                    <div><div class="text-xs text-slate-400">${i.date} <span class="bg-orange-100 text-orange-600 px-1 rounded">${i.payer}å¢Š</span></div><div class="font-bold text-slate-700">${i.title}</div></div>
                    <div class="text-blue-600 font-bold">$${Math.round(i.amt)}</div>
                </div>
            `).join('') || `<p class="p-4 text-center text-slate-300 text-sm">ç„¡è³‡æ–™</p>`;
        }

        function renderLedger() {
            const list = db.items.filter(i => i.cur === currentCur).sort((a,b) => b.date.localeCompare(a.date));
            let html = "";
            list.forEach(i => {
                if (i.splitters.includes(currentUser) || i.payer === currentUser) {
                    const myShare = i.splitters.includes(currentUser) ? (i.amt / i.splitters.length) : 0;
                    if (i.type === 'fund' && i.splitters.includes(currentUser)) {
                        html += `<div class="flex justify-between p-3 border-b border-slate-100"><div><div class="text-xs text-slate-400">${i.date}</div><div class="font-bold">é ç¹³å…¬å¸³</div></div><div class="text-green-600 font-bold">æ”¯å‡º $${Math.round(myShare)}</div></div>`;
                    } else if (i.type !== 'fund' && myShare > 0) {
                        html += `<div class="flex justify-between p-3 border-b border-slate-100"><div><div class="text-xs text-slate-400">${i.date}</div><div class="font-bold">${i.title}</div></div><div class="text-red-400 font-bold">åˆ†æ”¤ -$${Math.round(myShare)}</div></div>`;
                    }
                }
            });
            document.getElementById('ledger-content').innerHTML = html || `<p class="text-center text-slate-300 text-sm">ç„¡è³‡æ–™</p>`;
        }

        function renderSettleReport() {
            const results = {};
            db.members.forEach(m => results[m] = { paid: 0, cost: 0 });
            db.items.forEach(i => {
                let val = i.amt;
                if (SMode === 'MIX' && i.cur === 'SUB') val = i.amt * db.rate;
                if (SMode === 'TWD' && i.cur !== 'TWD') return;
                if (SMode === 'SUB' && i.cur !== 'SUB') return;
                
                const share = val / i.splitters.length;
                if (i.type === 'fund') i.splitters.forEach(m => results[m].paid += share);
                else if (i.type === 'public') i.splitters.forEach(m => results[m].cost += share);
                else if (i.type === 'advance') { if(results[i.payer]) results[i.payer].paid += val; i.splitters.forEach(m => results[m].cost += share); }
            });

            let html = `<table class="w-full text-sm text-left mb-4"><thead class="bg-slate-100"><tr><th class="p-2">æˆå“¡</th><th class="p-2 text-right">çµé¤˜</th></tr></thead><tbody>`;
            const netArr = [];
            db.members.forEach(m => {
                const bal = results[m].paid - results[m].cost;
                netArr.push({ name: m, bal });
                html += `<tr class="border-b"><td class="p-2 font-bold">${m}</td><td class="p-2 text-right font-black ${bal>=0?'text-blue-600':'text-red-500'}">${bal>=0?'+':''}${Math.round(bal)}</td></tr>`;
            });
            html += `</tbody></table>`;

            let receivers = netArr.filter(n => n.bal > 0.5).sort((a,b) => b.bal - a.bal);
            let payers = netArr.filter(n => n.bal < -0.5).map(n => ({...n, bal: Math.abs(n.bal)})).sort((a,b) => b.bal - a.bal);
            let logs = [];
            payers.forEach(p => { receivers.forEach(r => {
                if (p.bal <= 0 || r.bal <= 0) return;
                let amt = Math.min(p.bal, r.bal);
                logs.push(`ğŸ“ <b>${p.name}</b> â¡ ${r.name} <span class="text-blue-600 font-bold">$${Math.round(amt)}</span>`);
                p.bal -= amt; r.bal -= amt;
            });});
            receivers.forEach(r => { if(r.bal > 0.5 && r.name !== db.manager) logs.push(`ğŸ¦ <b>${db.manager}(é€€)</b> â¡ ${r.name} <span class="text-green-600 font-bold">$${Math.round(r.bal)}</span>`); });

            html += logs.length ? `<div class="space-y-2 text-sm">${logs.map(l=>`<div class="bg-slate-50 p-2 border rounded">${l}</div>`).join('')}</div>` : `<p class="text-center text-slate-400">å¸³ç›®å·²å¹³è¡¡</p>`;
            document.getElementById('settle-content').innerHTML = html;
        }

        function addRecord() {
            if (db.isSealed) return alert("å¸³ç°¿å·²å°å­˜");
            const date = document.getElementById('exp-date').value;
            const title = document.getElementById('exp-title').value.trim();
            const amt = parseFloat(document.getElementById('exp-amt').value);
            const cat = document.getElementById('exp-cat').value;
            const type = document.getElementById('exp-path').value;
            if (!date || !title || !amt) return alert("è³‡æ–™ä¸å…¨");
            
            const checkboxes = document.querySelectorAll('#splitters-grid input:checked');
            const splitters = Array.from(checkboxes).map(c => c.value);
            if (splitters.length === 0) return alert("è«‹é¸æ“‡åˆ†æ”¤äºº");

            db.items.push({ id: Date.now(), date, cat, title, amt, cur: currentCur, type, payer: type === 'advance' ? document.getElementById('payer-member').value : "å…¬å¸³", splitters });
            document.getElementById('exp-title').value = ""; document.getElementById('exp-amt').value = "";
            refreshUI(); alert("å·²è¨˜éŒ„");
        }

        function addFundRecord() {
            const perAmt = parseFloat(document.getElementById('fund-amt').value);
            const date = document.getElementById('fund-date').value;
            if (!perAmt) return;
            db.items.push({ id: Date.now(), date, cat: "ğŸ’°", title: "å…¨å“¡å…¬å¸³é ç¹³", amt: perAmt * db.members.length, cur: currentCur, type: 'fund', payer: "å…¨å“¡", splitters: [...db.members] });
            document.getElementById('fund-amt').value = ""; refreshUI(); alert("å…¥é‡‘æˆåŠŸ");
        }

        function editItem(id) {
            if (db.isSealed) return;
            const item = db.items.find(i => i.id == id);
            if (!item) return;
            if (currentUser !== db.manager && item.payer !== currentUser && !item.splitters.includes(currentUser)) return alert("ç„¡æ¬Šä¿®æ”¹");

            const newTitle = prompt("ä¿®æ”¹åç¨±", item.title);
            if (newTitle !== null) item.title = newTitle;
            
            if (item.type === 'fund') {
                const oldPer = item.amt / item.splitters.length;
                const newPer = prompt(`ä¿®æ”¹æ¯äººé ç¹³ (ç›®å‰$${oldPer})`, oldPer);
                if (newPer !== null) item.amt = parseFloat(newPer) * item.splitters.length;
            } else {
                const newAmt = prompt("ä¿®æ”¹é‡‘é¡", item.amt);
                if (newAmt !== null) item.amt = parseFloat(newAmt);
            }
            if (confirm("åˆªé™¤æ­¤ç­†ï¼Ÿ")) db.items = db.items.filter(i => i.id != id);
            refreshUI();
        }

        function renderUserSelect() {
            const sel = document.getElementById('user-select');
            sel.innerHTML = db.members.map(m => `<option value="${m}">${m}</option>`).join('');
            sel.onchange = () => { document.getElementById('admin-pass-input-box').classList.toggle('hidden', sel.value !== db.manager); };
            sel.onchange(); 
        }

        function togglePayerSelection() {
            document.getElementById('payer-select-div').classList.toggle('hidden', document.getElementById('exp-path').value !== 'advance');
        }

        function switchCurrency(cur) {
            currentCur = cur;
            document.getElementById('btn-twd').className = `flex-1 lg:flex-none px-4 py-2 lg:px-6 lg:py-3 rounded-xl font-bold border-2 ${cur==='TWD'?'currency-active':'bg-white text-slate-400'} text-sm lg:text-base`;
            document.getElementById('btn-sub').className = `flex-1 lg:flex-none px-4 py-2 lg:px-6 lg:py-3 rounded-xl font-bold border-2 ${cur==='SUB'?'currency-active':'bg-white text-slate-400'} text-sm lg:text-base`;
            document.getElementById('tab-add-title').innerText = `ğŸ“ æ–°å¢æ”¯å‡º (${cur==='TWD'?'å°å¹£':db.subName})`;
            refreshUI(false);
        }

        function switchTab(tabName, btn) {
            ['panel-pub', 'panel-adv', 'panel-my', 'panel-final'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.className = "tab-btn px-4 py-2 rounded-full font-bold bg-white text-slate-600 border whitespace-nowrap");
            btn.className = "tab-btn px-4 py-2 rounded-full font-bold bg-slate-800 text-white whitespace-nowrap shadow-md";
            document.getElementById('panel-' + tabName).classList.remove('hidden');
        }

        function updateSettings() {
            db.members = document.getElementById('set-members').value.split(',').map(m => m.trim());
            db.subName = document.getElementById('set-sub-name').value;
            db.rate = parseFloat(document.getElementById('set-rate').value);
            db.manager = document.getElementById('set-manager').value;
            save(); alert("å·²å„²å­˜"); location.reload();
        }
        function toggleSeal() { db.isSealed = !db.isSealed; save(); refreshUI(); alert(db.isSealed?"å·²å°å­˜":"å·²è§£å°"); }
        function logout() { localStorage.removeItem('trip_last_pass'); location.reload(); }
    </script>
</body>
</html>
