<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripSplit 2026 å°ˆæ¥­çµç®—ç‰ˆ (V3.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { font-size: 16px; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f1f5f9; color: #334155; }
        input, select, button, textarea { font-size: 16px; outline: none; }
        .amt-text { font-family: 'Courier New', Courier, monospace; font-weight: bold; }
        .currency-active { background-color: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; }
        
        /* æŠ˜ç–Šå‹•ç•« */
        details > summary { list-style: none; outline: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .arrow { transform: rotate(180deg); }
        details[open] summary ~ * { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* è¨ˆç®—æ©ŸæŒ‰éˆ•æ¨£å¼ */
        .calc-btn { background: #f8fafc; border: 1px solid #cbd5e1; font-weight: bold; font-size: 1.25rem; padding: 10px; border-radius: 8px; touch-action: manipulation; }
        .calc-btn:active { background: #e2e8f0; transform: scale(0.95); }
        .calc-op { color: #2563eb; background: #eff6ff; }
        
        /* RWD è¨­å®š */
        @media (min-width: 1024px) {
            .app-container { display: grid; grid-template-columns: 450px 1fr; gap: 24px; align-items: start; }
            .sticky-panel { position: sticky; top: 20px; } 
        }
    </style>
</head>
<body class="p-4 lg:p-8 min-h-screen">

    <div id="loading-mask" class="fixed inset-0 bg-white/95 z-[60] flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <div class="text-slate-500 font-bold text-lg" id="loading-text">è³‡æ–™åŒæ­¥ä¸­...</div>
    </div>

    <div id="login-portal" class="max-w-md mx-auto bg-white p-8 rounded-3xl shadow-2xl mt-10 border border-slate-100">
        <h1 class="text-4xl font-black text-center text-slate-800 mb-2">TripSplit</h1>
        <p class="text-center text-slate-400 mb-8 font-bold tracking-widest">2026 EDITION</p>
        
        <div id="portal-buttons" class="space-y-4">
            <button onclick="showLoginInput('EXIST')" class="w-full bg-white border-2 border-slate-200 text-slate-700 py-4 rounded-2xl font-black text-xl hover:bg-slate-50 hover:border-blue-400 transition shadow-sm flex items-center justify-center gap-2">
                ğŸ“‚ é€²å…¥èˆŠå¸³ç°¿
            </button>
            <button onclick="showLoginInput('NEW')" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black text-xl hover:bg-slate-900 transition shadow-lg flex items-center justify-center gap-2">
                ğŸ†• å»ºç«‹æ–°å¸³ç°¿
            </button>
        </div>

        <div id="exist-login-zone" class="hidden mt-6 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">è¼¸å…¥å¸³ç°¿ä»£ç¢¼</h3>
                <button onclick="resetPortal()" class="text-sm text-slate-400">â†© è¿”å›</button>
            </div>
            <input type="text" id="login-id" placeholder="ä¾‹å¦‚: Tokyo2026" class="w-full p-4 border rounded-xl bg-slate-50 focus:ring-2 ring-blue-400 outline-none transition font-bold text-lg mb-4 text-center uppercase">
            <button onclick="checkBookExist()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-blue-700">æŸ¥è©¢å¸³ç°¿</button>
        </div>

        <div id="new-create-zone" class="hidden mt-6 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">è¨­å®šæ–°å¸³ç°¿ ID</h3>
                <button onclick="resetPortal()" class="text-sm text-slate-400">â†© è¿”å›</button>
            </div>
            <input type="text" id="new-book-id-input" placeholder="è«‹è¨­å®š ID (è‹±æ•¸)" class="w-full p-4 border rounded-xl bg-slate-50 focus:ring-2 ring-green-400 outline-none transition font-bold text-lg mb-4 text-center uppercase">
            <button onclick="initiateCreateBook()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-green-700">å»ºç«‹å¸³ç°¿</button>
        </div>

        <div id="identity-zone" class="hidden mt-6 pt-6 border-t border-dashed border-slate-200">
            <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                <label class="block text-sm font-bold text-blue-800 mb-2">ğŸ‘¤ é¸æ“‡æ‚¨çš„åå­—</label>
                <select id="user-select" class="w-full p-3 border rounded-xl bg-white mb-4 text-lg font-bold text-center"></select>
                
                <input type="password" id="login-pass" placeholder="ğŸ”‘ è¼¸å…¥å¸³ç°¿å¯†ç¢¼" class="w-full p-3 border rounded-xl mb-3 text-center">
                <div id="admin-pass-input-box" class="hidden">
                    <input type="password" id="admin-login-pass" placeholder="ğŸ›¡ï¸ ç®¡ç†å“¡å¯†ç¢¼" class="w-full p-3 border rounded-xl border-orange-200 bg-orange-50 mb-3 text-orange-800 text-center">
                </div>
                
                <label class="flex justify-center items-center gap-2 mb-4 text-sm text-slate-500 font-bold">
                    <input type="checkbox" id="auto-login-check" checked class="w-4 h-4"> ä¿æŒç™»å…¥
                </label>
                <button onclick="lockIdentityAndEnter()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow hover:bg-blue-700 transition">ç¢ºèªç™»å…¥</button>
            </div>
        </div>
    </div>

    <div id="main-content" class="hidden max-w-6xl mx-auto">
        <header class="bg-white p-4 lg:p-6 rounded-2xl shadow-lg mb-6 transition-all duration-300">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h1 class="text-2xl font-black text-slate-800 tracking-tight flex items-center gap-2">
                    <span id="display-user" class="text-base font-normal bg-slate-100 px-3 py-1 rounded-full border"></span>
                    <span id="seal-badge" class="hidden bg-red-100 text-red-600 text-xs px-2 py-1 rounded border border-red-200">ğŸ”’ å·²å°å­˜</span>
                </h1>
                <button onclick="logout()" class="text-sm font-bold text-slate-400 border px-3 py-1 rounded-lg hover:bg-red-50 hover:text-red-500 transition">ç™»å‡º</button>
            </div>
            <div class="flex flex-col lg:flex-row gap-4 lg:items-center">
                <div class="flex gap-2 w-full lg:w-auto">
                    <button id="btn-twd" onclick="switchCurrency('TWD')" class="flex-1 lg:flex-none px-6 py-3 rounded-xl font-bold border-2 transition-all">ğŸ‡¹ğŸ‡¼ å°å¹£</button>
                    <button id="btn-sub" onclick="switchCurrency('SUB')" class="flex-1 lg:flex-none px-6 py-3 rounded-xl font-bold border-2 transition-all">å¤–å¹£</button>
                </div>
                <div class="grid grid-cols-3 gap-2 flex-1 text-center bg-slate-50 p-2 rounded-xl border border-slate-100 shadow-inner">
                    <div><p class="text-xs text-slate-400 font-bold">å…¬æ¬¾ç¸½æ”¶å…¥</p><p id="sum-income" class="amt-text text-green-600 text-lg">0</p></div>
                    <div class="border-l border-slate-200"><p class="text-xs text-slate-400 font-bold">å…¬æ¬¾ç¸½æ”¯å‡º</p><p id="sum-expense" class="amt-text text-red-600 text-lg">0</p></div>
                    <div class="border-l border-slate-200"><p class="text-xs text-slate-400 font-bold">å…¬æ¬¾ç›®å‰é¤˜é¡</p><p id="sum-balance" class="amt-text text-blue-600 text-lg">0</p></div>
                </div>
            </div>
        </header>

        <div class="app-container">
            <aside class="sticky-panel mb-4">
                <details id="add-panel" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden group">
                    <summary class="p-5 font-bold text-lg text-slate-800 cursor-pointer flex justify-between items-center bg-white hover:bg-slate-50 transition select-none">
                        <span id="form-header-text" class="flex items-center gap-2">ğŸ“ æ–°å¢æ”¯å‡º <span class="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-1 rounded-full" id="cur-badge">å°å¹£</span></span>
                        <span class="text-slate-400 arrow transition-transform duration-300">â–¼</span>
                    </summary>
                    <div class="p-6 pt-2 space-y-4 border-t border-slate-100">
                        <input type="hidden" id="edit-id" value="">
                        <div class="grid grid-cols-3 gap-2">
                            <input type="date" id="exp-date" class="col-span-1 p-3 bg-slate-50 rounded-xl font-bold text-slate-600 text-sm border-0 ring-1 ring-slate-200">
                            <select id="exp-cat" class="col-span-2 p-3 bg-slate-50 rounded-xl font-bold text-center border-0 ring-1 ring-slate-200">
                                <option value="ğŸ½ï¸ é¤é£²">ğŸ½ï¸ é¤é£²</option><option value="ğŸš— äº¤é€š">ğŸš— äº¤é€š</option><option value="ğŸ  ä½å®¿">ğŸ  ä½å®¿</option>
                                <option value="ğŸ« ç¥¨åˆ¸">ğŸ« ç¥¨åˆ¸</option><option value="ğŸ›ï¸ è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="ğŸ¹ é£²æ–™">ğŸ¹ é£²æ–™</option><option value="â¤ï¸ å…¶ä»–">â¤ï¸ å…¶ä»–</option>
                            </select>
                        </div>
                        <input type="text" id="exp-title" placeholder="è¼¸å…¥é …ç›®åç¨±..." class="w-full p-3 bg-slate-50 rounded-xl font-bold border-0 ring-1 ring-slate-200 text-center">
                        
                        <div class="bg-slate-50 p-2 rounded-xl ring-1 ring-slate-200">
                            <input type="text" id="exp-amt-display" placeholder="0" readonly class="w-full bg-transparent text-right font-black text-3xl text-blue-600 p-2 mb-2 outline-none">
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="calcKey('7')" class="calc-btn">7</button><button onclick="calcKey('8')" class="calc-btn">8</button><button onclick="calcKey('9')" class="calc-btn">9</button><button onclick="calcKey('/')" class="calc-btn calc-op">Ã·</button>
                                <button onclick="calcKey('4')" class="calc-btn">4</button><button onclick="calcKey('5')" class="calc-btn">5</button><button onclick="calcKey('6')" class="calc-btn">6</button><button onclick="calcKey('*')" class="calc-btn calc-op">Ã—</button>
                                <button onclick="calcKey('1')" class="calc-btn">1</button><button onclick="calcKey('2')" class="calc-btn">2</button><button onclick="calcKey('3')" class="calc-btn">3</button><button onclick="calcKey('-')" class="calc-btn calc-op">-</button>
                                <button onclick="calcKey('C')" class="calc-btn text-red-500">C</button><button onclick="calcKey('0')" class="calc-btn">0</button><button onclick="calcKey('.')" class="calc-btn">.</button><button onclick="calcKey('+')" class="calc-btn calc-op">+</button>
                            </div>
                        </div>

                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                            <div class="flex justify-between items-center mb-3">
                                <label class="text-xs font-bold text-slate-500">æ”¯ä»˜æ–¹å¼</label>
                                <select id="exp-path" onchange="togglePayerSelection()" class="text-sm p-2 rounded bg-white font-bold text-slate-700 ring-1 ring-slate-200 shadow-sm">
                                    <option id="opt-public-pay" value="public">å…¬å¸³é¤˜é¡æ”¯ä»˜</option>
                                    <option value="advance">å€‹äººä»£å¢Š (ç§å¸³)</option>
                                    <option value="personal">å€‹äººæ”¯ä»˜</option>
                                </select>
                            </div>
                            <div id="payer-select-div" class="hidden mb-3 animate-fade-in">
                                <label class="text-xs font-bold text-slate-500 block mb-1">èª°å…ˆå¢ŠéŒ¢ï¼Ÿ</label>
                                <select id="payer-member" class="w-full p-2 rounded border text-sm font-bold bg-white"></select>
                            </div>
                            <div id="splitters-block">
                                <label class="text-xs font-bold text-slate-500 mb-2 block">åˆ†æ”¤æˆå“¡ (é è¨­å…¨å“¡)</label>
                                <div id="splitters-grid" class="grid grid-cols-3 gap-2 text-sm"></div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button id="btn-submit" onclick="handleRecordSubmit()" class="flex-1 bg-slate-800 text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-slate-900 transition active:scale-95">ç¢ºèªè¨˜å¸³</button>
                            <button id="btn-cancel-edit" onclick="resetForm()" class="hidden w-24 bg-gray-200 text-gray-500 rounded-xl font-bold">å–æ¶ˆ</button>
                        </div>
                    </div>
                </details>
            </aside>

            <main class="space-y-4">
                <details id="panel-pub" class="bg-white rounded-2xl shadow-sm border border-slate-200 group">
                    <summary class="p-4 font-bold text-lg text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>ğŸ“Š å…¬å¸³æ˜ç´°</span>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleSort(); event.preventDefault();" class="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 text-slate-500 border">ğŸ”ƒ æ’åº</button>
                            <span class="text-slate-400 arrow transition-transform">â–¼</span>
                        </div>
                    </summary>
                    <div class="p-4 border-t border-slate-100 space-y-4">
                        <div class="flex justify-between items-center"><h4 class="font-bold text-green-700">ğŸ“¥ å…¬å¸³æ”¶å…¥</h4></div>
                        <div id="income-list" class="space-y-4"></div>
                        <div class="flex justify-between items-center pt-4 border-t"><h4 class="font-bold text-red-700">ğŸ“¤ å…¬å¸³æ”¯å‡º</h4></div>
                        <div id="public-exp-list" class="space-y-4"></div>
                    </div>
                </details>

                <details id="panel-adv" class="bg-white rounded-2xl shadow-sm border border-slate-200 group">
                    <summary class="p-4 font-bold text-lg text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>âš¡ å€‹äººä»£å¢Š</span>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleSort(); event.preventDefault();" class="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 text-slate-500 border">ğŸ”ƒ æ’åº</button>
                            <span class="text-slate-400 arrow transition-transform">â–¼</span>
                        </div>
                    </summary>
                    <div class="p-4 border-t border-slate-100 space-y-6">
                        <div>
                            <h4 class="font-bold text-green-700 mb-3 text-sm bg-green-50 p-2 rounded-lg inline-block border border-green-200">ğŸŸ¢ æˆ‘å…ˆå¢Šä»˜ (åˆ¥äººæ¬ æˆ‘)</h4>
                            <div id="adv-my-list" class="space-y-4"></div>
                        </div>
                        <div>
                            <h4 class="font-bold text-red-700 mb-3 text-sm bg-red-50 p-2 rounded-lg inline-block border border-red-200">ğŸ”´ åˆ¥äººä»£å¢Š (æˆ‘æ¬ åˆ¥äºº)</h4>
                            <div id="adv-other-list" class="space-y-4"></div>
                        </div>
                    </div>
                </details>

                <details id="panel-pvt" class="bg-white rounded-2xl shadow-sm border border-slate-200 group">
                    <summary class="p-4 font-bold text-lg text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>ğŸ‘¤ å€‹äººæ˜ç´°</span>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleSort(); event.preventDefault();" class="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 text-slate-500 border">ğŸ”ƒ æ’åº</button>
                            <span class="text-slate-400 arrow transition-transform">â–¼</span>
                        </div>
                    </summary>
                    <div class="p-4 border-t border-slate-100">
                        <div id="pvt-list" class="space-y-4"></div>
                    </div>
                </details>

                <details id="panel-ledger" class="bg-white rounded-2xl shadow-sm border border-slate-200 group">
                    <summary class="p-4 font-bold text-lg text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>ğŸ“’ å€‹äººæµæ°´å¸³</span>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleSort(); event.preventDefault();" class="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 text-slate-500 border">ğŸ”ƒ æ’åº</button>
                            <span class="text-slate-400 arrow transition-transform">â–¼</span>
                        </div>
                    </summary>
                    <div class="p-4 border-t border-slate-100 space-y-3">
                        
                        <details class="group bg-slate-50 rounded-xl border border-slate-200 overflow-hidden">
                            <summary class="p-3 font-bold text-slate-700 cursor-pointer flex justify-between hover:bg-slate-100">
                                <span>ğŸ”µ å…¬å¸³åˆ†æ”¤ (é ç¹³ & æ¶ˆè²»)</span><span class="arrow transition-transform">â–¼</span>
                            </summary>
                            <div class="p-3 border-t bg-white" id="ledger-public-content"></div>
                        </details>
                        
                        <details class="group bg-slate-50 rounded-xl border border-slate-200 overflow-hidden">
                            <summary class="p-3 font-bold text-slate-700 cursor-pointer flex justify-between hover:bg-slate-100">
                                <span>ğŸŸ  ä»£å¢Šå¾€ä¾† (å¢Šä»˜ & è¢«å¢Š)</span><span class="arrow transition-transform">â–¼</span>
                            </summary>
                            <div class="p-3 border-t bg-white" id="ledger-advance-content"></div>
                        </details>

                        <details class="group bg-slate-50 rounded-xl border border-slate-200 overflow-hidden">
                            <summary class="p-3 font-bold text-slate-700 cursor-pointer flex justify-between hover:bg-slate-100">
                                <span>ğŸŸ£ å€‹äººæ”¯ä»˜ (è‡ªä»˜)</span><span class="arrow transition-transform">â–¼</span>
                            </summary>
                            <div class="p-3 border-t bg-white" id="ledger-personal-content"></div>
                        </details>
                    </div>
                </details>

                <details id="panel-stats" class="bg-white rounded-2xl shadow-sm border border-slate-200 group" ontoggle="if(this.open) renderStats()">
                    <summary class="p-4 font-bold text-lg text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>ğŸ“ˆ çµ±è¨ˆåˆ†æ</span><span class="text-slate-400 arrow transition-transform">â–¼</span>
                    </summary>
                    <div class="p-6 border-t border-slate-100">
                        <div class="mb-6 text-center"><p class="text-slate-500 text-sm">æ‚¨çš„ç¸½æ”¯å‡º</p><p id="stats-total" class="text-3xl font-black text-blue-600 mt-1">0</p></div>
                        <div class="relative h-64 w-full mb-6"><canvas id="expenseChart"></canvas></div>
                        <div id="stats-detail-list" class="space-y-2"></div>
                    </div>
                </details>

                <details id="panel-final" class="bg-white rounded-2xl shadow-sm border border-slate-200 group">
                    <summary class="p-4 font-bold text-lg text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>ğŸ æœ€çµ‚çµç®—</span><span class="text-slate-400 arrow transition-transform">â–¼</span>
                    </summary>
                    <div class="p-6 border-t border-slate-100">
                        <div class="flex gap-2 mb-4">
                            <button id="btn-settle-twd" onclick="switchSettleMode('TWD')" class="flex-1 py-2 bg-slate-100 rounded text-sm font-bold">å°å¹£</button>
                            <button id="btn-settle-sub" onclick="switchSettleMode('SUB')" class="flex-1 py-2 bg-slate-100 rounded text-sm font-bold">å¤–å¹£</button>
                            <button id="btn-settle-mix" onclick="switchSettleMode('MIX')" class="flex-1 py-2 bg-slate-100 rounded text-sm font-bold">æ··åˆ</button>
                        </div>
                        <div id="pot-status-area"></div>
                        <div id="settle-table-area" class="mb-6"></div>
                        <div id="settle-transfer-area" class="border-t pt-4"></div>
                    </div>
                </details>

                <details id="panel-admin" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 group border-l-4 border-l-slate-800">
                    <summary class="p-4 font-bold text-lg text-slate-800 cursor-pointer flex justify-between items-center">
                        <span>ğŸ›¡ï¸ ç®¡ç†å“¡å°ˆå€</span><span class="text-slate-400 arrow transition-transform">â–¼</span>
                    </summary>
                    <div class="p-6 border-t border-slate-100 space-y-8">
                        <div>
                            <h4 class="font-bold text-green-700 mb-3">ğŸ’° å…¬å¸³é ç¹³ (å…¥é‡‘)</h4>
                            <div class="flex gap-2">
                                <input type="date" id="fund-date" class="w-1/3 p-2 rounded border">
                                <input type="number" id="fund-amt" placeholder="é‡‘é¡" class="w-1/3 p-2 rounded border font-bold text-center">
                                <button onclick="addFundRecord()" class="w-1/3 bg-green-600 text-white rounded font-bold shadow">å…¥å¸³</button>
                            </div>
                        </div>
                        <div class="space-y-3 text-sm">
                            <h4 class="font-bold text-slate-700">âš™ï¸ è¨­å®š</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label>æˆå“¡</label><input type="text" id="set-members" class="w-full p-2 rounded border mt-1"></div>
                                
                                <div>
                                    <label>å¹£åˆ¥åç¨± (å¿«é¸)</label>
                                    <div class="flex gap-2 mt-1">
                                        <select onchange="updateSubNameBySelect(this.value)" class="w-1/3 p-2 rounded border bg-slate-50 text-center text-xs">
                                            <option value="">é¸å¹£</option>
                                            <option value="JPY">ğŸ‡¯ğŸ‡µ æ—¥å¹£</option>
                                            <option value="USD">ğŸ‡ºğŸ‡¸ ç¾é‡‘</option>
                                            <option value="KRW">ğŸ‡°ğŸ‡· éŸ“å…ƒ</option>
                                            <option value="EUR">ğŸ‡ªğŸ‡º æ­å…ƒ</option>
                                            <option value="CNY">ğŸ‡¨ğŸ‡³ äººæ°‘å¹£</option>
                                            <option value="THB">ğŸ‡¹ğŸ‡­ æ³°éŠ–</option>
                                            <option value="SGD">ğŸ‡¸ğŸ‡¬ æ–°å¹£</option>
                                            <option value="MYR">ğŸ‡²ğŸ‡¾ é¦¬å¹£</option>
                                            <option value="VND">ğŸ‡»ğŸ‡³ è¶Šå—ç›¾</option>
                                            <option value="PHP">ğŸ‡µğŸ‡­ æŠ«ç´¢</option>
                                            <option value="IDR">ğŸ‡®ğŸ‡© å°å°¼ç›¾</option>
                                        </select>
                                        <input type="text" id="set-sub-name" class="w-2/3 p-2 rounded border">
                                    </div>
                                </div>

                                <div><label>åŒ¯ç‡</label><input type="number" id="set-rate" class="w-full p-2 rounded border mt-1" step="0.0001"></div>
                                <div><label>ç®¡ç†å“¡</label><select id="set-manager" class="w-full p-2 rounded border mt-1"></select></div>
                                <div><label>å¸³ç°¿å¯†ç¢¼</label><input type="text" id="set-book-pass" class="w-full p-2 rounded border mt-1"></div>
                                <div><label>ç®¡ç†å¯†ç¢¼</label><input type="text" id="set-admin-pass" class="w-full p-2 rounded border mt-1"></div>
                            </div>
                            <button onclick="updateSettings()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mt-2">å„²å­˜è¨­å®š</button>
                        </div>
                        <div class="border-t pt-4 space-y-3">
                            <button onclick="downloadData()" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-bold">ğŸ“¥ ä¸‹è¼‰å‚™ä»½ (JSON)</button>
                            <button onclick="toggleSeal()" id="btn-seal" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold">ğŸ”’ å°å­˜å¸³ç°¿</button>
                            <button onclick="deleteAllData()" class="w-full bg-white text-red-500 border border-red-200 py-2 rounded font-bold">ğŸ§¨ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
                        </div>
                    </div>
                </details>
            </main>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCzM7T1UWb1MxsE5O1w_lsoMp4sC-wT-v0",
            authDomain: "project-2641836624074325409.firebaseapp.com",
            databaseURL: "https://project-2641836624074325409-default-rtdb.firebaseio.com",
            projectId: "project-2641836624074325409",
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();

        let db = { items: [], members: [] };
        let currentUser = "";
        let currentCur = "TWD"; 
        let isSortDesc = true; 
        let SMode = 'MIX';
        let chartInstance = null;
        let calcVal = "";

        // ç³»çµ±å¯†ç¢¼é›œæ¹Š (SHA-256 for 'djes.tyc-2026')
        const SYSTEM_HASH = "9e70129204095066487570490906236166160350482599763590529819777174";

        window.onload = function() {
            // å˜—è©¦è‡ªå‹•ç™»å…¥
            const savedId = localStorage.getItem('trip_auto_id');
            const savedUser = localStorage.getItem('trip_auto_user');
            const savedPass = localStorage.getItem('trip_auto_pass');
            if (savedId && savedUser && savedPass) {
                document.getElementById('loading-mask').classList.remove('hidden');
                rdb.ref('books/' + savedId).once('value', (s) => {
                    const data = s.val();
                    if (data && data.pass === savedPass) { 
                        db = data; 
                        if(!db.items) db.items = []; 
                        if(!db.members) db.members = []; 
                        currentUser = savedUser; 
                        initApp(); 
                    } else {
                        document.getElementById('loading-mask').classList.add('hidden');
                    }
                });
            }
        };

        // ä»‹é¢åˆ‡æ›
        function showLoginInput(type) {
            document.getElementById('portal-buttons').classList.add('hidden');
            if(type==='EXIST') {
                document.getElementById('exist-login-zone').classList.remove('hidden');
                const mem = localStorage.getItem('trip_book_id_memory');
                if(mem) document.getElementById('login-id').value = mem;
            } else {
                document.getElementById('new-create-zone').classList.remove('hidden');
            }
        }
        function resetPortal() {
            document.getElementById('portal-buttons').classList.remove('hidden');
            document.getElementById('exist-login-zone').classList.add('hidden');
            document.getElementById('new-create-zone').classList.add('hidden');
        }

        // ç™»å…¥èˆŠå¸³ç°¿
        function checkBookExist() {
            const id = document.getElementById('login-id').value.trim();
            if (!id) return alert("è«‹è¼¸å…¥ID");
            localStorage.setItem('trip_book_id_memory', id);
            document.getElementById('loading-mask').classList.remove('hidden');
            
            rdb.ref('books/' + id).once('value', (s) => {
                document.getElementById('loading-mask').classList.add('hidden');
                const data = s.val();
                if (data) {
                    db = data; 
                    if(!db.items) db.items = [];
                    if(!db.members) db.members = [];
                    renderUserSelect();
                    document.getElementById('exist-login-zone').classList.add('hidden');
                    document.getElementById('identity-zone').classList.remove('hidden');
                } else {
                    alert("âŒ æŸ¥ç„¡æ­¤å¸³ç°¿ï¼Œè«‹ç¢ºèª ID æˆ–å»ºç«‹æ–°å¸³ç°¿");
                }
            }, (error) => {
                document.getElementById('loading-mask').classList.add('hidden');
                alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼š" + error.message);
            });
        }

        // å»ºç«‹æ–°å¸³ç°¿æµç¨‹
        async function initiateCreateBook() {
            const id = document.getElementById('new-book-id-input').value.trim();
            if(!id) return alert("è«‹è¼¸å…¥ ID");
            
            document.getElementById('loading-mask').classList.remove('hidden');
            const snap = await rdb.ref('books/' + id).once('value');
            document.getElementById('loading-mask').classList.add('hidden');

            if(snap.exists()) return alert("æ­¤ ID å·²è¢«ä½¿ç”¨ï¼Œè«‹æ›´æ›");

            const inputPass = prompt("ğŸ” è«‹è¼¸å…¥é–‹æ–°å¸³ç°¿å°ˆç”¨å¯†ç¢¼ï¼š");
            if(!inputPass) return;

            const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(inputPass));
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

            if(hashHex === SYSTEM_HASH) {
                createDefaultBook(id);
            } else {
                alert("â›” å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•é–‹ç«‹æ–°å¸³ç°¿");
            }
        }

        function createDefaultBook(id) {
            db = { 
                id: id, 
                pass: "0000", 
                members: ["ç®¡ç†å“¡"], 
                subName: "å¤–å¹£", 
                manager: "ç®¡ç†å“¡", 
                adminPass: "1234", 
                rate: 1, 
                items: [], 
                isSealed: false 
            };
            
            document.getElementById('loading-mask').classList.remove('hidden');
            rdb.ref('books/' + id).set(db).then(() => {
                document.getElementById('loading-mask').classList.add('hidden');
                alert("âœ… å¸³ç°¿å·²å»ºç«‹ï¼\n\né è¨­å¯†ç¢¼: 0000\né è¨­ç®¡ç†å¯†ç¢¼: 1234\n\nå³å°‡é€²å…¥ç®¡ç†å°ˆå€é€²è¡Œè¨­å®š...");
                currentUser = "ç®¡ç†å“¡";
                initApp();
                setTimeout(() => {
                   document.getElementById('panel-admin').open = true;
                   document.getElementById('panel-admin').scrollIntoView();
                }, 500);
            });
        }

        function lockIdentityAndEnter() {
            const selected = document.getElementById('user-select').value;
            const passInput = document.getElementById('login-pass').value.trim();
            if (passInput !== db.pass) return alert("å¯†ç¢¼éŒ¯èª¤");
            if (selected === db.manager) {
                if(document.getElementById('admin-login-pass').value.trim() !== db.adminPass) return alert("ç®¡ç†å“¡å¯†ç¢¼éŒ¯èª¤");
            }
            currentUser = selected;
            if(document.getElementById('auto-login-check').checked) {
                localStorage.setItem('trip_auto_id', db.id); localStorage.setItem('trip_auto_user', currentUser); localStorage.setItem('trip_auto_pass', db.pass);
            }
            initApp();
        }

        function initApp() {
            document.getElementById('login-portal').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('loading-mask').classList.add('hidden');
            
            if(!db.members || db.members.length === 0) {
                db.members = [currentUser || "Unknown"];
            }

            if(currentUser === db.manager) {
                document.getElementById('panel-admin').classList.remove('hidden');
                document.getElementById('set-members').value = db.members.join(',');
                document.getElementById('set-sub-name').value = db.subName;
                document.getElementById('set-rate').value = db.rate;
                document.getElementById('set-book-pass').value = db.pass;
                document.getElementById('set-admin-pass').value = db.adminPass;
                const mgrSel = document.getElementById('set-manager');
                mgrSel.innerHTML = db.members.map(m=>`<option value="${m}">${m}</option>`).join('');
                mgrSel.value = db.manager;
            } else {
                document.getElementById('panel-admin').classList.add('hidden');
            }

            document.getElementById('display-user').innerText = `ğŸ‘¤ ${currentUser}`;
            document.getElementById('btn-sub').innerText = `ğŸŒ ${db.subName}`;
            document.getElementById('cur-badge').innerText = currentCur === 'TWD' ? 'å°å¹£' : db.subName;
            
            switchCurrency(currentCur);
            document.getElementById('exp-date').valueAsDate = new Date();
            document.getElementById('fund-date').valueAsDate = new Date();

            const payerSelect = document.getElementById('payer-member');
            payerSelect.innerHTML = db.members.map(m=>`<option value="${m}">${m}</option>`).join('');
            if(db.members.includes(currentUser)) payerSelect.value = currentUser;
            
            const splittersGrid = document.getElementById('splitters-grid');
            splittersGrid.innerHTML = db.members.map(m=>`
                <label class="flex items-center gap-1 p-2 bg-white rounded border cursor-pointer hover:bg-slate-50">
                    <input type="checkbox" name="splitter" value="${m}" checked> ${m}
                </label>
            `).join('');

            updateSealUI();
            
            if (currentUser !== db.manager) {
                const pubOpt = document.getElementById('opt-public-pay');
                pubOpt.disabled = true; pubOpt.innerText += " (é™ç®¡ç†)";
                document.getElementById('exp-path').value = 'advance';
                togglePayerSelection();
            }

            startSync(); 
        }

        function save() { if (db.id) rdb.ref('books/' + db.id).set(db); }
        function startSync() {
            if (!db.id) return;
            rdb.ref('books/' + db.id).on('value', (s) => {
                const data = s.val(); 
                if (data && JSON.stringify(data) !== JSON.stringify(db)) { 
                    db = data; 
                    if(!db.items)db.items=[]; 
                    if(!db.members)db.members=[];
                    refreshUI(false); 
                }
            });
        }

        // è¨ˆç®—æ©ŸåŠŸèƒ½
        function calcKey(k) {
            const display = document.getElementById('exp-amt-display');
            if(k === 'C') { calcVal = ""; display.value = ""; return; }
            if(k === '+' || k === '-' || k === '*' || k === '/') {
                calcVal += k;
            } else {
                calcVal += k;
            }
            display.value = calcVal;
        }
        function getCalcResult() {
            try {
                if(!calcVal) return 0;
                const safe = calcVal.replace(/[^0-9+\-*/.]/g, '');
                return eval(safe) || 0;
            } catch(e) { return 0; }
        }

        function updateSealUI() {
            const badge = document.getElementById('seal-badge');
            const btnSeal = document.getElementById('btn-seal');
            const addPanel = document.getElementById('add-panel');
            
            if(db.isSealed) {
                badge.classList.remove('hidden');
                if(btnSeal) { btnSeal.innerText = "ğŸ”“ è§£é™¤å°å­˜"; btnSeal.className = "w-full bg-gray-500 text-white py-3 rounded-xl font-bold"; }
                addPanel.classList.add('opacity-50', 'pointer-events-none');
            } else {
                badge.classList.add('hidden');
                if(btnSeal) { btnSeal.innerText = "ğŸ”’ å°å­˜å¸³ç°¿ (å”¯è®€)"; btnSeal.className = "w-full bg-orange-500 text-white py-3 rounded-xl font-bold"; }
                addPanel.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        function refreshUI(shouldSave = true) {
            if (shouldSave) save();
            updateSealUI();
            const curItems = db.items.filter(i => i.cur === currentCur);
            const totalFund = curItems.filter(i => i.type === 'fund').reduce((s, i) => s + (i.amt || 0), 0);
            const totalSpend = curItems.filter(i => i.type === 'public').reduce((s, i) => s + (i.amt || 0), 0);
            
            document.getElementById('sum-income').innerText = `${Math.round(totalFund)}`;
            document.getElementById('sum-expense').innerText = `${Math.round(totalSpend)}`;
            const bal = totalFund - totalSpend;
            document.getElementById('sum-balance').innerText = `${Math.round(bal)}`;
            document.getElementById('sum-balance').className = `amt-text text-lg ${bal < 0 ? 'text-red-600' : 'text-blue-600'}`;
            
            renderLists();
            renderLedger();
            const statsPanel = document.getElementById('panel-stats');
            if(statsPanel.open) renderStats();
            renderSettleReport();
        }

        function toggleSort() { isSortDesc = !isSortDesc; refreshUI(false); }

        function renderLists() {
            const sortFactor = isSortDesc ? 1 : -1;
            const rawList = db.items.filter(i => i.cur === currentCur).sort((a, b) => sortFactor * b.date.localeCompare(a.date));

            // é€šç”¨åˆ†çµ„æ¸²æŸ“å‡½å¼
            function renderGrouped(list, renderer) {
                if(list.length === 0) return noData();
                const grouped = {};
                list.forEach(i => { if(!grouped[i.date]) grouped[i.date]=[]; grouped[i.date].push(i); });
                
                return Object.keys(grouped).sort((a,b) => sortFactor * b.localeCompare(a)).map(date => `
                    <div class="mb-4">
                        <div class="sticky top-0 bg-slate-100/95 p-2 px-3 rounded-lg text-slate-500 font-bold text-sm backdrop-blur-sm z-10 border border-slate-200 shadow-sm inline-block mb-2">ğŸ“… ${date}</div>
                        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                            ${grouped[date].map(renderer).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // 1. å…¬å¸³æ”¶å…¥
            const inc = rawList.filter(i => i.type === 'fund');
            document.getElementById('income-list').innerHTML = renderGrouped(inc, i => 
                listRow(i, `æ¯äºº${Math.round(i.amt / (i.splitters?.length || db.members.length))}`, 'text-green-600', `+${Math.round(i.amt)}`, currentUser === db.manager)
            );

            // 2. å…¬å¸³æ”¯å‡º
            const pub = rawList.filter(i => i.type === 'public');
            document.getElementById('public-exp-list').innerHTML = renderGrouped(pub, i => 
                listRow(i, `æ¯äººåˆ†æ”¤${Math.round(i.amt / (i.splitters?.length || 1))}`, 'text-red-600', `-${Math.round(i.amt)}`, currentUser === db.manager || i.payer === currentUser)
            );

            // 3. å€‹äººä»£å¢Š - æˆ‘å…ˆå¢Šä»˜ (æˆ‘å¢Šï¼Œåˆ¥äººæ¬ æˆ‘)
            const myAdv = rawList.filter(i => i.type === 'advance' && i.payer === currentUser);
            document.getElementById('adv-my-list').innerHTML = renderGrouped(myAdv, i => {
                const perPerson = Math.round(i.amt / (i.splitters?.length || 1));
                return listRow(i, `åˆ†æ”¤: ${i.splitters.join(',')} (æ¯äºº${perPerson})`, 'text-green-600', `+${Math.round(i.amt)}`, true);
            });

            // 4. å€‹äººä»£å¢Š - åˆ¥äººä»£å¢Š (åˆ¥äººå¢Šï¼Œæˆ‘æ¬ åˆ¥äºº)
            const otherAdv = rawList.filter(i => i.type === 'advance' && i.splitters.includes(currentUser) && i.payer !== currentUser);
            document.getElementById('adv-other-list').innerHTML = renderGrouped(otherAdv, i => {
                 const perPerson = Math.round(i.amt / (i.splitters?.length || 1));
                 return listRow(i, `${i.payer}å…ˆå¢Š (æ¯äºº${perPerson})`, 'text-red-600', `ç¸½:${Math.round(i.amt)}`, false);
            });

            // 5. å€‹äººæ˜ç´°
            const pvt = rawList.filter(i => i.type === 'personal' && i.payer === currentUser);
            document.getElementById('pvt-list').innerHTML = renderGrouped(pvt, i => 
                listRow(i, `å€‹äººæ”¯ä»˜`, 'text-red-600', `-${Math.round(i.amt)}`, true)
            );
        }

        function listRow(i, sub, color, amt, canEdit) {
            const editBtn = (!db.isSealed && canEdit) ? `<div class="mt-1 flex justify-end gap-3"><button onclick="loadItemForEdit(${i.id})" class="text-xs text-blue-500 font-bold bg-blue-50 px-2 py-1 rounded">ä¿®æ”¹</button><button onclick="deleteItem(${i.id})" class="text-xs text-red-500 font-bold bg-red-50 px-2 py-1 rounded">åˆªé™¤</button></div>` : '';
            const icon = i.cat ? i.cat.split(' ')[0] : 'ğŸ’¸';
            return `<div class="p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50 transition">
                <div class="flex justify-between items-start">
                    <div class="flex gap-3">
                        <div class="text-2xl bg-slate-100 rounded-lg w-10 h-10 flex items-center justify-center">${icon}</div>
                        <div>
                            <div class="font-bold text-slate-800">${i.title}</div>
                            <div class="text-xs text-slate-400 mt-1">${sub}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="${color} font-black text-lg amt-text">${amt}</div>
                    </div>
                </div>
                ${editBtn}
            </div>`;
        }
        function noData() { return '<p class="p-4 text-slate-300 text-center text-sm font-bold">ç„¡è³‡æ–™</p>'; }

        function loadItemForEdit(id) {
            if(db.isSealed) return alert("å¸³ç°¿å·²å°å­˜");
            const item = db.items.find(i => i.id == id);
            if(!item) return;
            document.getElementById('edit-id').value = item.id;
            document.getElementById('exp-date').value = item.date;
            document.getElementById('exp-cat').value = item.cat || 'â¤ï¸ å…¶ä»–';
            document.getElementById('exp-title').value = item.title;
            
            calcVal = item.amt.toString();
            document.getElementById('exp-amt-display').value = calcVal;

            document.getElementById('exp-path').value = item.type;
            
            document.getElementById('form-header-text').innerHTML = "âœï¸ ç·¨è¼¯é …ç›®";
            document.getElementById('btn-submit').innerText = "ç¢ºèªä¿®æ”¹";
            document.getElementById('btn-submit').className = "flex-1 bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-lg";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            
            togglePayerSelection();
            if(item.type === 'advance') document.getElementById('payer-member').value = item.payer;
            
            const checks = document.querySelectorAll('input[name="splitter"]');
            checks.forEach(c => c.checked = item.splitters ? item.splitters.includes(c.value) : false);

            document.getElementById('add-panel').open = true;
            document.getElementById('add-panel').scrollIntoView({ behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('edit-id').value = "";
            document.getElementById('exp-title').value = "";
            calcVal = ""; document.getElementById('exp-amt-display').value = "";
            document.getElementById('form-header-text').innerHTML = `ğŸ“ æ–°å¢æ”¯å‡º <span class="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-1 rounded-full">${currentCur==='TWD'?'å°å¹£':db.subName}</span>`;
            document.getElementById('btn-submit').innerText = "ç¢ºèªè¨˜å¸³";
            document.getElementById('btn-submit').className = "flex-1 bg-slate-800 text-white py-4 rounded-xl font-black text-lg shadow-lg";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.querySelectorAll('input[name="splitter"]').forEach(b => b.checked = true);
        }

        function handleRecordSubmit() {
            if(db.isSealed) return alert("å¸³ç°¿å·²å°å­˜");
            const editId = document.getElementById('edit-id').value;
            const amt = getCalcResult();
            if(amt <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");
            
            if(editId) updateRecord(editId, amt); else addRecord(amt);
        }

        function addRecord(amt) {
            const date = document.getElementById('exp-date').value;
            const title = document.getElementById('exp-title').value.trim();
            const cat = document.getElementById('exp-cat').value;
            const type = document.getElementById('exp-path').value;
            if (!date || !title) return alert("è«‹å¡«å¯«æ—¥æœŸèˆ‡åç¨±");

            let splitters = [];
            if (type === 'personal') { 
                splitters = [currentUser];
            } else {
                const checkboxes = document.querySelectorAll('input[name="splitter"]:checked');
                splitters = Array.from(checkboxes).map(c => c.value);
                if (splitters.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†æ”¤æˆå“¡");
            }

            let payer = (type === 'public') ? "å…¬å¸³" : (type === 'personal' ? currentUser : document.getElementById('payer-member').value);
            if(type === 'advance' && !payer) payer = currentUser;

            db.items.push({ id: Date.now(), date, cat, title, amt, cur: currentCur, type, payer, splitters });
            refreshUI(); alert("âœ… è¨˜å¸³æˆåŠŸ"); resetForm();
        }

        function updateRecord(id, amt) {
            const idx = db.items.findIndex(i => i.id == id);
            const date = document.getElementById('exp-date').value;
            const title = document.getElementById('exp-title').value.trim();
            const cat = document.getElementById('exp-cat').value;
            const type = document.getElementById('exp-path').value;
            
            let splitters = [];
            if (type === 'personal') { 
                splitters = [currentUser];
            } else {
                const checkboxes = document.querySelectorAll('input[name="splitter"]:checked');
                splitters = Array.from(checkboxes).map(c => c.value);
            }

            let payer = (type === 'public') ? "å…¬å¸³" : (type === 'personal' ? currentUser : document.getElementById('payer-member').value);

            db.items[idx] = { ...db.items[idx], date, cat, title, amt, type, payer, splitters };
            refreshUI(); alert("âœ… ä¿®æ”¹å®Œæˆ"); resetForm();
        }

        function deleteItem(id) {
            if (db.isSealed) return alert("å¸³ç°¿å·²å°å­˜");
            if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { db.items = db.items.filter(i => i.id != id); refreshUI(); }
        }

        // --- å…¨æ–°è¨­è¨ˆçš„å€‹äººæµæ°´å¸³æ¸²æŸ“é‚è¼¯ ---
        function renderLedger() {
            const list = db.items.filter(i => i.cur === currentCur);

            // 1. å…¬å¸³åˆ†æ”¤
            const pubList = list.filter(i => {
                if (i.type === 'fund' && i.splitters.includes(currentUser)) return true; // é ç¹³ (æ”¶å…¥)
                if (i.type === 'public' && i.splitters.includes(currentUser)) return true; // åˆ†æ”¤ (æ”¯å‡º)
                return false;
            });
            renderLedgerSection('ledger-public-content', pubList, 
                // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œæ”¶å…¥ã€(æ­£é¢è³‡ç”¢ç´¯ç©)
                (i) => (i.type === 'fund'),
                // è¨ˆç®—é‡‘é¡
                (i) => Math.round(i.amt / (i.splitters?.length || 1)),
                // æ¨™é¡Œé¡¯ç¤º
                (i) => i.type === 'fund' ? 'ğŸ’° é ç¹³å…¬å¸³' : `${i.title}`
            );

            // 2. ä»£å¢Šå¾€ä¾† (æˆ‘å¹«äººå¢Š + äººå¹«æˆ‘å¢Š + æˆ‘è‡ªå·±åˆ†æ”¤)
            // é€™è£¡åŒ…å«: 
            // A. æˆ‘å¹«äººå¢Š (Income: ç¸½é¡ - æˆ‘è‡ªå·±é‚£ä»½)
            // B. äººå¹«æˆ‘å¢Š (Expense: æˆ‘é‚£ä»½)
            // C. æˆ‘å¹«è‡ªå·±å¢Š (Expense: æˆ‘é‚£ä»½) -> é›–ç„¶æˆ‘æ˜¯payerï¼Œä½†é€™ä¹Ÿæ˜¯æˆ‘çš„æ¶ˆè²»
            const advList = [];
            list.forEach(i => {
                if(i.type !== 'advance') return;
                const share = Math.round(i.amt / (i.splitters?.length || 1));
                
                if (i.payer === currentUser) {
                    // æˆ‘æ˜¯ Payer
                    const myShare = i.splitters.includes(currentUser) ? share : 0;
                    const receivable = i.amt - myShare;
                    
                    // æ”¶å…¥é¢ï¼šåˆ¥äººæ¬ æˆ‘çš„ (åªæœ‰ç•¶receivable > 0æ‰é¡¯ç¤º)
                    if (receivable > 0) {
                        advList.push({ ...i, customType: 'income', customAmt: receivable, customTitle: `å¹«å¢Š: ${i.title}` });
                    }
                    // æ”¯å‡ºé¢ï¼šæˆ‘è‡ªå·±åˆ†æ”¤çš„ (åªæœ‰ç•¶myShare > 0æ‰é¡¯ç¤º)
                    if (myShare > 0) {
                        advList.push({ ...i, customType: 'expense', customAmt: myShare, customTitle: `è‡ªä»˜: ${i.title}` });
                    }
                } else if (i.splitters.includes(currentUser)) {
                    // åˆ¥äººæ˜¯ Payerï¼Œæˆ‘æœ‰åˆ†æ”¤ -> æ”¯å‡ºé¢
                    advList.push({ ...i, customType: 'expense', customAmt: share, customTitle: `${i.payer}å¢Š: ${i.title}` });
                }
            });

            // ä½¿ç”¨ç‰¹è£½çš„æ¸²æŸ“å™¨ä¾†è™•ç†é€™å€‹å·²ç¶“æ‹†åˆ†éçš„åˆ—è¡¨
            renderLedgerSectionCustom('ledger-advance-content', advList);

            // 3. å€‹äººæ”¯ä»˜ (åƒ…æ”¯å‡º)
            const pvtList = list.filter(i => i.type === 'personal' && i.payer === currentUser);
            renderLedgerSection('ledger-personal-content', pvtList, 
                () => false, // å…¨éƒ¨è¦–ç‚ºæ”¯å‡º
                (i) => Math.round(i.amt),
                (i) => i.title
            );
        }

        // å°ˆç‚ºä»£å¢Šè¨­è¨ˆçš„æ¸²æŸ“å™¨ (å› ç‚ºå·²ç¶“é å…ˆæ‹†åˆ†æˆ Income/Expense é …ç›®)
        function renderLedgerSectionCustom(containerId, items) {
            const container = document.getElementById(containerId);
            if (items.length === 0) { container.innerHTML = '<div class="text-center text-slate-300 py-2">ç„¡è³‡æ–™</div>'; return; }
            const sortFactor = isSortDesc ? 1 : -1;
            
            const incomeItems = items.filter(i => i.customType === 'income').sort((a,b) => sortFactor * b.date.localeCompare(a.date));
            const expenseItems = items.filter(i => i.customType === 'expense').sort((a,b) => sortFactor * b.date.localeCompare(a.date));
            
            let totalInc = 0, totalExp = 0;
            
            const renderGroup = (list, isInc) => {
                if(list.length === 0) return '<div class="text-xs text-slate-400 pl-4">ç„¡è³‡æ–™</div>';
                const grouped = {};
                list.forEach(i => { if(!grouped[i.date]) grouped[i.date]=[]; grouped[i.date].push(i); });
                
                return Object.keys(grouped).sort((a,b) => sortFactor * b.localeCompare(a)).map(date => {
                    return `<div class="mb-2">
                        <div class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 inline-block rounded mb-1 border border-slate-100">${date}</div>
                        ${grouped[date].map(i => {
                            const amt = i.customAmt;
                            if(isInc) totalInc += amt; else totalExp += amt;
                            const icon = i.cat ? i.cat.split(' ')[0] : 'ğŸ”¹';
                            return `<div class="flex justify-between py-1 border-b border-slate-100 last:border-0 pl-2">
                                <div class="text-sm text-slate-600 truncate max-w-[70%]">${icon} ${i.customTitle}</div>
                                <div class="font-bold amt-text ${isInc?'text-green-600':'text-red-500'} text-sm">${isInc?'+':'-'}${amt}</div>
                            </div>`;
                        }).join('')}
                    </div>`;
                }).join('');
            };

            const incHtml = renderGroup(incomeItems, true);
            const expHtml = renderGroup(expenseItems, false);
            const total = totalInc - totalExp;

            container.innerHTML = `
                <div class="flex justify-between items-center mb-3 bg-slate-100 p-2 rounded text-sm font-bold">
                    <span>ç¸½çµé¤˜</span>
                    <span class="${total>=0?'text-blue-600':'text-red-500'} amt-text">${total>=0?'+':''}${total}</span>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <h5 class="text-xs font-bold text-green-700 mb-2 border-b border-green-100 pb-1">ğŸ“ˆ æ”¶å…¥ (æ‡‰æ”¶: ${totalInc})</h5>
                        ${incHtml}
                    </div>
                    <div>
                        <h5 class="text-xs font-bold text-red-700 mb-2 border-b border-red-100 pb-1">ğŸ“‰ æ”¯å‡º (æ‡‰ä»˜+è‡ªä»˜: ${totalExp})</h5>
                        ${expHtml}
                    </div>
                </div>
            `;
        }

        // é€šç”¨æ¸²æŸ“å™¨
        function renderLedgerSection(containerId, items, isIncomeFunc, amtFunc, titleFunc) {
            const container = document.getElementById(containerId);
            if (items.length === 0) { container.innerHTML = '<div class="text-center text-slate-300 py-2">ç„¡è³‡æ–™</div>'; return; }
            const sortFactor = isSortDesc ? 1 : -1;
            const incomeItems = items.filter(i => isIncomeFunc(i)).sort((a,b) => sortFactor * b.date.localeCompare(a.date));
            const expenseItems = items.filter(i => !isIncomeFunc(i)).sort((a,b) => sortFactor * b.date.localeCompare(a.date));
            let totalInc = 0, totalExp = 0;

            const renderGroup = (list, isInc) => {
                if(list.length === 0) return '<div class="text-xs text-slate-400 pl-4">ç„¡è³‡æ–™</div>';
                const grouped = {};
                list.forEach(i => { if(!grouped[i.date]) grouped[i.date]=[]; grouped[i.date].push(i); });
                return Object.keys(grouped).sort((a,b) => sortFactor * b.localeCompare(a)).map(date => {
                    return `<div class="mb-2">
                        <div class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 inline-block rounded mb-1 border border-slate-100">${date}</div>
                        ${grouped[date].map(i => {
                            const amt = amtFunc(i);
                            if(amt === 0) return '';
                            if(isInc) totalInc += amt; else totalExp += amt;
                            const icon = i.cat ? i.cat.split(' ')[0] : 'ğŸ”¹';
                            return `<div class="flex justify-between py-1 border-b border-slate-100 last:border-0 pl-2">
                                <div class="text-sm text-slate-600 truncate max-w-[70%]">${icon} ${titleFunc(i)}</div>
                                <div class="font-bold amt-text ${isInc?'text-green-600':'text-red-500'} text-sm">${isInc?'+':'-'}${amt}</div>
                            </div>`;
                        }).join('')}
                    </div>`;
                }).join('');
            };

            const incHtml = renderGroup(incomeItems, true);
            const expHtml = renderGroup(expenseItems, false);
            const total = totalInc - totalExp;

            container.innerHTML = `
                <div class="flex justify-between items-center mb-3 bg-slate-100 p-2 rounded text-sm font-bold">
                    <span>ç¸½çµé¤˜</span>
                    <span class="${total>=0?'text-blue-600':'text-red-500'} amt-text">${total>=0?'+':''}${total}</span>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    ${totalInc > 0 || incomeItems.length > 0 ? `<div>
                        <h5 class="text-xs font-bold text-green-700 mb-2 border-b border-green-100 pb-1">ğŸ“ˆ æ”¶å…¥ (+${totalInc})</h5>
                        ${incHtml}
                    </div>` : ''}
                    <div>
                        <h5 class="text-xs font-bold text-red-700 mb-2 border-b border-red-100 pb-1">ğŸ“‰ æ”¯å‡º (-${totalExp})</h5>
                        ${expHtml}
                    </div>
                </div>
            `;
        }

        function lRow(d, t, c, a, sub='') {
            return `<div class="flex justify-between py-2 border-b border-slate-100 items-center last:border-0">
                <div><div class="text-xs text-slate-400">${d}</div><div class="font-bold text-slate-700 text-sm">${t} <span class="text-xs font-normal text-slate-400">${sub}</span></div></div>
                <div class="${c} font-bold amt-text">${a}</div>
            </div>`;
        }

        function renderStats() {
            if(chartInstance) chartInstance.destroy();
            const list = db.items.filter(i => i.cur === currentCur);
            const cats = {}; let total = 0;
            list.forEach(i => {
                let cost = 0;
                if (i.type === 'personal' && i.payer === currentUser) cost = i.amt;
                else if ((i.type === 'public' || i.type === 'advance') && i.splitters.includes(currentUser)) {
                    cost = i.amt / i.splitters.length;
                }
                if (cost > 0) { cats[i.cat] = (cats[i.cat] || 0) + cost; total += cost; }
            });
            document.getElementById('stats-total').innerText = `${Math.round(total)}`;
            document.getElementById('stats-detail-list').innerHTML = Object.entries(cats).sort((a,b)=>b[1]-a[1]).map(([cat, val]) => `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                    <span class="font-bold text-slate-600">${cat}</span>
                    <span class="font-black text-blue-600 amt-text">${Math.round(val)}</span>
                </div>
            `).join('') || "ç„¡è³‡æ–™";

            const ctx = document.getElementById('expenseChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{ data: Object.values(cats).map(v => Math.round(v)), backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'] }]
                }, options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderSettleReport() {
            const btnClass = "flex-1 py-2 rounded text-sm font-bold transition ";
            const active = "bg-blue-600 text-white shadow";
            const inactive = "bg-slate-100 text-slate-600 hover:bg-slate-200";
            document.getElementById('btn-settle-twd').className = btnClass + (SMode==='TWD' ? active : inactive);
            document.getElementById('btn-settle-sub').className = btnClass + (SMode==='SUB' ? active : inactive);
            document.getElementById('btn-settle-mix').className = btnClass + (SMode==='MIX' ? active : inactive);

            const stats = {};
            db.members.forEach(m => stats[m] = { paid: 0, share: 0, bal: 0 });
            let potBalance = 0;

            db.items.forEach(i => {
                let val = i.amt;
                if (SMode === 'MIX' && i.cur === 'SUB') val = i.amt * db.rate;
                if (SMode === 'TWD' && i.cur !== 'TWD') return;
                if (SMode === 'SUB' && i.cur !== 'SUB') return;

                const share = val / (i.splitters.length || 1);

                if (i.type === 'fund') {
                    potBalance += val;
                    if(i.payer === 'å…¨å“¡') {
                        i.splitters.forEach(m => { if(stats[m]) stats[m].paid += share; });
                    } else if(stats[i.payer]) {
                        stats[i.payer].paid += val;
                    }
                }
                else if (i.type === 'public') {
                    potBalance -= val;
                    i.splitters.forEach(m => { if(stats[m]) stats[m].share += share; });
                }
                else if (i.type === 'advance') {
                    if(stats[i.payer]) stats[i.payer].paid += val;
                    i.splitters.forEach(m => { if(stats[m]) stats[m].share += share; });
                }
            });

            let potStatusHTML = "";
            if (potBalance < 0) {
                if (db.manager && stats[db.manager]) {
                    const deficit = Math.abs(potBalance);
                    stats[db.manager].paid += deficit; 
                    potStatusHTML = `<div class="bg-orange-50 p-3 rounded-lg text-sm text-orange-700 mb-4 border border-orange-200">âš ï¸ å…¬å¸³é€æ”¯ <span class="font-bold">${Math.round(deficit)}</span> å·²ä½µå…¥ç®¡ç†å“¡çš„ã€Œé ç¹³/ä»£å¢Šã€è¨ˆç®—</div>`;
                    potBalance = 0;
                }
            } else if (potBalance > 0) {
                potStatusHTML = `<div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-700 mb-4 border border-blue-200">ğŸ’° å…¬å¸³å‰©é¤˜ <span class="font-bold">${Math.round(potBalance)}</span> (è¦–ç‚ºç®¡ç†å“¡è² å‚µï¼Œåˆ—å…¥åˆ†å¸³)</div>`;
            } else {
                potStatusHTML = `<div class="bg-slate-50 p-3 rounded-lg text-sm text-slate-500 mb-4 border border-slate-200">âœ… å…¬å¸³æ”¶æ”¯å¹³è¡¡</div>`;
            }
            document.getElementById('pot-status-area').innerHTML = potStatusHTML;

            Object.keys(stats).forEach(m => { stats[m].bal = stats[m].paid - stats[m].share; });

            let tableHtml = `<table class="w-full text-sm text-center border-collapse rounded-lg overflow-hidden shadow-sm">
                <thead class="bg-slate-800 text-white"><tr>
                    <th class="p-3">æˆå“¡</th>
                    <th class="p-3">é ç¹³/ä»£å¢Š</th>
                    <th class="p-3">æ‡‰ä»˜/æ¶ˆè²»</th>
                    <th class="p-3">å¸³é¢çµé¤˜</th>
                </tr></thead><tbody>`;
            
            db.members.forEach(m => {
                const s = stats[m];
                tableHtml += `<tr class="border-b bg-white last:border-0 hover:bg-slate-50">
                    <td class="p-3 font-bold text-slate-800">${m}</td>
                    <td class="p-3 text-green-600 font-bold amt-text">${Math.round(s.paid)}</td>
                    <td class="p-3 text-red-600 font-bold amt-text">${Math.round(s.share)}</td>
                    <td class="p-3 font-black amt-text ${s.bal>=0?'text-blue-600':'text-red-500'}">${s.bal>=0?'+':''}${Math.round(s.bal)}</td>
                </tr>`;
            });
            tableHtml += `</tbody></table>`;
            document.getElementById('settle-table-area').innerHTML = tableHtml;

            const finalBalances = {};
            db.members.forEach(m => finalBalances[m] = stats[m].bal);

            if (db.manager && finalBalances[db.manager] !== undefined && potBalance > 0) {
                finalBalances[db.manager] -= potBalance;
            }

            let receivers = [];
            let payers = [];
            for (const [m, bal] of Object.entries(finalBalances)) {
                if (bal > 0.5) receivers.push({ name: m, bal: bal });
                else if (bal < -0.5) payers.push({ name: m, bal: Math.abs(bal) });
            }
            receivers.sort((a,b) => b.bal - a.bal);
            payers.sort((a,b) => b.bal - a.bal);

            let logs = [];
            payers.forEach(p => { 
                receivers.forEach(r => {
                    if (p.bal <= 0.1 || r.bal <= 0.1) return;
                    let amt = Math.min(p.bal, r.bal);
                    logs.push(`<b>${p.name}</b> â¡ï¸ <b>${r.name}</b>ï¼š${Math.round(amt)}`);
                    p.bal -= amt; r.bal -= amt;
                });
            });

            document.getElementById('settle-transfer-area').innerHTML = `
                <h4 class="font-bold text-slate-700 mb-3 text-lg">ğŸ’¸ å»ºè­°è½‰å¸³ (å·²çµæ¸…æ‰€æœ‰å¸³ç›®)</h4>
                <div class="space-y-2 text-sm">
                    ${logs.length ? logs.map(l=>`<div class="bg-white p-4 border rounded-xl shadow-sm border-l-4 border-blue-500 flex items-center gap-2 text-base">${l}</div>`).join('') : '<div class="text-center text-slate-400 font-bold py-4">ğŸ‰ å¸³ç›®å·²å¹³ï¼Œç„¡éœ€è½‰å¸³</div>'}
                </div>`;
        }

        function switchSettleMode(m) { SMode = m; refreshUI(false); }
        function switchCurrency(c) { 
            currentCur = c; 
            document.getElementById('cur-badge').innerText = c==='TWD'?'å°å¹£':db.subName;
            resetForm();
            refreshUI(false); 
            document.getElementById('btn-twd').className = `flex-1 lg:flex-none px-6 py-3 rounded-xl font-bold border-2 transition-all ${c==='TWD'?'currency-active':'bg-white text-slate-400'}`;
            document.getElementById('btn-sub').className = `flex-1 lg:flex-none px-6 py-3 rounded-xl font-bold border-2 transition-all ${c==='SUB'?'currency-active':'bg-white text-slate-400'}`;
        }
        function togglePayerSelection() {
            const p = document.getElementById('exp-path').value;
            document.getElementById('payer-select-div').classList.toggle('hidden', p !== 'advance');
            document.getElementById('splitters-block').classList.toggle('hidden', p === 'personal');
        }
        function downloadData() {
            const blob = new Blob([JSON.stringify(db, null, 2)], {type : 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `TripSplit_${db.id}.json`; a.click();
        }
        function renderUserSelect() {
            const s = document.getElementById('user-select'); s.innerHTML = db.members.map(m=>`<option value="${m}">${m}</option>`).join('');
            s.onchange = () => document.getElementById('admin-pass-input-box').classList.toggle('hidden', s.value !== db.manager);
            s.onchange();
        }
        function addFundRecord() {
            if(db.isSealed) return alert("å¸³ç°¿å·²å°å­˜");
            const p = parseFloat(document.getElementById('fund-amt').value); if(!p)return; 
            db.items.push({id:Date.now(), date:document.getElementById('fund-date').value, cat:"ğŸ’°", title:"å…¨å“¡å…¬å¸³é ç¹³", amt:p*db.members.length, cur:currentCur, type:'fund', payer:"å…¨å“¡", splitters:[...db.members]}); refreshUI(); alert("å…¥å¸³æˆåŠŸ");
        }
        function updateSubNameBySelect(val) {
            if(!val) return;
            document.getElementById('set-sub-name').value = val;
            const rates = { 'JPY': 0.22, 'USD': 31.5, 'EUR': 34.5, 'KRW': 0.024, 'CNY': 4.4, 'THB': 0.9 };
            if(rates[val]) document.getElementById('set-rate').value = rates[val];
        }
        function updateSettings() {
            if(db.isSealed) return alert("å¸³ç°¿å·²å°å­˜");
            db.members = document.getElementById('set-members').value.split(/[,ï¼Œ]/).map(m=>m.trim()).filter(m=>m);
            db.subName = document.getElementById('set-sub-name').value;
            db.rate = parseFloat(document.getElementById('set-rate').value);
            db.manager = document.getElementById('set-manager').value;
            db.pass = document.getElementById('set-book-pass').value;
            db.adminPass = document.getElementById('set-admin-pass').value;
            save(); alert("è¨­å®šå·²æ›´æ–°"); location.reload();
        }
        function toggleSeal() {
            if(confirm(`ç¢ºå®šè¦${db.isSealed?'è§£é™¤å°å­˜':'å°å­˜å¸³ç°¿'}å—ï¼Ÿ`)) { db.isSealed = !db.isSealed; save(); refreshUI(); alert(db.isSealed?"å¸³ç°¿å·²å°å­˜":"å¸³ç°¿å·²è§£å°"); }
        }
        function deleteAllData() { if(db.isSealed)return alert("å°å­˜ä¸­"); if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { db.items = []; save(); refreshUI(); } }
        function logout() { localStorage.removeItem('trip_auto_pass'); location.reload(); }
    </script>
</body>
</html>
